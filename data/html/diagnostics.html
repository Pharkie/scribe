<!DOCTYPE html>
<html lang="en" class="app-root">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Scribe Evolution - Diagnostics</title>
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <link rel="stylesheet" href="/css/diagnostics.min.css">
    <script src="/js/page-diagnostics.min.js"></script>
    <script src="/js/vendor.min.js" defer></script>
</head>

<body class="page-body" x-data="initializeDiagnosticsStore()" x-init="init()">
    <main class="page-main">
        <header class="page-header">
            <div class="header-spacer">
                <button @click="goBack()" class="back-button">
                    <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7">
                        </path>
                    </svg>
                    <span class="text-xs sm:text-sm font-medium">Back</span>
                </button>
            </div>
            <div class="header-center">
                <h1 class="page-title">
                    <span class="text-4xl sm:text-5xl">üõ†Ô∏è</span>
                    <span>Diagnostics</span>
                </h1>
            </div>
            <div class="header-spacer"></div>
        </header>

        <!-- Error State -->
        <div x-show="error" x-transition.opacity.duration.300ms class="text-center text-red-600 dark:text-red-400 mb-6">
            <span class="text-2xl mb-4 block">‚ùå</span>
            <h3 class="text-lg font-semibold mb-2">Error Loading Diagnostics</h3>
            <p class="text-red-600 dark:text-red-400 mb-4" x-text="error"></p>
            <button @click="loadDiagnostics()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                Retry
            </button>
        </div>

        <!-- Main Content - use x-if to prevent evaluation when loading -->
        <template x-if="!loading && !error">
            <div x-transition.opacity.duration.300ms>
            <!-- Navigation -->
            <nav class="flex flex-wrap justify-center gap-2 mb-6">
                <template x-for="section in sections" :key="section.id">
                    <button @click="showSection(section.id)" :class="getSectionClass(section.id)"
                        x-text="`${section.icon} ${section.name}`">
                    </button>
                </template>
            </nav>

            <!-- Diagnostics Content -->
            <div class="space-y-6">

                <!-- Microcontroller Section -->
                <div x-show="currentSection === 'microcontroller-section'" class="diag-section orange">
                    <div class="diag-header">
                        <h4 class="diag-title orange"><span class="mr-2">üéõÔ∏è</span>Microcontroller</h4>
                        <button @click="copyGenericSection('Microcontroller')" class="diag-copy-btn orange">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z" />
                            </svg>
                        </button>
                    </div>
                    <div class="space-y-2">
                        <div class="diag-row">
                            <span class="diag-label">Chip Model:</span>
                            <span class="diag-value" x-text="microcontrollerInfo.chipModel"></span>
                        </div>
                        <div class="diag-row">
                            <span class="diag-label">CPU Frequency:</span>
                            <span class="diag-value" x-text="microcontrollerInfo.cpuFrequency"></span>
                        </div>
                        <div class="diag-row">
                            <span class="diag-label">Flash Size:</span>
                            <span class="diag-value" x-text="microcontrollerInfo.flashSize"></span>
                        </div>
                        <div class="diag-row">
                            <span class="diag-label">Firmware Version:</span>
                            <span class="diag-value" x-text="microcontrollerInfo.firmwareVersion"></span>
                        </div>
                        <div class="diag-row">
                            <span class="diag-label">Uptime:</span>
                            <span class="diag-value" x-text="microcontrollerInfo.uptime"></span>
                        </div>
                        <div class="diag-row">
                            <span class="diag-label">Temperature:</span>
                            <span class="diag-value" x-text="microcontrollerInfo.temperature"></span>
                        </div>

                        <!-- Memory Usage -->
                        <div class="diag-row">
                            <span class="diag-label">Flash Usage:</span>
                            <span class="diag-value" x-text="memoryUsage.flashUsageText"></span>
                        </div>
                        <div class="diag-progress-bar">
                            <div :class="getProgressBarClass(memoryUsage.flashUsagePercent)"
                                class="h-full rounded-full transition-all duration-500 ease-out"
                                :style="!loading && !error && currentSection === 'microcontroller-section' ? `width: ${Math.min(Math.max(memoryUsage.flashUsagePercent, 0), 100)}%` : 'width: 0%'">
                            </div>
                        </div>

                        <div class="diag-row">
                            <span class="diag-label">Heap Usage:</span>
                            <span class="diag-value" x-text="memoryUsage.heapUsageText"></span>
                        </div>
                        <div class="diag-progress-bar">
                            <div :class="getProgressBarClass(memoryUsage.heapUsagePercent)"
                                class="h-full rounded-full transition-all duration-500 ease-out"
                                :style="!loading && !error && currentSection === 'microcontroller-section' ? `width: ${Math.min(Math.max(memoryUsage.heapUsagePercent, 0), 100)}%` : 'width: 0%'">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Logging Section -->
                <div x-show="currentSection === 'logging-section'" class="diag-section indigo">
                    <div class="diag-header">
                        <h4 class="diag-title indigo"><span class="mr-2">üìã</span>Logging</h4>
                        <button @click="copyGenericSection('Logging')" class="diag-copy-btn indigo">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z" />
                            </svg>
                        </button>
                    </div>
                    <div class="space-y-2">
                        <div class="diag-row">
                            <span class="diag-label">Log Level:</span>
                            <span class="diag-value" x-text="loggingInfo.level"></span>
                        </div>
                        <div class="diag-row">
                            <span class="diag-label">Serial Logging:</span>
                            <span class="diag-value" x-text="loggingInfo.serialLogging"></span>
                        </div>
                        <div class="diag-row">
                            <span class="diag-label">Web Logging:</span>
                            <span class="diag-value" x-text="loggingInfo.webLogging"></span>
                        </div>
                        <div class="diag-row">
                            <span class="diag-label">File Logging:</span>
                            <span class="diag-value" x-text="loggingInfo.fileLogging"></span>
                        </div>
                        <div class="diag-row">
                            <span class="diag-label">MQTT Logging:</span>
                            <span class="diag-value" x-text="loggingInfo.mqttLogging"></span>
                        </div>
                    </div>
                </div>

                <!-- Pages & Endpoints Section -->
                <div x-show="currentSection === 'pages-endpoints-section'" class="diag-section teal">
                    <div class="diag-header">
                        <h4 class="diag-title teal"><span class="mr-2">üîó</span>Pages & Endpoints</h4>
                        <button @click="copyGenericSection('Pages & Endpoints')" class="diag-copy-btn teal">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z" />
                            </svg>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <!-- Routes -->
                        <div>
                            <h5 class="font-medium text-gray-900 dark:text-gray-100 mb-2">Routes</h5>
                            <div class="space-y-1">
                                <template x-for="route in sortedRoutes" :key="route.path">
                                    <div class="diag-row">
                                        <!-- Route path - make HTML pages clickable -->
                                        <span class="diag-label">
                                            <template x-if="route.isHtmlPage">
                                                <a :href="route.linkPath"
                                                    class="text-teal-600 dark:text-teal-400 hover:underline"
                                                    x-text="route.path"></a>
                                            </template>
                                            <template x-if="route.isUnmatched">
                                                <a :href="route.linkPath"
                                                    class="text-teal-600 dark:text-teal-400 hover:underline"
                                                    x-text="route.path"></a>
                                            </template>
                                            <template x-if="!route.isHtmlPage && !route.isUnmatched">
                                                <span x-text="route.path"></span>
                                            </template>
                                        </span>
                                        <span class="diag-value" x-text="route.description"></span>
                                    </div>
                                </template>
                                <div x-show="sortedRoutes.length === 0" class="diag-row">
                                    <span class="diag-label">Loading routes...</span>
                                    <span class="diag-value">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- API Endpoints -->
                        <div>
                            <h5 class="font-medium text-gray-900 dark:text-gray-100 mb-3">API Endpoints</h5>
                            <div class="space-y-3">
                                <template x-for="(endpoints, method) in apiEndpoints" :key="method">
                                    <div class="border-l-2 border-teal-300 dark:border-teal-600 pl-3">
                                        <h6 class="font-semibold text-sm text-teal-700 dark:text-teal-300 mb-2 uppercase tracking-wide"
                                            x-text="`${method} (${endpoints.length})`"></h6>
                                        <div class="space-y-1">
                                            <template x-for="endpoint in endpoints" :key="endpoint.path">
                                                <div class="diag-row text-sm">
                                                    <span class="diag-label font-mono" x-text="endpoint.path"></span>
                                                    <span class="diag-value" x-text="endpoint.description"></span>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                                <div x-show="Object.keys(apiEndpoints).length === 0" class="diag-row">
                                    <span class="diag-label">Loading API endpoints...</span>
                                    <span class="diag-value">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Runtime Configuration Section -->
                <div x-show="currentSection === 'config-file-section'" class="diag-section red">
                    <div class="diag-header">
                        <h4 class="diag-title red"><span class="mr-2">‚öôÔ∏è</span>Runtime Configuration</h4>
                        <button @click="copyConfigFile()" class="diag-copy-btn red">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z" />
                            </svg>
                        </button>
                    </div>
                    <div class="space-y-3">
                        <pre class="diag-json-content" x-text="configFileFormatted"></pre>
                        <p class="diag-config-warning red">üîë Secrets are redacted</p>
                    </div>
                </div>

                <!-- NVS Storage Section -->
                <div x-show="currentSection === 'nvs-storage-section'" class="diag-section cyan">
                    <div class="diag-header">
                        <div>
                            <h4 class="diag-title cyan"><span class="mr-2">üíæ</span>NVS Storage</h4>
                            <p class="text-sm text-cyan-600 dark:text-cyan-400 mt-1">NVS key-value pairs from
                                "scribe-app" namespace</p>
                        </div>
                        <button @click="copyNVSData()" class="diag-copy-btn cyan">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z" />
                            </svg>
                        </button>
                    </div>
                    <div class="space-y-3">
                        <pre class="diag-json-content" x-text="nvsDataFormatted"></pre>
                        <p class="diag-config-warning cyan">üîë Secrets are redacted</p>
                    </div>
                </div>

            </div>
            </div>
        </template>
    </main>

    <footer class="page-footer vertical-stack">
        <a href="/" class="link-button">
            üè† Home
        </a>
        <div>
            Scribe Evolution was invented with love by <a href="https://urbancircles.club" target="_blank"
                class="footer-link">Peter
                / Urban Circles</a>
        </div>
        <div>
            Extended and upgraded with joy by <a href="https://github.com/Pharkie/scribe" target="_blank"
                class="footer-link">Pharkie</a>
        </div>
        <div>
            Quotes from <a href="https://zenquotes.io/" target="_blank" class="footer-link">ZenQuotes
                API</a>
        </div>
    </footer>
</body>

</html>