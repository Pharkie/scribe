function handleFetchResponse(e){return e.ok?e.json():e.json().then(t=>{const n=t.error||t.message||`HTTP ${e.status}: ${e.statusText}`;throw new Error(n)}).catch(t=>{throw new Error(`HTTP ${e.status}: ${e.statusText}`)})}function fetchJSON(e,t){return fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(handleFetchResponse)}function sendTwoStepAction(e,t,n){return triggerConfetti(),fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({target:t})}).then(handleFetchResponse).then(e=>{if(!e.content)throw new Error("No content received from server");let n,o;return"local-direct"===t?(n="/api/print-local",o={message:e.content}):"local-mqtt"===t?(n="/api/mqtt-send",o={topic:"scribe/Pharkie/inbox",message:e.content}):(n="/api/mqtt-send",o={topic:t,message:e.content}),fetchJSON(n,o)}).then(e=>{if(!e.success&&"success"!==e.status)throw new Error(e.error||e.message||"Unknown error occurred");showSuccessToast(`${n.name} scribed`)}).catch(e=>{console.error(`Failed to send ${n.name.toLowerCase()}:`,e),alert(`Your Scribe stumbled on that ${n.name.toLowerCase()}. Want to try again?\n\nWhat happened: ${e.message}`)})}let MAX_CHARS,MAX_PROMPT_CHARS;window.GLOBAL_CONFIG={};let PRINTERS=[],lastETag=null;const DEFAULT_MOTIVATION_PROMPT="Generate a short, encouraging motivational message to help me stay focused and positive. Keep it brief, uplifting, and practical.";async function loadConfig(){try{const e=await fetch("/api/config"),t=await e.json();window.GLOBAL_CONFIG=t,MAX_CHARS=t.validation?.maxCharacters||1e3,MAX_PROMPT_CHARS=500,PRINTERS=[],"function"==typeof initializeConfigDependentUI&&initializeConfigDependentUI();const n=document.getElementById("message-textarea"),o=document.getElementById("char-counter");n&&o&&updateCharacterCount("message-textarea","char-counter",MAX_CHARS);const r=document.getElementById("custom-prompt"),s=document.getElementById("prompt-char-count");r&&s&&updateCharacterCount("custom-prompt","prompt-char-count",MAX_PROMPT_CHARS),window.dispatchEvent(new CustomEvent("configLoaded",{detail:t}))}catch(e){console.error("Failed to load config:",e)}}function initializePrinterDiscovery(){console.log("🔌 Initializing real-time printer discovery (SSE)");let e=null;!function(){if(console.log("📊 Setting up initial printer data from loaded config..."),window.GLOBAL_CONFIG&&window.GLOBAL_CONFIG.printer){const e={printer_id:"local",name:window.GLOBAL_CONFIG.printer.name,type:window.GLOBAL_CONFIG.printer.type,topic:window.GLOBAL_CONFIG.printer.topic,status:"online"};PRINTERS.length=0,PRINTERS.push(e),refreshPrinterUI(),console.log("✅ Initial printer data set up from config")}else console.log("⚠️ No local printer config found")}(),function t(){e&&e.close(),e=new EventSource("/events"),e.addEventListener("printer-update",function(e){try{console.log("🖨️ Real-time printer update received");updatePrintersFromData(JSON.parse(e.data)),refreshPrinterUI()}catch(e){console.error("Error parsing printer update:",e)}}),e.addEventListener("system-status",function(e){try{const t=JSON.parse(e.data);console.log(`📡 System status: ${t.status} - ${t.message}`),showSystemNotification(t.status,t.message)}catch(e){console.error("Error parsing system status:",e)}}),e.onerror=function(e){console.error("SSE connection error:",e),setTimeout(()=>{console.log("🔄 Attempting to reconnect SSE..."),t()},5e3)},e.onopen=function(e){console.log("✅ Real-time updates connected")}}(),window.addEventListener("beforeunload",function(){e&&e.close()})}function updatePrintersFromData(e){e&&e.discovered_printers&&(PRINTERS.length=0,PRINTERS.push(...e.discovered_printers))}function refreshPrinterUI(){"function"==typeof populatePrinterDropdown&&populatePrinterDropdown();const e=new CustomEvent("printersUpdated",{detail:{printers:PRINTERS}});document.dispatchEvent(e)}function showSystemNotification(e,t){if(!["connected","error","reconnecting"].includes(e))return;const n=document.createElement("div");switch(n.className=`notification notification-${e}`,n.style.cssText="\n    position: fixed;\n    top: 20px;\n    right: 20px;\n    padding: 10px 15px;\n    border-radius: 4px;\n    color: white;\n    font-size: 14px;\n    z-index: 10000;\n    opacity: 0;\n    transition: opacity 0.3s ease;\n  ",e){case"connected":n.style.backgroundColor="#10b981";break;case"error":n.style.backgroundColor="#ef4444";break;case"reconnecting":n.style.backgroundColor="#f59e0b"}n.textContent=t,document.body.appendChild(n),requestAnimationFrame(()=>{n.style.opacity="1"}),setTimeout(()=>{n.style.opacity="0",setTimeout(()=>{n.parentNode&&n.parentNode.removeChild(n)},300)},3e3)}function handleKeyPress(e){if((e.ctrlKey||e.metaKey)&&"Enter"===e.key){e.preventDefault();const t=document.querySelector("form");t&&t.dispatchEvent(new Event("submit"))}if("Escape"===e.key){closeDiagnostics();const e=document.getElementById("settings-panel");e&&!e.classList.contains("hidden")&&toggleSettings()}}function handleTextareaKeydown(e){if("Enter"===e.key&&!e.shiftKey){e.preventDefault();const t=document.getElementById("printer-form");if(t){const e=new Event("submit",{bubbles:!1,cancelable:!0});Object.defineProperty(e,"target",{value:t,enumerable:!0}),handleSubmit(e)}}}function initializeSharedUI(){document.querySelectorAll(".loading").forEach(e=>e.classList.add("hidden")),initializeTooltips(),checkStartupMessages()}function initializeTooltips(){document.querySelectorAll(".info-icon").forEach(e=>{e.addEventListener("mouseenter",function(){})})}function checkStartupMessages(){const e=new URLSearchParams(window.location.search),t=e.get("message"),n=e.get("type");t&&("success"===n?showSuccessMessage(decodeURIComponent(t)):"error"===n&&showErrorMessage(decodeURIComponent(t)),window.history.replaceState({},document.title,window.location.pathname))}function showErrorMessage(e){const t=document.getElementById("message-container")||document.body,n=document.createElement("div");n.className="fixed top-4 right-4 bg-red-500 dark:bg-red-600 text-white px-4 py-2 rounded-lg shadow-lg dark:shadow-2xl z-50",n.textContent=e,t.appendChild(n),setTimeout(()=>{n.parentNode&&n.parentNode.removeChild(n)},5e3)}function showSuccessMessage(e){const t=document.getElementById("message-container")||document.body,n=document.createElement("div");n.className="fixed top-4 right-4 bg-green-500 dark:bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg dark:shadow-2xl z-50",n.textContent=e,t.appendChild(n),setTimeout(()=>{n.parentNode&&n.parentNode.removeChild(n)},3e3)}function goBack(){window.history.length>1&&document.referrer?window.history.back():window.location.href="/"}function handleSubmit(e){e.preventDefault();const t=new FormData(e.target),n=t.get("printer-target"),o=t.get("message");o.trim()?o.length>MAX_CHARS?alert(`Your message is a bit too chatty for your Scribe. Keep it under ${MAX_CHARS} characters (currently ${o.length} characters)`):sendUserMessage(n,o):alert("Your Scribe is waiting for something to write about")}function sendUserMessage(e,t){const n=getActionConfig("user-message");triggerConfetti(),fetch("/api/user-message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:t,target:e})}).then(e=>{if(e.ok)return e.json();throw new Error(`HTTP ${e.status}: ${e.statusText}`)}).then(t=>{if(!t.content)throw new Error("No content received from server");let n,o;return"local-direct"===e?(n="/api/print-local",o={message:t.content}):(n="/api/mqtt-send",o={topic:e,message:t.content}),fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})}).then(e=>e.ok?e.json():e.json().then(t=>{const n=t.error||t.message||`HTTP ${e.status}: ${e.statusText}`;throw new Error(n)}).catch(t=>{throw new Error(`HTTP ${e.status}: ${e.statusText}`)})).then(e=>{if(!e.success&&"success"!==e.status)throw new Error(e.error||e.message||"Unknown error occurred");{const e=document.getElementById("message-textarea")||document.querySelector('textarea[name="message"]');e&&(e.value="",updateCharacterCount("message-textarea","char-counter",MAX_CHARS)),showSuccessToast(`${n.name} scribed`)}}).catch(e=>{console.error(`Failed to send ${n.name.toLowerCase()}:`,e),alert(`Your Scribe had trouble with that ${n.name.toLowerCase()}. Mind giving it another try?\n\nWhat went wrong: ${e.message}`)})}function getActionConfig(e){switch(e){case"riddle":return{colors:["#f59e0b","#d97706","#fbbf24"],name:"Riddle"};case"joke":return{colors:["#10b981","#059669","#34d399"],name:"Joke"};case"quote":return{colors:["#8b5cf6","#7c3aed","#a78bfa"],name:"Quote"};case"quiz":return{colors:["#f59e0b","#d97706","#fbbf24"],name:"Quiz"};case"poke":return{colors:["#ec4899","#be185d","#f472b6"],name:"Poke"};case"print-test":return{colors:["#6b7280","#4b5563","#9ca3af"],name:"Print Test"};case"user-message":return{colors:["#3b82f6","#1d4ed8","#60a5fa"],name:"Message"};case"scribe-message":return{colors:["#8b5cf6","#7c3aed","#a78bfa"],name:"Message"};default:return{colors:["#6b7280","#4b5563","#9ca3af"],name:"Unknown"}}}function sendQuickAction(e){const t=document.getElementById("printer-target").value;let n;switch(e){case"riddle":n="/api/riddle";break;case"joke":n="/api/joke";break;case"quote":n="/api/quote";break;case"quiz":n="/api/quiz";break;case"poke":n="/api/poke";break;case"print-test":n="/api/print-test";break;default:return console.error("Unknown action:",e),void alert("Your Scribe is confused by this action: "+e)}const o=getActionConfig(e);triggerConfetti(),fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({target:t})}).then(e=>{if(e.ok)return e.json();throw new Error(`HTTP ${e.status}: ${e.statusText}`)}).then(e=>{if(!e.content)throw new Error("No content received from server");let n,o;return"local-direct"===t?(n="/api/print-local",o={message:e.content}):"local-mqtt"===t?(n="/api/mqtt-send",o={topic:"scribe/Pharkie/inbox",message:e.content}):(n="/api/mqtt-send",o={topic:t,message:e.content}),fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})}).then(e=>e.ok?e.json():e.json().then(t=>{const n=t.error||t.message||`HTTP ${e.status}: ${e.statusText}`;throw new Error(n)}).catch(t=>{throw new Error(`HTTP ${e.status}: ${e.statusText}`)})).then(e=>{if(!e.success&&"success"!==e.status)throw new Error(e.error||e.message||"Unknown error occurred");showSuccessToast(`${o.name} scribed`)}).catch(e=>{console.error(`Failed to send ${o.name.toLowerCase()}:`,e),alert(`Your Scribe stumbled on that ${o.name.toLowerCase()}. Want to try again?\n\nWhat happened: ${e.message}`)})}function triggerConfetti(){if("undefined"!=typeof confetti){const e=document.documentElement.classList.contains("dark")||window.matchMedia("(prefers-color-scheme: dark)").matches;confetti({particleCount:100,spread:70,origin:{y:.6},colors:e?["#fbbf24","#34d399","#a78bfa","#f472b6","#fb7185"]:["#3b82f6","#ef4444","#10b981","#f59e0b","#8b5cf6"]})}}function showSuccessToast(e){const t=document.createElement("div");t.className="fixed top-4 right-4 bg-green-500 dark:bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg dark:shadow-2xl z-50 transform translate-x-full transition-transform duration-300",t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.classList.remove("translate-x-full")},10),setTimeout(()=>{t.classList.add("translate-x-full"),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300)},3e3)}document.addEventListener("DOMContentLoaded",function(){loadConfig(),document.addEventListener("keydown",handleKeyPress),initializeSharedUI()});