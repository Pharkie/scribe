let MAX_CHARS,MAX_PROMPT_CHARS;window.GLOBAL_CONFIG={};let PRINTERS=[];const DEFAULT_MOTIVATION_PROMPT="Generate a short, encouraging motivational message to help me stay focused and positive. Keep it brief, uplifting, and practical.";async function loadConfig(){try{const e=await fetch("/config"),t=await e.json();window.GLOBAL_CONFIG=t,MAX_CHARS=t.validation?.maxCharacters||1e3,MAX_PROMPT_CHARS=500,PRINTERS=[],t.printers?.remote&&(PRINTERS=t.printers.remote),"function"==typeof initializeConfigDependentUI&&initializeConfigDependentUI();const n=document.getElementById("message-textarea"),o=document.getElementById("char-counter");n&&o&&updateCharacterCount("message-textarea","char-counter",MAX_CHARS);const a=document.getElementById("custom-prompt"),r=document.getElementById("prompt-char-count");a&&r&&updateCharacterCount("custom-prompt","prompt-char-count",MAX_PROMPT_CHARS),window.dispatchEvent(new CustomEvent("configLoaded",{detail:t}))}catch(e){console.error("Failed to load config:",e)}}function handleKeyPress(e){if((e.ctrlKey||e.metaKey)&&"Enter"===e.key){e.preventDefault();const t=document.querySelector("form");t&&t.dispatchEvent(new Event("submit"))}if("Escape"===e.key){closeDiagnostics();const e=document.getElementById("settings-panel");e&&!e.classList.contains("hidden")&&toggleSettings()}}function handleTextareaKeydown(e){if("Enter"===e.key&&!e.shiftKey){e.preventDefault();const t=document.getElementById("printer-form");if(t){const e=new Event("submit",{bubbles:!1,cancelable:!0});Object.defineProperty(e,"target",{value:t,enumerable:!0}),handleSubmit(e)}}}function initializeSharedUI(){document.querySelectorAll(".loading").forEach(e=>e.classList.add("hidden")),initializeTooltips(),checkStartupMessages()}function initializeTooltips(){document.querySelectorAll(".info-icon").forEach(e=>{e.addEventListener("mouseenter",function(){})})}function checkStartupMessages(){const e=new URLSearchParams(window.location.search),t=e.get("message"),n=e.get("type");t&&("success"===n?showSuccessMessage(decodeURIComponent(t)):"error"===n&&showErrorMessage(decodeURIComponent(t)),window.history.replaceState({},document.title,window.location.pathname))}function showErrorMessage(e){const t=document.getElementById("message-container")||document.body,n=document.createElement("div");n.className="fixed top-4 right-4 bg-red-500 dark:bg-red-600 text-white px-4 py-2 rounded-lg shadow-lg dark:shadow-2xl z-50",n.textContent=e,t.appendChild(n),setTimeout(()=>{n.parentNode&&n.parentNode.removeChild(n)},5e3)}function showSuccessMessage(e){const t=document.getElementById("message-container")||document.body,n=document.createElement("div");n.className="fixed top-4 right-4 bg-green-500 dark:bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg dark:shadow-2xl z-50",n.textContent=e,t.appendChild(n),setTimeout(()=>{n.parentNode&&n.parentNode.removeChild(n)},3e3)}function handleSubmit(e){e.preventDefault();const t=new FormData(e.target),n=t.get("printer-target"),o=t.get("message");o.trim()?o.length>MAX_CHARS?alert(`Message is too long. Maximum ${MAX_CHARS} characters allowed, but your message is ${o.length} characters.`):sendUserMessage(n,o):alert("Please enter a message")}function sendUserMessage(e,t){const n=getActionConfig("user-message");triggerConfetti(),fetch("/user-message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:t,target:e})}).then(e=>{if(e.ok)return e.json();throw new Error(`HTTP ${e.status}: ${e.statusText}`)}).then(t=>{if(!t.content)throw new Error("No content received from server");let n,o;return"local-direct"===e?(n="/print-local",o={message:t.content}):(n="/mqtt-send",o={topic:e,message:t.content}),fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})}).then(e=>e.ok?e.json():e.json().then(t=>{const n=t.error||t.message||`HTTP ${e.status}: ${e.statusText}`;throw new Error(n)}).catch(t=>{throw new Error(`HTTP ${e.status}: ${e.statusText}`)})).then(e=>{if(!e.success&&"success"!==e.status)throw new Error(e.error||e.message||"Unknown error occurred");{const e=document.getElementById("message-textarea")||document.querySelector('textarea[name="message"]');e&&(e.value="",updateCharacterCount("message-textarea","char-counter",MAX_CHARS)),showSuccessToast(`${n.name} scribed`)}}).catch(e=>{console.error(`Failed to send ${n.name.toLowerCase()}:`,e),alert(`Failed to send ${n.name.toLowerCase()}. Please try again.\n\nError: ${e.message}`)})}function getActionConfig(e){switch(e){case"riddle":return{colors:["#f59e0b","#d97706","#fbbf24"],name:"Riddle"};case"joke":return{colors:["#10b981","#059669","#34d399"],name:"Joke"};case"quote":return{colors:["#8b5cf6","#7c3aed","#a78bfa"],name:"Quote"};case"quiz":return{colors:["#f59e0b","#d97706","#fbbf24"],name:"Quiz"};case"poke":return{colors:["#ec4899","#be185d","#f472b6"],name:"Poke"};case"print-test":return{colors:["#6b7280","#4b5563","#9ca3af"],name:"Print Test"};case"user-message":return{colors:["#3b82f6","#1d4ed8","#60a5fa"],name:"Message"};case"scribe-message":return{colors:["#8b5cf6","#7c3aed","#a78bfa"],name:"Message"};default:return{colors:["#6b7280","#4b5563","#9ca3af"],name:"Unknown"}}}function sendQuickAction(e){const t=document.getElementById("printer-target").value;let n;switch(e){case"riddle":n="/riddle";break;case"joke":n="/joke";break;case"quote":n="/quote";break;case"quiz":n="/quiz";break;case"poke":n="/poke";break;case"print-test":n="/print-test";break;default:return console.error("Unknown action:",e),void alert("Unknown action: "+e)}const o=getActionConfig(e);triggerConfetti(),fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({target:t})}).then(e=>{if(e.ok)return e.json();throw new Error(`HTTP ${e.status}: ${e.statusText}`)}).then(e=>{if(!e.content)throw new Error("No content received from server");let n,o;return"local-direct"===t?(n="/print-local",o={message:e.content}):"local-mqtt"===t?(n="/mqtt-send",o={topic:"scribe/Pharkie/inbox",message:e.content}):(n="/mqtt-send",o={topic:t,message:e.content}),fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})}).then(e=>e.ok?e.json():e.json().then(t=>{const n=t.error||t.message||`HTTP ${e.status}: ${e.statusText}`;throw new Error(n)}).catch(t=>{throw new Error(`HTTP ${e.status}: ${e.statusText}`)})).then(e=>{if(!e.success&&"success"!==e.status)throw new Error(e.error||e.message||"Unknown error occurred");showSuccessToast(`${o.name} scribed`)}).catch(e=>{console.error(`Failed to send ${o.name.toLowerCase()}:`,e),alert(`Failed to send ${o.name.toLowerCase()}. Please try again.\n\nError: ${e.message}`)})}function triggerConfetti(){if("undefined"!=typeof confetti){const e=document.documentElement.classList.contains("dark")||window.matchMedia("(prefers-color-scheme: dark)").matches;confetti({particleCount:100,spread:70,origin:{y:.6},colors:e?["#fbbf24","#34d399","#a78bfa","#f472b6","#fb7185"]:["#3b82f6","#ef4444","#10b981","#f59e0b","#8b5cf6"]})}}function showSuccessToast(e){const t=document.createElement("div");t.className="fixed top-4 right-4 bg-green-500 dark:bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg dark:shadow-2xl z-50 transform translate-x-full transition-transform duration-300",t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.classList.remove("translate-x-full")},10),setTimeout(()=>{t.classList.add("translate-x-full"),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300)},3e3)}function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}async function loadDiagnostics(){try{window.GLOBAL_CONFIG&&0!==Object.keys(window.GLOBAL_CONFIG).length||(console.log("Waiting for global config to load..."),await new Promise((e,t)=>{const n=setTimeout(()=>{t(new Error("Global config not loaded within timeout - please refresh the page"))},1e4),o=t=>{clearTimeout(n),window.removeEventListener("configLoaded",o),e(t.detail)};if(window.GLOBAL_CONFIG&&Object.keys(window.GLOBAL_CONFIG).length>0)return clearTimeout(n),void e(window.GLOBAL_CONFIG);window.addEventListener("configLoaded",o)}));const e=await fetch("/status");if(!e.ok)throw new Error(`Status endpoint error: HTTP ${e.status}: ${e.statusText}`);const t=await e.json();await displayDiagnostics(t,window.GLOBAL_CONFIG)}catch(e){console.error("Failed to load diagnostics:",e),displayDiagnosticsError(e.message)}}function formatTimestamp(e){if(!e||0==e)return"Not scheduled";if(e<9466848e5){const t=window.lastDiagnosticsData?.uptime||0;if(t>0){const n=e-t;if(n<=0)return"Overdue";const o=Math.floor(n/6e4),a=Math.floor(o/60),r=Math.floor(a/24);return r>0?`In ${r} day(s), ${a%24} hour(s)`:a>0?`In ${a} hour(s), ${o%60} minute(s)`:o>0?`In ${o} minute(s)`:`In ${Math.floor(n/1e3)} second(s)`}{const t=Math.floor(e/6e4),n=Math.floor(t/60),o=Math.floor(n/24);return o>0?`In ${o} day(s)`:n>0?`In ${n} hour(s)`:t>0?`In ${t} minute(s)`:"Very soon"}}return new Date(1e3*e).toLocaleString()}function populateDataFields(e,t){Object.keys(t).forEach(n=>{const o=e.querySelector(`[data-field="${n}"]`);o&&(n.includes("-bar")?o.style.width=t[n]:o.textContent=t[n])})}async function displayDiagnostics(e,t){window.lastDiagnosticsData=e;const n=document.getElementById("loading-indicator");n&&n.classList.add("hidden");const o=Math.floor(e.uptime/1e3),a=Math.floor(o/60),r=Math.floor(a/60),s=Math.round((e.total_heap-e.free_heap)/e.total_heap*100),i=Math.round(e.flash_used/e.flash_total*100),c=Math.round(e.sketch_size/(e.sketch_size+e.free_sketch_space)*100),d=document.getElementById("device-config-section");d&&(populateDataFields(d,{"device-owner":e.device_owner||t.device?.owner||"Unknown",timezone:e.timezone||t.device?.timezone||"Not configured","mdns-hostname":e.mdns_hostname||"Unknown","max-message-chars":e.configuration?.max_message_chars||t.validation?.maxCharacters||"Unknown"}),d.classList.remove("hidden"));const l=document.getElementById("config-file-section");if(l){const e=document.getElementById("config-file-contents"),n=document.querySelector('[data-field="config-file-size"]');if(e)try{const o=JSON.stringify(t,null,2);e.innerHTML=`<code class="language-json">${escapeHtml(o)}</code>`;const a=new Blob([o]).size,r=a<1024?`${a} B`:`${(a/1024).toFixed(1)} KB`;n&&(n.textContent=r)}catch(t){e.innerHTML=`<code class="text-red-500">Error processing config: ${escapeHtml(t.message)}</code>`,n&&(n.textContent="0 B")}l.classList.remove("hidden")}const u=document.getElementById("network-section");u&&(populateDataFields(u,{"wifi-status":e.wifi_connected?"Connected":"Disconnected","wifi-ssid":e.wifi_ssid||"Not connected","ip-address":e.ip_address||"Not assigned","signal-strength":e.rssi?`${e.rssi} dBm`:"Unknown","mac-address":e.mac_address||"Unknown",gateway:e.gateway||"Unknown",dns:e.dns||"Unknown"}),u.classList.remove("hidden"));const m=document.getElementById("mqtt-section");m&&(populateDataFields(m,{"mqtt-status":e.mqtt_connected?"Connected":"Disconnected","mqtt-server":e.mqtt_server||"Not configured","mqtt-port":e.mqtt_port||"Unknown","mqtt-topic":e.local_topic||"Not configured"}),m.classList.remove("hidden"));const g=document.getElementById("unbidden-ink-section");if(g){const t=e.unbidden_ink||{},n=e.configuration||{};populateDataFields(g,{"unbidden-ink-status":t.enabled?"Enabled":"Disabled","working-hours":t.start_hour&&t.end_hour?`${t.start_hour}:00 - ${t.end_hour}:00`:"Not configured",frequency:t.frequency_minutes?`${t.frequency_minutes} minutes`:"Not configured","next-scheduled":formatTimestamp(t.next_message_time),"ai-prompt-char-limit":n.max_prompt_chars?`${n.max_prompt_chars} characters`:"Unknown","settings-file-size":n.unbidden_ink_settings_file_size?`${n.unbidden_ink_settings_file_size} bytes`:"Unknown"});const o=document.getElementById("unbidden-ink-file-contents");o&&n.unbidden_ink_settings_file_contents?o.textContent=n.unbidden_ink_settings_file_contents:o&&(o.textContent="No file data available"),g.classList.remove("hidden")}const f=document.getElementById("microcontroller-section");f&&(populateDataFields(f,{"chip-model":e.chip_model||"Unknown","cpu-frequency":e.cpu_freq?`${e.cpu_freq} MHz`:"Unknown",temperature:e.temperature?`${e.temperature}°C`:"Unknown",uptime:r>0?`${r}h ${a%60}m`:`${a}m`,"reset-reason":e.reset_reason||"Unknown","heap-usage":`${Math.round((e.total_heap-e.free_heap)/1024)} KB / ${Math.round(e.total_heap/1024)} KB (${s}%)`,"flash-usage":`${Math.round(e.flash_used/1024)} KB / ${Math.round(e.flash_total/1024)} KB (${i}%)`,"sketch-usage":`${Math.round(e.sketch_size/1024)} KB / ${Math.round((e.sketch_size+e.free_sketch_space)/1024)} KB (${c}%)`,"heap-bar":`${s}%`,"flash-bar":`${i}%`,"sketch-bar":`${c}%`}),f.classList.remove("hidden"));const h=document.getElementById("hardware-buttons-section");if(h&&e.hardware_buttons){const t=document.getElementById("hardware-buttons-content");if(t){t.innerHTML="";if([{label:"Number of Buttons",value:e.hardware_buttons.num_buttons||"Unknown"},{label:"Debounce Time",value:e.hardware_buttons.debounce_ms?`${e.hardware_buttons.debounce_ms} ms`:"Unknown"},{label:"Long Press Time",value:e.hardware_buttons.long_press_ms?`${e.hardware_buttons.long_press_ms} ms`:"Unknown"},{label:"Active Low",value:void 0!==e.hardware_buttons.active_low?e.hardware_buttons.active_low?"Yes":"No":"Unknown"},{label:"Min Interval",value:e.hardware_buttons.min_interval_ms?`${e.hardware_buttons.min_interval_ms} ms`:"Unknown"},{label:"Max Per Minute",value:e.hardware_buttons.max_per_minute||"Unknown"}].forEach(e=>{const n=document.createElement("div");n.className="flex justify-between",n.innerHTML=`\n          <span class="text-gray-600 dark:text-gray-400">${e.label}:</span>\n          <span class="font-medium text-gray-900 dark:text-gray-100">${e.value}</span>\n        `,t.appendChild(n)}),e.hardware_buttons.buttons&&e.hardware_buttons.buttons.length>0){const e=document.createElement("div");e.className="border-t border-gray-200 dark:border-gray-600 my-3 pt-3",e.innerHTML='<div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Button Mappings:</div>',t.appendChild(e)}e.hardware_buttons.buttons&&e.hardware_buttons.buttons.forEach(e=>{const n=document.createElement("div");n.className="flex justify-between",n.innerHTML=`\n            <span class="text-gray-600 dark:text-gray-400">Pin ${e.gpio}:</span>\n            <span class="font-medium text-gray-900 dark:text-gray-100">Short: ${e.short_endpoint||"None"}, Long: ${e.long_endpoint||"None"}</span>\n          `,t.appendChild(n)})}h.classList.remove("hidden")}const p=document.getElementById("logging-section");p&&(populateDataFields(p,{"log-level":e.logging?.level_name||"Unknown","serial-logging":e.logging?.serial_enabled?"Enabled":"Disabled","file-logging":e.logging?.file_enabled?"Enabled":"Disabled","mqtt-logging":e.logging?.mqtt_enabled?"Enabled":"Disabled","betterstack-logging":e.logging?.betterstack_enabled?"Enabled":"Disabled"}),p.classList.remove("hidden"))}function displayDiagnosticsError(e){const t=document.getElementById("loading-indicator");t&&t.classList.add("hidden");const n=document.getElementById("error-container"),o=document.getElementById("error-message");n&&o&&(o.textContent=e,n.classList.remove("hidden"))}function copySection(e,t){const n=document.getElementById(e+"-section");if(!n)return;let o="🪄 Unbidden Ink\n\n";n.querySelectorAll(".flex.justify-between").forEach(e=>{const t=e.querySelector(".text-gray-600"),n=e.querySelector(".font-medium");t&&n&&(o+=`${t.textContent.trim()}: ${n.textContent.trim()}\n`)});const a=document.getElementById("unbidden-ink-file-contents");a&&a.textContent.trim()&&(o+="\nSettings File Contents:\n",o+=a.textContent),copyToClipboard(o,t)}function copyFileContents(e){const t=document.getElementById("unbidden-ink-file-contents")||document.getElementById("file-contents");t&&copyToClipboard(t.textContent,e)}function copyGenericSection(e,t){const n=t.closest(".rounded-lg");if(!n)return;let o=`${e}\n\n`;n.querySelectorAll(".flex.justify-between").forEach(e=>{const t=e.querySelector(".text-gray-600"),n=e.querySelector(".font-medium");if(t&&n){const e=t.textContent.trim().replace(":",""),a=n.textContent.trim();o+=`${e}: ${a}\n`}}),copyToClipboard(o,t)}function copyConfigFile(e){const t=document.getElementById("config-file-contents");if(!t)return;copyToClipboard(t.textContent||t.innerText,e)}function copyToClipboard(e,t){navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(e).then(()=>{showCopyFeedback(t)}).catch(()=>{fallbackCopyToClipboard(e,t)}):fallbackCopyToClipboard(e,t)}function fallbackCopyToClipboard(e,t){const n=document.createElement("textarea");n.value=e,n.style.position="fixed",n.style.left="-999999px",n.style.top="-999999px",document.body.appendChild(n);try{n.focus(),n.select();document.execCommand("copy")?showCopyFeedback(t):(console.error("Failed to copy text"),showErrorMessage("Copy failed - please select and copy manually"))}catch(e){console.error("Failed to copy:",e),showErrorMessage("Copy not supported - please select and copy manually")}finally{document.body.removeChild(n)}}function showCopyFeedback(e){if(!e)return;const t=e.innerHTML;e.innerHTML="✅",e.disabled=!0,setTimeout(()=>{e.innerHTML=t,e.disabled=!1},1500)}function initializeIndexUI(){const e=document.getElementById("message-textarea");e&&(e.addEventListener("input",()=>updateCharacterCount("message-textarea","char-counter",MAX_CHARS)),updateCharacterCount("message-textarea","char-counter",MAX_CHARS))}function initializePrinterSelection(){const e=document.getElementById("printer-selection");if(!e)return;e.innerHTML="";const t=createPrinterOption("local-direct","🖨️",`Local direct (${window.GLOBAL_CONFIG?.printers?.local?.name||"Unknown"})`,!0);e.appendChild(t),void 0!==PRINTERS&&PRINTERS.forEach(t=>{const n=createPrinterOption(t.topic,"📡",`${t.name} via MQTT`,!1);e.appendChild(n)})}function createPrinterOption(e,t,n,o=!1){const a=document.createElement("div");a.className="printer-option cursor-pointer p-4 rounded-xl border-2 transition-all duration-200 hover:scale-105 hover:shadow-md "+(o?"border-orange-400 bg-orange-50 dark:bg-orange-900/20 text-orange-700 dark:text-orange-300 dark:border-orange-600":"border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:border-gray-300 dark:hover:border-gray-500"),a.setAttribute("data-value",e);let r="Unknown";return r="local-direct"===e?"Direct connection":"MQTT connection",a.innerHTML=`\n    <div class="flex items-center space-x-3">\n      <span class="text-2xl">${t}</span>\n      <div>\n        <div class="font-medium text-sm">${n}</div>\n        <div class="text-xs text-gray-500 dark:text-gray-400">${r}</div>\n      </div>\n    </div>\n  `,a.addEventListener("click",()=>selectPrinter(e,a)),a}function selectPrinter(e,t){document.querySelectorAll(".printer-option").forEach(e=>{e.className=e.className.replace(/border-orange-400|bg-orange-50|text-orange-700|dark:bg-orange-900\/20|dark:text-orange-300|dark:border-orange-600/g,"").replace(/border-gray-200|bg-gray-50|text-gray-700|dark:border-gray-600|dark:bg-gray-700|dark:text-gray-300/g,"")+" border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:border-gray-300 dark:hover:border-gray-500"}),t.className=t.className.replace(/border-gray-200|bg-gray-50|text-gray-700|hover:border-gray-300|dark:border-gray-600|dark:bg-gray-700|dark:text-gray-300|dark:hover:border-gray-500/g,"")+" border-orange-400 bg-orange-50 dark:bg-orange-900/20 text-orange-700 dark:text-orange-300 dark:border-orange-600";const n=document.getElementById("printer-target");n&&(n.value=e)}function initializeConfigDependentUI(){initializePrinterSelection()}function updateCharacterCount(e,t,n=1e3){const o=document.getElementById(e),a=document.getElementById(t);if(o&&a){const e=o.value.length,t=n;a.textContent=`${e}/${t} characters`;const r=a.parentElement;r&&(r.classList.remove("text-gray-500","text-yellow-700","text-red-600","dark:text-gray-400","dark:text-yellow-300","dark:text-red-400"),e>t?r.classList.add("text-red-600","dark:text-red-400"):e>=.8*t?r.classList.add("text-yellow-700","dark:text-yellow-300"):r.classList.add("text-gray-500","dark:text-gray-400"))}}function goToSettings(){window.location.href="/settings.html"}document.addEventListener("DOMContentLoaded",function(){loadConfig(),document.addEventListener("keydown",handleKeyPress),initializeSharedUI()}),document.addEventListener("DOMContentLoaded",function(){initializeIndexUI(),initializeConfigDependentUI()});