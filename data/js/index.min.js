function initializeIndexUI(){const e=document.getElementById("printer-form");e&&e.addEventListener("submit",handleSubmit);const t=document.getElementById("settings-button");t&&t.addEventListener("click",goToSettings);const n=document.getElementById("message-textarea");n&&(n.addEventListener("input",()=>updateCharacterCount("message-textarea","char-counter",MAX_CHARS)),n.addEventListener("keydown",handleTextareaKeydown));const a=document.querySelector(".quick-actions-grid");a&&a.addEventListener("click",function(e){const t=e.target.closest(".quick-action-btn");if(t){const e=t.dataset.action;e&&sendQuickAction(e)}})}function initializePrinterSelection(){const e=document.getElementById("printer-selection");if(!e)return;e.innerHTML="";window.indexPageConfig;const t=createPrinterOption("local-direct","üè†","Local direct",!0,null);e.appendChild(t),"undefined"!=typeof PRINTERS&&PRINTERS.forEach(t=>{const n=createPrinterOption(`scribe/${t.name}/print`,"üì°",t.name,!1,t);e.appendChild(n)})}function createPrinterOption(e,t,n,a=!1,r=null){const o=document.createElement("div");o.className="printer-option cursor-pointer p-5 rounded-xl border-2 transition-all duration-200 hover:scale-105 hover:shadow-md "+(a?"border-orange-400 bg-orange-50 dark:bg-orange-900/20 text-orange-700 dark:text-orange-300 dark:border-orange-600":"border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:border-gray-300 dark:hover:border-gray-500"),o.setAttribute("data-value",e);let i="",s=!1;"local-direct"===e?i="Direct connection":(i="Direct connection",s=!0);const d=document.createElement("div");d.className="flex items-center justify-between w-full";const c=document.createElement("div");c.className="flex items-center space-x-4 flex-1 min-w-0",c.innerHTML=`\n    <span class="text-3xl">${t}</span>\n    <div class="flex-1 min-w-0 flex items-center">\n      <div class="font-medium text-base truncate">${n}</div>\n    </div>\n  `,d.appendChild(c);const l=document.createElement("div");return l.className="info-icon ml-3 flex-shrink-0 w-14 h-14 flex items-center justify-center rounded-full transition-colors duration-200 cursor-pointer",l.innerHTML='<span class="text-2xl text-gray-600 dark:text-gray-300">‚ìò</span>',l.title="View printer details",l.style.minWidth="56px",l.style.minHeight="56px","local-direct"===e?(l.setAttribute("data-is-local","true"),l.setAttribute("data-printer-name",n.replace("Local direct (","").replace(")","")),l.addEventListener("click",e=>{e.stopPropagation(),showLocalPrinterInfo()})):r&&(l.setAttribute("data-printer-info",JSON.stringify(r)),l.setAttribute("data-printer-name",r.name||"Unknown"),l.setAttribute("data-printer-topic",`scribe/${r.name}/print`),l.addEventListener("click",e=>{e.stopPropagation(),showPrinterInfoOverlay(r,r.name||"Unknown")})),d.appendChild(l),o.appendChild(d),o.addEventListener("click",t=>{t.target.closest(".info-icon")||selectPrinter(e,o)}),o}function selectPrinter(e,t){document.querySelectorAll(".printer-option").forEach(e=>{e.className=e.className.replace(/border-orange-400|bg-orange-50|text-orange-700|dark:bg-orange-900\/20|dark:text-orange-300|dark:border-orange-600/g,"").replace(/border-gray-200|bg-gray-50|text-gray-700|dark:border-gray-600|dark:bg-gray-700|dark:text-gray-300/g,"")+" border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:border-gray-300 dark:hover:border-gray-500"}),t.className=t.className.replace(/border-gray-200|bg-gray-50|text-gray-700|hover:border-gray-300|dark:border-gray-600|dark:bg-gray-700|dark:text-gray-300|dark:hover:border-gray-500/g,"")+" border-orange-400 bg-orange-50 dark:bg-orange-900/20 text-orange-700 dark:text-orange-300 dark:border-orange-600";const n=document.getElementById("printer-target");n&&(n.value=e)}function updateConfigDependentUI(){updateCharacterCount("message-textarea","char-counter",MAX_CHARS);const e=document.getElementById("message-textarea");e&&e.setAttribute("maxlength",MAX_CHARS),initializePrinterSelection()}function initializeConfigDependentUI(){initializePrinterSelection()}function updateCharacterCount(e,t,n=1e3){const a=document.getElementById(e),r=document.getElementById(t);if(a&&r){const e=a.value.length,t=n;r.textContent=`${e}/${t} characters`;const o=r.parentElement;o&&(o.classList.remove("text-gray-500","text-yellow-700","text-red-600","dark:text-gray-400","dark:text-yellow-300","dark:text-red-400"),e>t?o.classList.add("text-red-600","dark:text-red-400"):e>=.8*t?o.classList.add("text-yellow-700","dark:text-yellow-300"):o.classList.add("text-gray-500","dark:text-gray-400"))}}function formatTimeDifference(e){const t=Math.floor(e/1e3),n=Math.floor(t/60),a=Math.floor(n/60),r=Math.floor(a/24);return r>0?`${r} day${r>1?"s":""} ago`:a>0?`about ${a} hour${a>1?"s":""} ago`:n>=2?`${n} mins ago`:1===n?"A minute ago":t>30?"30 seconds ago":"Just now"}function copyToClipboard(e,t){navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(e).then(()=>{showCopyFeedback(t)}).catch(()=>{fallbackCopyToClipboard(e,t)}):fallbackCopyToClipboard(e,t)}function fallbackCopyToClipboard(e,t){const n=document.createElement("textarea");n.value=e,n.style.position="fixed",n.style.left="-999999px",n.style.top="-999999px",document.body.appendChild(n);try{n.focus(),n.select();document.execCommand("copy")?showCopyFeedback(t):console.error("Failed to copy text")}catch(e){console.error("Failed to copy:",e)}finally{document.body.removeChild(n)}}function showCopyFeedback(e){if(!e)return;const t=e.innerHTML;e.innerHTML="‚úÖ",e.disabled=!0,setTimeout(()=>{e.innerHTML=t,e.disabled=!1},1500)}function showLocalPrinterInfo(){const e=window.indexPageConfig?.device||{},t={name:e.printer_name||e.owner||"Local Printer",ip_address:e.ip_address||window.location.hostname,mdns:e.mdns||window.location.hostname,status:"online",firmware_version:e.firmware_version||"Unknown",timezone:e.timezone||"Unknown",last_power_on:e.boot_time||"Unknown"};showPrinterInfoOverlay(t,t.name,"local")}function showPrinterInfoOverlay(e,t,n="mqtt"){const a=document.getElementById("printer-info-overlay");a&&a.remove();const r=document.createElement("div");r.id="printer-info-overlay",r.className="fixed inset-0 z-50 flex items-end sm:items-center sm:justify-center p-4";const o=document.createElement("div");o.className="absolute inset-0 bg-black/60 backdrop-blur-sm",o.addEventListener("click",()=>closePrinterInfoOverlay());const i=document.createElement("div");i.className="relative bg-white dark:bg-gray-800 rounded-t-2xl sm:rounded-2xl w-full max-w-md max-h-[80vh] overflow-y-auto shadow-2xl transform transition-all duration-300 ease-out";const s="mqtt"===n?`scribe/${t}/print`:null,d=e.ip_address||"Not available",c=e.mdns||`${t.toLowerCase()}.local`,l=e.firmware_version||"Not available",g="local"===n?"üè†":"üì°";let m="Not available",u="";if(e.last_power_on){let t;if("string"==typeof e.last_power_on)t=new Date(e.last_power_on);else if("number"==typeof e.last_power_on){const n=e.last_power_on<1e10?1e3*e.last_power_on:e.last_power_on;t=new Date(n)}else t=new Date(e.last_power_on);m=formatTimeDifference((new Date).getTime()-t.getTime()),u=t.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}const y=e.timezone||"Same as local";i.innerHTML=`\n    <div class="p-6">\n      \x3c!-- Header with close button --\x3e\n      <div class="flex items-center justify-between mb-6">\n        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 flex items-center">\n          <span class="text-2xl mr-2">${g}</span>\n          ${t} Details\n        </h3>\n        <button class="close-overlay-btn w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors duration-200">\n          <span class="text-gray-600 dark:text-gray-400 text-xl">√ó</span>\n        </button>\n      </div>\n      \n      \x3c!-- Information sections --\x3e\n      <div class="space-y-4">\n        ${s?`\n        <div>\n          <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1 flex items-center justify-between">\n            <span>MQTT Topic</span>\n            <button class="copy-topic-btn p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors duration-200" title="Copy to clipboard" data-topic="${s}">\n              <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" class="text-gray-500 dark:text-gray-400">\n                <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z" />\n              </svg>\n            </button>\n          </div>\n          <div class="text-sm bg-gray-50 dark:bg-gray-700 p-3 rounded-lg font-mono text-gray-800 dark:text-gray-200 break-all">\n            ${s}\n          </div>\n        </div>\n        `:""}\n        \n        <div>\n          <div class="text-sm text-gray-800 dark:text-gray-200">\n            <span class="font-medium text-gray-700 dark:text-gray-300">Local IP Address:</span> ${d}\n          </div>\n        </div>\n        \n        <div>\n          <div class="text-sm text-gray-800 dark:text-gray-200">\n            <span class="font-medium text-gray-700 dark:text-gray-300">Local mDNS:</span> ${c}\n          </div>\n        </div>\n        \n        <div>\n          <div class="text-sm text-gray-800 dark:text-gray-200">\n            <span class="font-medium text-gray-700 dark:text-gray-300">Firmware Version:</span> ${l}\n          </div>\n        </div>\n        \n        <div>\n          <div class="text-sm text-gray-800 dark:text-gray-200">\n            <span class="font-medium text-gray-700 dark:text-gray-300">Last Power On:</span> ${m}${u?` (${u})`:""}\n          </div>\n        </div>\n        \n        <div>\n          <div class="text-sm text-gray-800 dark:text-gray-200">\n            <span class="font-medium text-gray-700 dark:text-gray-300">Timezone:</span> ${y}\n          </div>\n        </div>\n      </div>\n    </div>\n  `,r.appendChild(o),r.appendChild(i),document.body.appendChild(r);const p=i.querySelector(".close-overlay-btn");p&&p.addEventListener("click",closePrinterInfoOverlay);const x=i.querySelector(".copy-topic-btn");x&&x.addEventListener("click",function(){copyToClipboard(this.getAttribute("data-topic"),this)}),requestAnimationFrame(()=>{r.style.opacity="1",i.style.transform="translateY(0)"}),r.style.opacity="0",i.style.transform="translateY(100%)",document.addEventListener("keydown",handleOverlayEscape)}function closePrinterInfoOverlay(){const e=document.getElementById("printer-info-overlay");if(e){const t=e.querySelector(".relative");e.style.opacity="0",t&&(t.style.transform="translateY(100%)"),setTimeout(()=>{e.remove(),document.removeEventListener("keydown",handleOverlayEscape)},300)}}function handleOverlayEscape(e){"Escape"===e.key&&closePrinterInfoOverlay()}function goToSettings(){window.location.href="/settings.html"}function checkForSettingsSuccess(){if("true"===new URLSearchParams(window.location.search).get("settings_saved")){showSuccessToast("üíæ Settings saved");const e=window.location.pathname;window.history.replaceState({},document.title,e)}}function showSuccessToast(e){let t=document.getElementById("toast-container");t||(t=document.createElement("div"),t.id="toast-container",t.className="fixed top-4 right-4 z-50 space-y-2",document.body.appendChild(t));const n=document.createElement("div");n.className="bg-green-100 text-green-800 border border-green-200 p-4 rounded-lg shadow-lg transition-all duration-300 transform translate-x-0 opacity-100 max-w-sm",n.innerHTML=`\n    <div class="flex items-center space-x-2">\n      ${e.match(/^[\u{1F000}-\u{1F9FF}]|^[\u{2600}-\u{26FF}]/u)?"":'<span class="text-xl">‚úÖ</span>'}\n      <span class="flex-1">${e}</span>\n      <button class="toast-close-btn ml-2 text-lg font-bold opacity-50 hover:opacity-100">√ó</button>\n    </div>\n  `;const a=n.querySelector(".toast-close-btn");a&&a.addEventListener("click",function(){this.parentElement.parentElement.remove()}),t.appendChild(n),setTimeout(()=>{n.parentElement&&(n.classList.add("translate-x-full","opacity-0"),setTimeout(()=>{n.parentElement&&n.remove()},300))},4e3)}document.addEventListener("DOMContentLoaded",async function(){initializeIndexUI(),checkForSettingsSuccess();try{console.log("üìã Index: Loading configuration...");const e=await loadConfigForPage();console.log("üìã Index: Config loaded, initializing printer discovery"),window.indexPageConfig=e,updateConfigDependentUI(),initializePrinterDiscovery(),initializePrinterSelection()}catch(e){console.error("üìã Index: Failed to load config:",e),initializePrinterDiscovery(),initializePrinterSelection()}document.addEventListener("printersUpdated",function(e){console.log("üîÑ Printers updated, refreshing index page printer selection"),initializePrinterSelection()})});