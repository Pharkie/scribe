function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function redactSecrets(e){const t=JSON.parse(JSON.stringify(e)),n=["password","pass","secret","token","key","apikey","api_key","auth","credential","cert","private","bearer","oauth"];return function e(t){if("object"!=typeof t||null===t)return t;for(const[o,a]of Object.entries(t)){const s=o.toLowerCase();n.some(e=>s.includes(e))&&"string"==typeof a&&a.length>0?t[o]=a.length>8?a.substring(0,2)+"●●●●●●●●"+a.substring(a.length-2):"●●●●●●●●":"object"==typeof a&&null!==a&&e(a)}}(t),t}let currentSection="device-config-section";function showSection(e){document.querySelectorAll('[id$="-section"]').forEach(e=>{e.classList.remove("show")}),document.querySelectorAll(".section-nav-btn").forEach(e=>{e.classList.remove("active")});const t=document.getElementById(e);t&&(t.classList.add("show"),currentSection=e);const n=event?.target;n&&n.classList.add("active")}function goBack(){window.location.href="/"}function copyGenericSection(e,t){try{const n=t.closest('[id$="-section"]');if(!n)throw new Error("Section not found");const o=n.querySelectorAll(".diag-row, .space-y-1 > div, .space-y-2 > div");let a=`=== ${e} ===\n\n`;o.forEach(e=>{const t=e.querySelector(".diag-label, .text-gray-600, .dark\\:text-gray-400"),n=e.querySelector(".diag-value, .font-medium, [data-field]");if(t&&n){const e=t.textContent?.trim().replace(/[:：]\s*$/,"")||"",o=n.textContent?.trim()||"";e&&o&&(a+=`${e}: ${o}\n`)}});n.querySelectorAll(".diag-reference-box, .bg-blue-100, .bg-green-100, .bg-orange-100").forEach(e=>{e.querySelectorAll("div:not(.space-y-1):not(.space-y-2)").forEach(e=>{const t=e.textContent?.trim();if(t&&!t.includes("Connect to this network")){const e=t.replace(/\s+/g," ").replace(/:\s+/g,": ");e.includes(":")&&(a+=`${e}\n`)}})}),navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(a.trim()).then(()=>{showCopySuccess(t)}).catch(e=>{console.error("Copy failed:",e),fallbackCopy(a.trim(),t)}):fallbackCopy(a.trim(),t)}catch(e){console.error("Error copying section:",e)}}function copyConfigFile(e){try{const t=document.getElementById("config-content");if(!t)throw new Error("Config content not found");const n=`=== Configuration File (config.json) ===\n\n${t.textContent.trim()}`;navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(n).then(()=>{showCopySuccess(e)}).catch(t=>{console.error("Copy failed:",t),fallbackCopy(n,e)}):fallbackCopy(n,e)}catch(e){console.error("Error copying config:",e)}}function showCopySuccess(e){const t=e.innerHTML;e.innerHTML='<span class="text-green-600">✓</span>',e.style.transform="scale(1.1)",setTimeout(()=>{e.innerHTML=t,e.style.transform="scale(1)"},1e3)}function fallbackCopy(e,t){const n=document.createElement("textarea");n.value=e,n.style.position="fixed",n.style.opacity="0",document.body.appendChild(n),n.select();try{document.execCommand("copy"),showCopySuccess(t)}catch(e){console.error("Fallback copy failed:",e)}document.body.removeChild(n)}function updateProgressBar(e,t){const n=document.querySelector(`[data-field="${e}"]`);n&&(n.style.width=Math.min(Math.max(t,0),100)+"%",t>90?n.classList.add("bg-red-500"):t>75?n.classList.add("bg-orange-600"):n.classList.add("bg-orange-500"))}function setFieldValue(e,t,n=!1){document.querySelectorAll(`[data-field="${e}"]`).forEach(e=>{n?e.innerHTML=t:e.textContent=t||"-"})}function formatBytes(e){if(0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["B","KB","MB","GB"][t]}function formatUptime(e){const t=Math.floor(e/86400),n=Math.floor(e%86400/3600),o=Math.floor(e%3600/60);return t>0?`${t}d ${n}h ${o}m`:n>0?`${n}h ${o}m`:`${o}m`}function formatSignalStrength(e){if(!e)return"Unknown";let t,n;return e>=-30?(t="Excellent",n="#10b981"):e>=-50?(t="Very Good",n="#10b981"):e>=-60?(t="Good",n="#059669"):e>=-70?(t="Fair",n="#f59e0b"):e>=-80?(t="Weak",n="#ef4444"):(t="Very Weak",n="#dc2626"),`${e} dBm (<span style="color: ${n}; font-weight: 600;">${t}</span>)`}function displayDiagnostics(e,t){setFieldValue("device-owner",e.device?.owner),setFieldValue("timezone",e.device?.timezone),setFieldValue("mdns-hostname",e.device?.hostname),setFieldValue("max-message-chars",e.configuration?.max_message_chars),setFieldValue("wifi-status",e.network?.wifi?.connected?"Connected":"Disconnected"),setFieldValue("wifi-ssid",e.network?.wifi?.ssid),setFieldValue("ip-address",e.network?.wifi?.ip_address),setFieldValue("signal-strength",formatSignalStrength(e.network?.wifi?.signal_strength_dbm),!0),setFieldValue("mac-address",e.network?.wifi?.mac_address),setFieldValue("gateway",e.network?.wifi?.gateway),setFieldValue("dns",e.network?.wifi?.dns),setFieldValue("wifi-connect-timeout",e.network?.wifi?.connect_timeout_ms/1e3+" seconds"),setFieldValue("mqtt-enabled",e.network?.mqtt?.server?"Yes":"No"),setFieldValue("mqtt-status",e.network?.mqtt?.connected?"Connected":"Disconnected"),setFieldValue("mqtt-broker",e.network?.mqtt?.server),setFieldValue("mqtt-port",e.network?.mqtt?.port),setFieldValue("mqtt-topic",e.network?.mqtt?.topic),setFieldValue("chip-model",e.hardware?.chip_model||"Unknown"),setFieldValue("cpu-frequency",e.hardware?.cpu_frequency_mhz+" MHz"),setFieldValue("flash-size",formatBytes(e.system?.flash?.total_chip_size)),setFieldValue("firmware-version",e.hardware?.sdk_version),setFieldValue("uptime",formatUptime(e.system?.uptime_ms/1e3)),setFieldValue("free-heap",formatBytes(e.system?.memory?.free_heap)),setFieldValue("temperature",e.hardware?.temperature?`${e.hardware.temperature.toFixed(1)}°C`:"-");const n=(e.system?.flash?.app_partition?.used||0)/(e.system?.flash?.app_partition?.total||1)*100,o=(e.system?.memory?.used_heap||0)/(e.system?.memory?.total_heap||1)*100;setFieldValue("flash-usage-text",`${formatBytes(e.system?.flash?.app_partition?.used||0)} / ${formatBytes(e.system?.flash?.app_partition?.total||0)} (${n.toFixed(1)}%)`),setFieldValue("heap-usage-text",`${formatBytes(e.system?.memory?.used_heap||0)} / ${formatBytes(e.system?.memory?.total_heap||0)} (${o.toFixed(1)}%)`),updateProgressBar("flash-usage-bar",n),updateProgressBar("heap-usage-bar",o),setFieldValue("unbidden-ink-enabled",e.features?.unbidden_ink?.enabled?"Yes":"No"),setFieldValue("unbidden-ink-interval",e.features?.unbidden_ink?.frequency_minutes+" minutes"),setFieldValue("log-level",e.features?.logging?.level_name||"Unknown"),setFieldValue("serial-logging",e.features?.logging?.serial_enabled?"Enabled":"Disabled"),setFieldValue("web-logging",e.features?.logging?.betterstack_enabled?"Enabled":"Disabled"),setFieldValue("file-logging",e.features?.logging?.file_enabled?"Enabled":"Disabled"),setFieldValue("mqtt-logging",e.features?.logging?.mqtt_enabled?"Enabled":"Disabled");const a=document.getElementById("buttons-content");if(a&&e.features?.hardware_buttons){a.innerHTML="";const t=e.features.hardware_buttons,n=document.createElement("div");n.className="border-b border-gray-200 dark:border-gray-600 pb-3 mb-3";const o=document.createElement("h5");o.className="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2",o.textContent="Hardware Configuration",n.appendChild(o);const s=document.createElement("div");s.className="grid grid-cols-2 gap-2 text-sm";if([["Buttons",t.num_buttons||"Unknown"],["Debounce",`${t.debounce_ms||"Unknown"} ms`],["Long Press",`${t.long_press_ms||"Unknown"} ms`],["Active Low",void 0!==t.active_low?t.active_low?"Yes":"No":"Unknown"],["Min Interval",`${t.min_interval_ms||"Unknown"} ms`],["Max/Minute",t.max_per_minute||"Unknown"]].forEach(([e,t])=>{const n=document.createElement("div");n.innerHTML=`<span class="text-gray-600 dark:text-gray-400">${e}:</span> <span class="font-medium">${t}</span>`,s.appendChild(n)}),n.appendChild(s),a.appendChild(n),t.buttons&&t.buttons.length>0)t.buttons.forEach((e,t)=>{const n=document.createElement("div");n.className="bg-gray-50 dark:bg-gray-800 rounded-lg p-3 border border-gray-200 dark:border-gray-600";const o=document.createElement("h6");o.className="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2",o.textContent=`🔘 Button ${t+1} (GPIO ${e.gpio||"Unknown"})`,n.appendChild(o);const s=document.createElement("div");s.className="space-y-1 text-sm";const r=(e,t)=>{if(t&&"Not configured"!==t){const n=document.createElement("div");n.className="flex justify-between",n.innerHTML=`\n              <span class="text-gray-600 dark:text-gray-400">${e}:</span>\n              <span class="font-medium text-gray-900 dark:text-gray-100">${t}</span>\n            `,s.appendChild(n)}};r("Short Press",e.short_endpoint||"Not configured"),r("Long Press",e.long_endpoint||"Not configured"),e.short_mqtt_topic&&r("Short MQTT",e.short_mqtt_topic),e.long_mqtt_topic&&r("Long MQTT",e.long_mqtt_topic),n.appendChild(s),a.appendChild(n)});else{const e=document.createElement("div");e.className="text-gray-500 dark:text-gray-400 text-center py-4",e.textContent="No button configuration found",a.appendChild(e)}}const s=document.getElementById("web-pages"),r=document.getElementById("api-endpoints");if(e.endpoints?.web_pages&&s?(s.innerHTML="",e.endpoints.web_pages.forEach(e=>{const t=document.createElement("div");t.className="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 border border-blue-200 dark:border-blue-800";const n=document.createElement("div");n.className="font-mono text-sm font-semibold text-blue-700 dark:text-blue-300",n.textContent=e.path;const o=document.createElement("div");o.className="text-sm text-blue-600 dark:text-blue-400 mt-1",o.textContent=e.description,t.appendChild(n),t.appendChild(o),s.appendChild(t)})):s&&(s.innerHTML='<div class="text-gray-500">Loading...</div>'),e.endpoints?.api_endpoints&&r){r.innerHTML="";const t={};e.endpoints.api_endpoints.forEach(e=>{t[e.method]||(t[e.method]=[]),t[e.method].push(e)}),Object.entries(t).forEach(([e,t])=>{const n=document.createElement("div");n.className="mb-4";const o=document.createElement("h6");o.className="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2",o.textContent=`${e} Endpoints (${t.length})`,n.appendChild(o);const a=document.createElement("div");a.className="space-y-2",t.forEach(e=>{const t=document.createElement("div");t.className="bg-gray-50 dark:bg-gray-800 rounded-lg p-3 border border-gray-200 dark:border-gray-600";const n=document.createElement("div");n.className="font-mono text-sm font-semibold text-gray-900 dark:text-gray-100",n.textContent=e.path;const o=document.createElement("div");o.className="text-sm text-gray-600 dark:text-gray-400 mt-1",o.textContent=e.description,t.appendChild(n),t.appendChild(o),a.appendChild(t)}),n.appendChild(a),r.appendChild(n)})}else r&&(r.innerHTML='<div class="text-gray-500">Loading...</div>');const i=document.getElementById("config-content");if(t&&i){const e=redactSecrets(t);i.textContent=JSON.stringify(e,null,2)}else i&&(i.textContent="Configuration not available")}async function loadDiagnostics(){const e=document.getElementById("loading"),t=document.getElementById("error"),n=document.getElementById("diagnostics-content");e.style.display="block",t.classList.remove("show"),n.style.display="none";try{window.GLOBAL_CONFIG&&0!==Object.keys(window.GLOBAL_CONFIG).length||(console.log("Waiting for global config to load..."),await new Promise((e,t)=>{const n=setTimeout(()=>{t(new Error("Global config not loaded within timeout - please refresh the page"))},1e4),o=t=>{clearTimeout(n),window.removeEventListener("configLoaded",o),e(t.detail)};if(window.GLOBAL_CONFIG&&Object.keys(window.GLOBAL_CONFIG).length>0)return clearTimeout(n),void e(window.GLOBAL_CONFIG);window.addEventListener("configLoaded",o)}));const t=await fetch("/api/diagnostics");if(!t.ok)throw new Error(`Diagnostics API error: HTTP ${t.status}: ${t.statusText}`);displayDiagnostics(await t.json(),window.GLOBAL_CONFIG),e.style.display="none",n.style.display="block",showSection(currentSection)}catch(n){console.error("Error loading diagnostics:",n),e.style.display="none",t.classList.add("show"),document.getElementById("error-message").textContent=n.message}}document.addEventListener("DOMContentLoaded",()=>{loadDiagnostics(),showSection("device-config-section"),setInterval(loadDiagnostics,3e4)});