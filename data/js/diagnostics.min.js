function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}async function loadDiagnostics(){try{window.GLOBAL_CONFIG&&0!==Object.keys(window.GLOBAL_CONFIG).length||(console.log("Waiting for global config to load..."),await new Promise((e,t)=>{const n=setTimeout(()=>{t(new Error("Global config not loaded within timeout - please refresh the page"))},1e4),o=t=>{clearTimeout(n),window.removeEventListener("configLoaded",o),e(t.detail)};if(window.GLOBAL_CONFIG&&Object.keys(window.GLOBAL_CONFIG).length>0)return clearTimeout(n),void e(window.GLOBAL_CONFIG);window.addEventListener("configLoaded",o)}));const e=await fetch("/status");if(!e.ok)throw new Error(`Status endpoint error: HTTP ${e.status}: ${e.statusText}`);const t=await e.json();await displayDiagnostics(t,window.GLOBAL_CONFIG)}catch(e){console.error("Failed to load diagnostics:",e),displayDiagnosticsError(e.message)}}function formatTimestamp(e){if(!e||0==e)return"Not scheduled";if(e<9466848e5){const t=window.lastDiagnosticsData?.system?.uptime_ms||0;if(t>0){const n=e-t;if(n<=0)return"Overdue";const o=Math.floor(n/6e4),s=Math.floor(o/60),a=Math.floor(s/24);return a>0?`In ${a} day(s), ${s%24} hour(s)`:s>0?`In ${s} hour(s), ${o%60} minute(s)`:o>0?`In ${o} minute(s)`:`In ${Math.floor(n/1e3)} second(s)`}{const t=Math.floor(e/6e4),n=Math.floor(t/60),o=Math.floor(n/24);return o>0?`In ${o} day(s)`:n>0?`In ${n} hour(s)`:t>0?`In ${t} minute(s)`:"Very soon"}}return new Date(1e3*e).toLocaleString()}function populateDataFields(e,t){Object.keys(t).forEach(n=>{const o=e.querySelector(`[data-field="${n}"]`);o&&(n.includes("-bar")?o.style.width=t[n]:o.textContent=t[n])})}async function displayDiagnostics(e,t){window.lastDiagnosticsData=e;const n=document.getElementById("loading-indicator");n&&n.classList.add("hidden");const o=Math.floor(e.system.uptime_ms/1e3),s=Math.floor(o/60),a=Math.floor(s/60),i=(Math.round(e.system.memory.used_heap/e.system.memory.total_heap*100),document.getElementById("device-config-section"));i&&(populateDataFields(i,{"device-owner":e.device?.owner||t.device?.owner||"Unknown",timezone:e.device?.timezone||t.device?.timezone||"Not configured","mdns-hostname":e.device?.hostname||"Unknown","max-message-chars":e.configuration?.max_message_chars||t.validation?.maxCharacters||"Unknown"}),i.classList.remove("hidden"));const r=document.getElementById("config-file-section");if(r){const e=document.getElementById("config-file-contents"),n=document.querySelector('[data-field="config-file-size"]');if(e)try{const o=JSON.stringify(t,null,2);e.innerHTML=`<code class="language-json">${escapeHtml(o)}</code>`;const s=new Blob([o]).size,a=s<1024?`${s} B`:`${(s/1024).toFixed(1)} KB`;n&&(n.textContent=a)}catch(t){e.innerHTML=`<code class="text-red-500">Error processing config: ${escapeHtml(t.message)}</code>`,n&&(n.textContent="0 B")}r.classList.remove("hidden")}const d=document.getElementById("network-section");d&&(populateDataFields(d,{"wifi-status":e.network?.wifi?.connected?"Connected":"Disconnected","wifi-ssid":e.network?.wifi?.ssid||"Not connected","ip-address":e.network?.wifi?.ip_address||"Not assigned","signal-strength":e.network?.wifi?.signal_strength_dbm?`${e.network.wifi.signal_strength_dbm} dBm`:"Unknown","mac-address":e.network?.wifi?.mac_address||"Unknown",gateway:e.network?.wifi?.gateway||"Unknown",dns:e.network?.wifi?.dns||"Unknown"}),d.classList.remove("hidden"));const l=document.getElementById("mqtt-section");l&&(populateDataFields(l,{"mqtt-status":e.network?.mqtt?.connected?"Connected":"Disconnected","mqtt-server":e.network?.mqtt?.server||"Not configured","mqtt-port":e.network?.mqtt?.port||"Unknown","mqtt-topic":e.network?.mqtt?.topic||"Not configured"}),l.classList.remove("hidden"));const c=document.getElementById("unbidden-ink-section");if(c){const t=e.features?.unbidden_ink||{},n=e.configuration||{};populateDataFields(c,{"unbidden-ink-status":t.enabled?"Enabled":"Disabled","working-hours":t.start_hour&&t.end_hour?`${t.start_hour}:00 - ${t.end_hour}:00`:"Not configured",frequency:t.frequency_minutes?`${t.frequency_minutes} minutes`:"Not configured","next-scheduled":formatTimestamp(t.next_message_time),"ai-prompt-char-limit":n.max_prompt_chars?`${n.max_prompt_chars} characters`:"Unknown","settings-file-size":n.unbidden_ink_settings_file_size?`${n.unbidden_ink_settings_file_size} bytes`:"Unknown"});const o=document.getElementById("unbidden-ink-file-contents");o&&n.unbidden_ink_settings_file_contents?o.textContent=n.unbidden_ink_settings_file_contents:o&&(o.textContent="No file data available"),c.classList.remove("hidden")}const m=document.getElementById("microcontroller-section");if(m){const t=Math.round(e.system.memory.used_heap/e.system.memory.total_heap*100),n=Math.round(e.system.flash.app_partition.used/e.system.flash.app_partition.total*100),o=Math.round(e.system.flash.filesystem.used/e.system.flash.filesystem.total*100),i=e.system.flash.app_partition.percent_of_total_flash||0,r=e.system.flash.filesystem.percent_of_total_flash||0,d=e=>e<1024?`${e} B`:`${Math.round(e/1024)} KB`,l=`${d(e.system.memory.used_heap)} / ${d(e.system.memory.total_heap)} (${t}%)`,c=`${d(e.system.flash.app_partition.used)} / ${d(e.system.flash.app_partition.total)} (${n}%)`,u=`${d(e.system.flash.filesystem.used)} / ${d(e.system.flash.filesystem.total)} (${o}%)`;populateDataFields(m,{"chip-model":e.hardware?.chip_model||"Unknown","cpu-frequency":e.hardware?.cpu_frequency_mhz?`${e.hardware.cpu_frequency_mhz} MHz`:"Unknown",temperature:e.hardware?.temperature?`${e.hardware.temperature}Â°C`:"Unknown",uptime:a>0?`${a}h ${s%60}m`:`${s}m`,"reset-reason":e.hardware?.reset_reason||"Unknown","heap-usage":l,"app-partition-usage":c,"filesystem-usage":u,"heap-bar":`${t}%`,"app-partition-bar":`${n}%`,"filesystem-bar":`${o}%`});const f=document.getElementById("app-partition-note"),p=document.getElementById("filesystem-note");f&&(f.textContent=`Program code space (${i}% of total flash)`),p&&(p.textContent=`Web files, configuration, and logs (${r}% of total flash)`),m.classList.remove("hidden")}const u=document.getElementById("hardware-buttons-section");if(u&&e.features?.hardware_buttons){const t=document.getElementById("hardware-buttons-content");if(t){t.innerHTML="";const n=e.features.hardware_buttons;if([{label:"Number of Buttons",value:n.num_buttons||"Unknown"},{label:"Debounce Time",value:n.debounce_ms?`${n.debounce_ms} ms`:"Unknown"},{label:"Long Press Time",value:n.long_press_ms?`${n.long_press_ms} ms`:"Unknown"},{label:"Active Low",value:void 0!==n.active_low?n.active_low?"Yes":"No":"Unknown"},{label:"Min Interval",value:n.min_interval_ms?`${n.min_interval_ms} ms`:"Unknown"},{label:"Max Per Minute",value:n.max_per_minute||"Unknown"}].forEach(e=>{const n=document.createElement("div");n.className="flex justify-between",n.innerHTML=`\n          <span class="text-gray-600 dark:text-gray-400">${e.label}:</span>\n          <span class="font-medium text-gray-900 dark:text-gray-100">${e.value}</span>\n        `,t.appendChild(n)}),n.buttons&&n.buttons.length>0){const e=document.createElement("div");e.className="border-t border-gray-200 dark:border-gray-600 my-3 pt-3",e.innerHTML='<div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Button Mappings:</div>',t.appendChild(e)}n.buttons&&n.buttons.forEach(e=>{const n=document.createElement("div");n.className="flex justify-between",n.innerHTML=`\n            <span class="text-gray-600 dark:text-gray-400">Pin ${e.gpio}:</span>\n            <span class="font-medium text-gray-900 dark:text-gray-100">Short: ${e.short_endpoint||"None"}, Long: ${e.long_endpoint||"None"}</span>\n          `,t.appendChild(n)})}u.classList.remove("hidden")}const f=document.getElementById("logging-section");if(f){const t=e.features?.logging||{};populateDataFields(f,{"log-level":t.level_name||"Unknown","serial-logging":t.serial_enabled?"Enabled":"Disabled","file-logging":t.file_enabled?"Enabled":"Disabled","mqtt-logging":t.mqtt_enabled?"Enabled":"Disabled","betterstack-logging":t.betterstack_enabled?"Enabled":"Disabled"}),f.classList.remove("hidden")}}function displayDiagnosticsError(e){const t=document.getElementById("loading-indicator");t&&t.classList.add("hidden");const n=document.getElementById("error-container"),o=document.getElementById("error-message");n&&o&&(o.textContent=e,n.classList.remove("hidden"))}function copySection(e,t){const n=document.getElementById(e+"-section");if(!n)return;let o="ðŸª„ Unbidden Ink\n\n";n.querySelectorAll(".flex.justify-between").forEach(e=>{const t=e.querySelector(".text-gray-600"),n=e.querySelector(".font-medium");t&&n&&(o+=`${t.textContent.trim()}: ${n.textContent.trim()}\n`)});const s=document.getElementById("unbidden-ink-file-contents");s&&s.textContent.trim()&&(o+="\nSettings File Contents:\n",o+=s.textContent),copyToClipboard(o,t)}function copyFileContents(e){const t=document.getElementById("unbidden-ink-file-contents")||document.getElementById("file-contents");t&&copyToClipboard(t.textContent,e)}function copyGenericSection(e,t){const n=t.closest(".rounded-lg");if(!n)return;let o=`${e}\n\n`;n.querySelectorAll(".flex.justify-between").forEach(e=>{const t=e.querySelector(".text-gray-600"),n=e.querySelector(".font-medium");if(t&&n){const e=t.textContent.trim().replace(":",""),s=n.textContent.trim();o+=`${e}: ${s}\n`}}),copyToClipboard(o,t)}function copyConfigFile(e){const t=document.getElementById("config-file-contents");if(!t)return;copyToClipboard(t.textContent||t.innerText,e)}function copyToClipboard(e,t){navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(e).then(()=>{showCopyFeedback(t)}).catch(()=>{fallbackCopyToClipboard(e,t)}):fallbackCopyToClipboard(e,t)}function fallbackCopyToClipboard(e,t){const n=document.createElement("textarea");n.value=e,n.style.position="fixed",n.style.left="-999999px",n.style.top="-999999px",document.body.appendChild(n);try{n.focus(),n.select();document.execCommand("copy")?showCopyFeedback(t):(console.error("Failed to copy text"),showErrorMessage("Copy failed - please select and copy manually"))}catch(e){console.error("Failed to copy:",e),showErrorMessage("Copy not supported - please select and copy manually")}finally{document.body.removeChild(n)}}function showCopyFeedback(e){if(!e)return;const t=e.innerHTML;e.innerHTML="âœ…",e.disabled=!0,setTimeout(()=>{e.innerHTML=t,e.disabled=!1},1500)}