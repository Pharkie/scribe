function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function redactSecrets(e){const t=JSON.parse(JSON.stringify(e)),n=["password","pass","secret","token","key","apikey","api_key","auth","credential","cert","private","bearer","oauth"];return function e(t){if("object"!=typeof t||null===t)return t;for(const[o,s]of Object.entries(t)){const i=o.toLowerCase();n.some(e=>i.includes(e))&&"string"==typeof s&&s.length>0?t[o]=s.length>8?s.substring(0,2)+"●●●●●●●●"+s.substring(s.length-2):"●●●●●●●●":"object"==typeof s&&null!==s&&e(s)}}(t),t}let currentSection="device-config-section";function showSection(e){document.querySelectorAll('[id$="-section"]').forEach(e=>{e.classList.remove("show")}),document.querySelectorAll(".section-nav-btn").forEach(e=>{e.classList.remove("active")});const t=document.getElementById(e);t&&(t.classList.add("show"),currentSection=e);const n=event?.target;n&&n.classList.add("active")}function goBack(){window.location.href="/"}function copyGenericSection(e,t){try{const n=t.closest('[id$="-section"]');if(!n)throw new Error("Section not found");const o=n.querySelectorAll(".diag-row, .space-y-1 > div, .space-y-2 > div");let s=`=== ${e} ===\n\n`;o.forEach(e=>{const t=e.querySelector(".diag-label, .text-gray-600, .dark\\:text-gray-400"),n=e.querySelector(".diag-value, .font-medium, [data-field]");if(t&&n){const e=t.textContent?.trim().replace(/[:：]\s*$/,"")||"",o=n.textContent?.trim()||"";e&&o&&(s+=`${e}: ${o}\n`)}});n.querySelectorAll(".diag-reference-box, .bg-blue-100, .bg-green-100, .bg-orange-100").forEach(e=>{e.querySelectorAll("div:not(.space-y-1):not(.space-y-2)").forEach(e=>{const t=e.textContent?.trim();if(t&&!t.includes("Connect to this network")){const e=t.replace(/\s+/g," ").replace(/:\s+/g,": ");e.includes(":")&&(s+=`${e}\n`)}})}),navigator.clipboard.writeText(s.trim()).then(()=>{showCopySuccess(t)}).catch(e=>{console.error("Copy failed:",e),fallbackCopy(s.trim(),t)})}catch(e){console.error("Error copying section:",e)}}function copyConfigFile(e){try{const t=document.getElementById("config-content");if(!t)throw new Error("Config content not found");const n=`=== Configuration File (config.json) ===\n\n${t.textContent.trim()}`;navigator.clipboard.writeText(n).then(()=>{showCopySuccess(e)}).catch(t=>{console.error("Copy failed:",t),fallbackCopy(n,e)})}catch(e){console.error("Error copying config:",e)}}function showCopySuccess(e){const t=e.innerHTML;e.innerHTML='<span class="text-green-600">✓</span>',e.style.transform="scale(1.1)",setTimeout(()=>{e.innerHTML=t,e.style.transform="scale(1)"},1e3)}function fallbackCopy(e,t){const n=document.createElement("textarea");n.value=e,n.style.position="fixed",n.style.opacity="0",document.body.appendChild(n),n.select();try{document.execCommand("copy"),showCopySuccess(t)}catch(e){console.error("Fallback copy failed:",e)}document.body.removeChild(n)}function updateProgressBar(e,t){const n=document.querySelector(`[data-field="${e}"]`);n&&(n.style.width=Math.min(Math.max(t,0),100)+"%",t>90?n.classList.add("bg-red-500"):t>75?n.classList.add("bg-orange-600"):n.classList.add("bg-orange-500"))}function setFieldValue(e,t,n=!1){document.querySelectorAll(`[data-field="${e}"]`).forEach(e=>{n?e.innerHTML=t:e.textContent=t||"-"})}function formatBytes(e){if(0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["B","KB","MB","GB"][t]}function formatUptime(e){const t=Math.floor(e/86400),n=Math.floor(e%86400/3600),o=Math.floor(e%3600/60);return t>0?`${t}d ${n}h ${o}m`:n>0?`${n}h ${o}m`:`${o}m`}function displayDiagnostics(e,t){setFieldValue("device-owner",e.device?.owner),setFieldValue("timezone",e.device?.timezone),setFieldValue("mdns-hostname",e.device?.hostname),setFieldValue("max-message-chars",e.configuration?.max_message_chars),setFieldValue("wifi-status",e.network?.wifi?.connected?"Connected":"Disconnected"),setFieldValue("wifi-ssid",e.network?.wifi?.ssid),setFieldValue("ip-address",e.network?.wifi?.ip_address),setFieldValue("signal-strength",e.network?.wifi?.signal_strength_dbm+" dBm"),setFieldValue("mac-address",e.network?.wifi?.mac_address),setFieldValue("gateway",e.network?.wifi?.gateway),setFieldValue("dns",e.network?.wifi?.dns),setFieldValue("wifi-connect-timeout",e.network?.wifi?.connect_timeout_ms/1e3+" seconds"),setFieldValue("mqtt-enabled",e.network?.mqtt?.server?"Yes":"No"),setFieldValue("mqtt-status",e.network?.mqtt?.connected?"Connected":"Disconnected"),setFieldValue("mqtt-broker",e.network?.mqtt?.server),setFieldValue("mqtt-port",e.network?.mqtt?.port),setFieldValue("mqtt-topic",e.network?.mqtt?.topic),setFieldValue("cpu-frequency",e.hardware?.cpu_frequency_mhz+" MHz"),setFieldValue("flash-size",formatBytes(e.system?.flash?.total_chip_size)),setFieldValue("firmware-version",e.hardware?.sdk_version),setFieldValue("uptime",formatUptime(e.system?.uptime_ms/1e3)),setFieldValue("free-heap",formatBytes(e.system?.memory?.free_heap)),setFieldValue("temperature",e.hardware?.temperature?`${e.hardware.temperature.toFixed(1)}°C`:"-");const n=(e.system?.flash?.app_partition?.used||0)/(e.system?.flash?.app_partition?.total||1)*100,o=(e.system?.memory?.used_heap||0)/(e.system?.memory?.total_heap||1)*100;setFieldValue("flash-usage-text",`${formatBytes(e.system?.flash?.app_partition?.used||0)} / ${formatBytes(e.system?.flash?.app_partition?.total||0)} (${n.toFixed(1)}%)`),setFieldValue("heap-usage-text",`${formatBytes(e.system?.memory?.used_heap||0)} / ${formatBytes(e.system?.memory?.total_heap||0)} (${o.toFixed(1)}%)`),updateProgressBar("flash-usage-bar",n),updateProgressBar("heap-usage-bar",o),setFieldValue("unbidden-ink-enabled",e.features?.unbidden_ink?.enabled?"Yes":"No"),setFieldValue("unbidden-ink-interval",e.features?.unbidden_ink?.frequency_minutes+" minutes"),setFieldValue("log-level",e.features?.logging?.level_name||"Unknown"),setFieldValue("serial-logging",e.features?.logging?.serial_enabled?"Enabled":"Disabled"),setFieldValue("web-logging",e.features?.logging?.betterstack_enabled?"Enabled":"Disabled"),setFieldValue("file-logging",e.features?.logging?.file_enabled?"Enabled":"Disabled");const s=e.features?.hardware_buttons?.buttons||[];setFieldValue("button-1-short",s[0]?.short_endpoint||"Not configured"),setFieldValue("button-1-long",s[0]?.long_endpoint||"Not configured"),setFieldValue("button-1-short-mqtt",s[0]?.short_mqtt_topic||"-"),setFieldValue("button-1-long-mqtt",s[0]?.long_mqtt_topic||"-"),setFieldValue("button-2-short",s[1]?.short_endpoint||"Not configured"),setFieldValue("button-2-long",s[1]?.long_endpoint||"Not configured"),setFieldValue("button-2-short-mqtt",s[1]?.short_mqtt_topic||"-"),setFieldValue("button-2-long-mqtt",s[1]?.long_mqtt_topic||"-"),setFieldValue("button-3-short",s[2]?.short_endpoint||"Not configured"),setFieldValue("button-3-long",s[2]?.long_endpoint||"Not configured"),setFieldValue("button-3-short-mqtt",s[2]?.short_mqtt_topic||"-"),setFieldValue("button-3-long-mqtt",s[2]?.long_mqtt_topic||"-"),setFieldValue("button-4-short",s[3]?.short_endpoint||"Not configured"),setFieldValue("button-4-long",s[3]?.long_endpoint||"Not configured"),setFieldValue("button-4-short-mqtt",s[3]?.short_mqtt_topic||"-"),setFieldValue("button-4-long-mqtt",s[3]?.long_mqtt_topic||"-");const i=document.getElementById("web-pages"),a=document.getElementById("api-endpoints");e.endpoints?.web_pages&&i?i.innerHTML=e.endpoints.web_pages.map(e=>`<div class="flex justify-between"><span>${escapeHtml(e.path)}</span><span class="text-slate-600 dark:text-slate-400">${escapeHtml(e.description)}</span></div>`).join(""):i&&(i.innerHTML='<div class="text-gray-500">Loading...</div>'),e.endpoints?.api_endpoints&&a?a.innerHTML=e.endpoints.api_endpoints.map(e=>`<div class="flex justify-between"><span class="font-mono text-sm">${escapeHtml(e.method)} ${escapeHtml(e.path)}</span><span class="text-slate-600 dark:text-slate-400">${escapeHtml(e.description)}</span></div>`).join(""):a&&(a.innerHTML='<div class="text-gray-500">Loading...</div>');const r=document.getElementById("config-content");if(t&&r){const e=redactSecrets(t);r.textContent=JSON.stringify(e,null,2)}else r&&(r.textContent="Configuration not available")}function loadDiagnostics(){const e=document.getElementById("loading"),t=document.getElementById("error"),n=document.getElementById("diagnostics-content");e.style.display="block",t.classList.remove("show"),n.style.display="none",Promise.all([fetch("/api/diagnostics").then(e=>{if(!e.ok)throw new Error(`Diagnostics API error: HTTP ${e.status}: ${e.statusText}`);return e.json()}),fetch("/api/config").then(e=>{if(!e.ok)throw new Error(`Config API error: HTTP ${e.status}: ${e.statusText}`);return e.json()})]).then(([t,o])=>{displayDiagnostics(t,o),e.style.display="none",n.style.display="block",showSection(currentSection)}).catch(n=>{console.error("Error loading diagnostics:",n),e.style.display="none",t.classList.add("show"),document.getElementById("error-message").textContent=n.message})}document.addEventListener("DOMContentLoaded",()=>{loadDiagnostics(),showSection("device-config-section"),setInterval(loadDiagnostics,3e4)});