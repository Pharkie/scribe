function setupDiagnosticsEventListeners(){document.querySelectorAll("[data-section]").forEach(e=>{e.addEventListener("click",function(){showSection(this.dataset.section)})}),document.querySelectorAll(".generic-copy-btn").forEach(e=>{e.addEventListener("click",function(){copyGenericSection(this.dataset.sectionName,this)})}),document.querySelectorAll(".quick-action-btn").forEach(e=>{e.addEventListener("click",function(){const e=this.dataset.action;e&&handleQuickAction(e)})});const e=document.getElementById("config-copy-btn");e&&e.addEventListener("click",function(){copyConfigFile(this)})}function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function redactSecrets(e){const t=JSON.parse(JSON.stringify(e)),n=["password","pass","secret","token","key","apikey","api_key","auth","credential","cert","private","bearer","oauth"];return function e(t){if("object"!=typeof t||null===t)return t;for(const[o,s]of Object.entries(t)){const a=o.toLowerCase();n.some(e=>a.includes(e))&&"string"==typeof s&&s.length>0?t[o]=s.length>8?s.substring(0,2)+"●●●●●●●●"+s.substring(s.length-2):"●●●●●●●●":"object"==typeof s&&null!==s&&e(s)}}(t),t}document.addEventListener("DOMContentLoaded",function(){setupDiagnosticsEventListeners(),loadDiagnostics(),showSection("device-config-section")});let currentSection="device-config-section";function showSection(e){document.querySelectorAll('[id$="-section"]').forEach(e=>{e.classList.remove("show")}),document.querySelectorAll(".section-nav-btn").forEach(e=>{e.classList.remove("active")});const t=document.getElementById(e);t&&(t.classList.add("show"),currentSection=e);const n=document.querySelector(`[data-section="${e}"]`);n&&n.classList&&n.classList.add("active")}function goBack(){window.location.href="/"}function copyGenericSection(e,t){try{const n=t.closest('[id$="-section"]');if(!n)throw new Error("Section not found");const o=n.querySelectorAll(".diag-row, .space-y-1 > div, .space-y-2 > div");let s=`=== ${e} ===\n\n`;o.forEach(e=>{const t=e.querySelector(".diag-label, .text-gray-600, .dark\\:text-gray-400"),n=e.querySelector(".diag-value, .font-medium, [data-field]");if(t&&n){const e=t.textContent?.trim().replace(/[:：]\s*$/,"")||"",o=n.textContent?.trim()||"";e&&o&&(s+=`${e}: ${o}\n`)}});n.querySelectorAll(".diag-reference-box, .bg-blue-100, .bg-green-100, .bg-orange-100").forEach(e=>{e.querySelectorAll("div:not(.space-y-1):not(.space-y-2)").forEach(e=>{const t=e.textContent?.trim();if(t&&!t.includes("Connect to this network")){const e=t.replace(/\s+/g," ").replace(/:\s+/g,": ");e.includes(":")&&(s+=`${e}\n`)}})}),navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(s.trim()).then(()=>{showCopySuccess(t)}).catch(e=>{console.error("Copy failed:",e),fallbackCopy(s.trim(),t)}):fallbackCopy(s.trim(),t)}catch(e){console.error("Error copying section:",e)}}function highlightJSON(e){return e.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,function(e){let t="json-number";return/^"/.test(e)?t=/:$/.test(e)?"json-key":"json-string":/true|false/.test(e)?t="json-boolean":/null/.test(e)&&(t="json-null"),'<span class="'+t+'">'+e+"</span>"}).replace(/([{}[\],])/g,'<span class="json-punctuation">$1</span>')}function copyConfigFile(e){try{const t=document.getElementById("config-content");if(!t)throw new Error("Config content not found");const n=`=== Configuration File (config.json) ===\n\n${t.textContent.trim()}`;navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(n).then(()=>{showCopySuccess(e)}).catch(t=>{console.error("Copy failed:",t),fallbackCopy(n,e)}):fallbackCopy(n,e)}catch(e){console.error("Error copying config:",e)}}function showCopySuccess(e){const t=e.innerHTML;e.innerHTML='<span class="text-green-600">✓</span>',e.style.transform="scale(1.1)",setTimeout(()=>{e.innerHTML=t,e.style.transform="scale(1)"},1e3)}function fallbackCopy(e,t){const n=document.createElement("textarea");n.value=e,n.style.position="fixed",n.style.opacity="0",document.body.appendChild(n),n.select();try{document.execCommand("copy"),showCopySuccess(t)}catch(e){console.error("Fallback copy failed:",e)}document.body.removeChild(n)}function updateProgressBar(e,t){const n=document.querySelector(`[data-field="${e}"]`);n&&(n.style.width=Math.min(Math.max(t,0),100)+"%",t>90?n.classList.add("bg-red-500"):t>75?n.classList.add("bg-orange-600"):n.classList.add("bg-orange-500"))}function setFieldValue(e,t,n=!1){document.querySelectorAll(`[data-field="${e}"]`).forEach(e=>{n?e.innerHTML=t:e.textContent=t||"-"})}function formatBytes(e){if(0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(0))+" "+["B","KB","MB","GB"][t]}function formatUptime(e){const t=Math.floor(e/86400),n=Math.floor(e%86400/3600),o=Math.floor(e%3600/60);return t>0?`${t}d ${n}h ${o}m`:n>0?`${n}h ${o}m`:`${o}m`}function formatSignalStrength(e){if(!e)return"Unknown";let t,n;return e>=-30?(t="Excellent",n="#10b981"):e>=-50?(t="Very Good",n="#10b981"):e>=-60?(t="Good",n="#059669"):e>=-70?(t="Fair",n="#f59e0b"):e>=-80?(t="Weak",n="#ef4444"):(t="Very Weak",n="#dc2626"),`${e} dBm (<span style="color: ${n}; font-weight: 600;">${t}</span>)`}function formatTemperature(e){if(!e||isNaN(e))return"-";let t,n;return e<35?(t="Cool",n="#3b82f6"):e<50?(t="Normal",n="#10b981"):e<65?(t="Warm",n="#f59e0b"):e<80?(t="Hot",n="#ef4444"):(t="Critical",n="#dc2626"),`${e.toFixed(1)}°C (<span style="color: ${n}; font-weight: 600;">${t}</span>)`}function displayDiagnostics(e,t){setFieldValue("device-owner",e.device?.owner),setFieldValue("timezone",e.device?.timezone),setFieldValue("mdns-hostname",e.device?.hostname),setFieldValue("max-message-chars",t?.validation?.maxCharacters),setFieldValue("wifi-status",e.network?.wifi?.connected?"Connected":"Disconnected"),setFieldValue("wifi-ssid",e.network?.wifi?.ssid),setFieldValue("ip-address",e.network?.wifi?.ip_address),setFieldValue("signal-strength",formatSignalStrength(e.network?.wifi?.signal_strength_dbm),!0),setFieldValue("mac-address",e.network?.wifi?.mac_address),setFieldValue("gateway",e.network?.wifi?.gateway),setFieldValue("dns",e.network?.wifi?.dns),setFieldValue("wifi-connect-timeout",e.network?.wifi?.connect_timeout_ms/1e3+" seconds"),setFieldValue("mqtt-enabled",e.network?.mqtt?.server?"Yes":"No"),setFieldValue("mqtt-status",e.network?.mqtt?.connected?"Connected":"Disconnected"),setFieldValue("mqtt-broker",e.network?.mqtt?.server),setFieldValue("mqtt-port",e.network?.mqtt?.port),setFieldValue("mqtt-topic",e.network?.mqtt?.topic),setFieldValue("chip-model",e.hardware?.chip_model||"Unknown"),setFieldValue("cpu-frequency",e.hardware?.cpu_frequency_mhz+" MHz"),setFieldValue("flash-size",formatBytes(e.system?.flash?.total_chip_size)),setFieldValue("firmware-version",e.hardware?.sdk_version),setFieldValue("uptime",formatUptime(e.system?.uptime_ms/1e3)),setFieldValue("temperature",formatTemperature(e.hardware?.temperature),!0);const n=(e.system?.flash?.app_partition?.used||0)/(e.system?.flash?.app_partition?.total||1)*100,o=(e.system?.memory?.used_heap||0)/(e.system?.memory?.total_heap||1)*100;setFieldValue("flash-usage-text",`${formatBytes(e.system?.flash?.app_partition?.used||0)} / ${formatBytes(e.system?.flash?.app_partition?.total||0)} (${n.toFixed(0)}%)`),setFieldValue("heap-usage-text",`${formatBytes(e.system?.memory?.used_heap||0)} / ${formatBytes(e.system?.memory?.total_heap||0)} (${o.toFixed(0)}%)`),updateProgressBar("flash-usage-bar",n),updateProgressBar("heap-usage-bar",o);const s=e.features?.unbidden_ink;if(setFieldValue("unbidden-ink-enabled",s?.enabled?"Yes":"No"),setFieldValue("unbidden-ink-start-hour",void 0!==s?.start_hour?`${String(s.start_hour).padStart(2,"0")}:00`:"Unknown"),setFieldValue("unbidden-ink-end-hour",void 0!==s?.end_hour?`${String(s.end_hour).padStart(2,"0")}:00`:"Unknown"),setFieldValue("unbidden-ink-frequency",void 0!==s?.frequency_minutes?`${s.frequency_minutes} minutes`:"Unknown"),s?.next_message_time&&s.next_message_time>0){Date.now();const t=s.next_message_time-(e.microcontroller?.uptime_ms||0);if(t<=0)setFieldValue("unbidden-ink-next-message","Overdue");else{const e=Math.floor(t/1e3),n=Math.floor(e/60),o=Math.floor(n/60);let s;if(e<=30)s="Imminently";else if(n<1)s="1 min";else if(n<60)s=`${n} mins`;else if(1===o)s="About an hour";else if(o<3){s=`About ${Math.round(2*o)/2} hours`}else{s=`About ${Math.round(2*o)/2} hours`}setFieldValue("unbidden-ink-next-message",s)}}else setFieldValue("unbidden-ink-next-message",s?.enabled?"Unknown":"Disabled");if(setFieldValue("log-level",e.features?.logging?.level_name||"Unknown"),setFieldValue("serial-logging",e.features?.logging?.serial_enabled?"Enabled":"Disabled"),setFieldValue("web-logging",e.features?.logging?.betterstack_enabled?"Enabled":"Disabled"),setFieldValue("file-logging",e.features?.logging?.file_enabled?"Enabled":"Disabled"),setFieldValue("mqtt-logging",e.features?.logging?.mqtt_enabled?"Enabled":"Disabled"),e.features?.hardware_buttons){const t=e.features.hardware_buttons;if(setFieldValue("hw-buttons-count",t.num_buttons||"Unknown"),setFieldValue("hw-buttons-debounce",`${t.debounce_ms||"Unknown"} ms`),setFieldValue("hw-buttons-long-press",`${t.long_press_ms||"Unknown"} ms`),setFieldValue("hw-buttons-active-low",void 0!==t.active_low?t.active_low?"Yes":"No":"Unknown"),setFieldValue("hw-buttons-min-interval",`${t.min_interval_ms||"Unknown"} ms`),setFieldValue("hw-buttons-max-per-minute",t.max_per_minute||"Unknown"),t.buttons&&t.buttons.length>0){t.buttons.forEach((e,t)=>{const n=t+1;setFieldValue(`button-${n}-title`,`Button ${n} (GPIO ${e.gpio||"Unknown"})`),setFieldValue(`button-${n}-short-press`,e.short_endpoint||"Not configured"),setFieldValue(`button-${n}-long-press`,e.long_endpoint||"Not configured");const o=document.querySelector(`[data-field-container="button-${n}-short-mqtt"]`),s=document.querySelector(`[data-field-container="button-${n}-long-mqtt"]`);e.short_mqtt_topic?(setFieldValue(`button-${n}-short-mqtt`,e.short_mqtt_topic),o&&(o.style.display="flex")):o&&(o.style.display="none"),e.long_mqtt_topic?(setFieldValue(`button-${n}-long-mqtt`,e.long_mqtt_topic),s&&(s.style.display="flex")):s&&(s.style.display="none")});for(let e=t.buttons.length+1;e<=4;e++){const t=document.querySelector(`[data-button="${e}"]`);t&&(t.style.display="none")}for(let e=1;e<=t.buttons.length;e++){const t=document.querySelector(`[data-button="${e}"]`);t&&(t.style.display="block")}}else for(let e=1;e<=4;e++){const t=document.querySelector(`[data-button="${e}"]`);t&&(t.style.display="none")}}const a=document.getElementById("web-pages"),i=document.getElementById("api-endpoints");if(e.endpoints?.web_pages&&a)a.innerHTML="",e.endpoints.web_pages.forEach(e=>{const t=document.createElement("div");t.className="diag-row";const n=document.createElement("span");n.className="diag-label",n.textContent=e.path;const o=document.createElement("span");o.className="diag-value",o.textContent=e.description,t.appendChild(n),t.appendChild(o),a.appendChild(t)});else if(a){const e=a.querySelector(".loading-placeholder");e&&(e.querySelector(".diag-label").textContent="Loading web pages...",e.querySelector(".diag-value").textContent="-")}if(e.endpoints?.api_endpoints&&i){i.innerHTML="";const t={};e.endpoints.api_endpoints.forEach(e=>{t[e.method]||(t[e.method]=[]),t[e.method].push(e)}),Object.entries(t).forEach(([e,t])=>{const n=document.createElement("div");n.className="diag-row method-header";const o=document.createElement("span");o.className="diag-label font-semibold text-gray-700 dark:text-gray-300",o.textContent=`${e} Endpoints`;const s=document.createElement("span");s.className="diag-value font-semibold text-gray-700 dark:text-gray-300",s.textContent=`(${t.length})`,n.appendChild(o),n.appendChild(s),i.appendChild(n),t.forEach(e=>{const t=document.createElement("div");t.className="diag-row ml-4";const n=document.createElement("span");n.className="diag-label font-mono text-sm",n.textContent=e.path;const o=document.createElement("span");o.className="diag-value text-sm",o.textContent=e.description,t.appendChild(n),t.appendChild(o),i.appendChild(t)})})}else if(i){const e=i.querySelector(".loading-placeholder");e&&(e.querySelector(".diag-label").textContent="Loading API endpoints...",e.querySelector(".diag-value").textContent="-")}const r=document.getElementById("config-content");if(t&&r){const e=redactSecrets(t),n=JSON.stringify(e,null,2);r.innerHTML=highlightJSON(n)}else r&&(r.textContent="Configuration not available")}async function loadDiagnostics(){const e=document.getElementById("loading"),t=document.getElementById("error"),n=document.getElementById("diagnostics-content");e.style.display="block",t.classList.remove("show"),n.style.display="none";try{const[t,o]=await Promise.all([fetch("/api/diagnostics"),fetch("/api/config")]);if(!t.ok)throw new Error(`Diagnostics API error: HTTP ${t.status}: ${t.statusText}`);if(!o.ok)throw new Error(`Config API error: HTTP ${o.status}: ${o.statusText}`);const s=await t.json();displayDiagnostics(s,await o.json()),e.style.display="none",n.style.display="block",showSection(currentSection)}catch(n){console.error("Error loading diagnostics:",n),e.style.display="none",t.classList.add("show"),document.getElementById("error-message").textContent=n.message}}async function handleQuickAction(e){try{let t=`/api/${e}`;const n=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"}});if(!n.ok){return void showToast(`Error generating content: ${await n.text()}`,"error")}const o=await n.json();if(!o.content)return void showToast("No content received from server","error");const s=await fetch("/api/print-local",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:o.content})});if(s.ok)showToast(`${e} sent to printer successfully!`,"success");else{showToast(`Print error: ${await s.text()}`,"error")}}catch(e){console.error("Error sending quick action:",e),showToast(`Network error: ${e.message}`,"error")}}function showToast(e,t="info"){const n=document.createElement("div");n.textContent=e,n.className="fixed top-4 right-4 px-4 py-2 rounded-lg text-white z-50 "+("success"===t?"bg-green-500":"error"===t?"bg-red-500":"bg-blue-500"),document.body.appendChild(n),setTimeout(()=>{n.remove()},3e3)}