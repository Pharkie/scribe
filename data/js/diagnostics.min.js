function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function redactSecrets(e){const t=JSON.parse(JSON.stringify(e)),n=["password","pass","secret","token","key","apikey","api_key","auth","credential","cert","private","bearer","oauth"];return function e(t){if("object"!=typeof t||null===t)return t;for(const[s,o]of Object.entries(t)){const a=s.toLowerCase();n.some(e=>a.includes(e))&&"string"==typeof o&&o.length>0?t[s]=o.length>8?o.substring(0,2)+"●●●●●●●●"+o.substring(o.length-2):"●●●●●●●●":"object"==typeof o&&null!==o&&e(o)}}(t),t}let currentSection="device-config-section";function showSection(e){document.querySelectorAll('[id$="-section"]').forEach(e=>{e.classList.remove("show")}),document.querySelectorAll(".section-nav-btn").forEach(e=>{e.classList.remove("font-bold","ring-2")});const t=document.getElementById(e);t&&(t.classList.add("show"),currentSection=e);const n=event?.target;n&&n.classList.add("font-bold","ring-2")}function goBack(){window.location.href="/"}function copyGenericSection(e,t){try{const n=t.closest('[id$="-section"]');if(!n)throw new Error("Section not found");const s=n.querySelectorAll(".diag-row, .space-y-1 > div, .space-y-2 > div");let o=`=== ${e} ===\n\n`;s.forEach(e=>{const t=e.querySelector(".diag-label, .text-gray-600, .dark\\:text-gray-400"),n=e.querySelector(".diag-value, .font-medium, [data-field]");if(t&&n){const e=t.textContent?.trim().replace(/[:：]\s*$/,"")||"",s=n.textContent?.trim()||"";e&&s&&"-"!==s&&(o+=`${e}: ${s}\n`)}});n.querySelectorAll(".diag-reference-box, .bg-blue-100, .bg-green-100, .bg-orange-100").forEach(e=>{e.querySelectorAll("div:not(.space-y-1):not(.space-y-2)").forEach(e=>{const t=e.textContent?.trim();if(t&&!t.includes("Connect to this network")){const e=t.replace(/\s+/g," ").replace(/:\s+/g,": ");e.includes(":")&&(o+=`${e}\n`)}})}),navigator.clipboard.writeText(o.trim()).then(()=>{showCopySuccess(t)}).catch(e=>{console.error("Copy failed:",e),fallbackCopy(o.trim(),t)})}catch(e){console.error("Error copying section:",e)}}function copyConfigFile(e){try{const t=document.getElementById("config-content");if(!t)throw new Error("Config content not found");const n=`=== Configuration File (config.json) ===\n\n${t.textContent.trim()}`;navigator.clipboard.writeText(n).then(()=>{showCopySuccess(e)}).catch(t=>{console.error("Copy failed:",t),fallbackCopy(n,e)})}catch(e){console.error("Error copying config:",e)}}function showCopySuccess(e){const t=e.innerHTML;e.innerHTML='<span class="text-green-600">✓</span>',e.style.transform="scale(1.1)",setTimeout(()=>{e.innerHTML=t,e.style.transform="scale(1)"},1e3)}function fallbackCopy(e,t){const n=document.createElement("textarea");n.value=e,n.style.position="fixed",n.style.opacity="0",document.body.appendChild(n),n.select();try{document.execCommand("copy"),showCopySuccess(t)}catch(e){console.error("Fallback copy failed:",e)}document.body.removeChild(n)}function updateProgressBar(e,t){const n=document.querySelector(`[data-field="${e}"]`);n&&(n.style.width=Math.min(Math.max(t,0),100)+"%",t>90?n.classList.add("bg-red-500"):t>75?n.classList.add("bg-orange-600"):n.classList.add("bg-orange-500"))}function setFieldValue(e,t,n=!1){document.querySelectorAll(`[data-field="${e}"]`).forEach(e=>{n?e.innerHTML=t:e.textContent=t||"-"})}function formatBytes(e){if(0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["B","KB","MB","GB"][t]}function formatUptime(e){const t=Math.floor(e/86400),n=Math.floor(e%86400/3600),s=Math.floor(e%3600/60);return t>0?`${t}d ${n}h ${s}m`:n>0?`${n}h ${s}m`:`${s}m`}function displayDiagnostics(e){setFieldValue("device-owner",e.device_owner),setFieldValue("timezone",e.timezone),setFieldValue("mdns-hostname",e.mdns_hostname),setFieldValue("max-message-chars",e.max_message_chars),setFieldValue("wifi-status",e.wifi_status),setFieldValue("wifi-ssid",e.wifi_ssid),setFieldValue("ip-address",e.ip_address),setFieldValue("signal-strength",e.signal_strength),setFieldValue("mac-address",e.mac_address),setFieldValue("gateway",e.gateway),setFieldValue("dns",e.dns),setFieldValue("wifi-connect-timeout",e.wifi_connect_timeout+" seconds"),setFieldValue("mqtt-enabled",e.mqtt_enabled?"Yes":"No"),setFieldValue("mqtt-status",e.mqtt_status),setFieldValue("mqtt-broker",e.mqtt_broker),setFieldValue("mqtt-port",e.mqtt_port),setFieldValue("mqtt-username",e.mqtt_username),setFieldValue("mqtt-topic",e.mqtt_topic),setFieldValue("mqtt-keep-alive",e.mqtt_keep_alive+" seconds"),setFieldValue("cpu-frequency",e.cpu_frequency+" MHz"),setFieldValue("flash-size",formatBytes(e.flash_size)),setFieldValue("firmware-version",e.firmware_version),setFieldValue("uptime",formatUptime(e.uptime)),setFieldValue("free-heap",formatBytes(e.free_heap)),setFieldValue("temperature",e.temperature+"°C");const t=(e.flash_size-e.flash_free)/e.flash_size*100,n=(e.total_heap-e.free_heap)/e.total_heap*100;setFieldValue("flash-usage-text",`${formatBytes(e.flash_size-e.flash_free)} / ${formatBytes(e.flash_size)} (${t.toFixed(1)}%)`),setFieldValue("heap-usage-text",`${formatBytes(e.total_heap-e.free_heap)} / ${formatBytes(e.total_heap)} (${n.toFixed(1)}%)`),updateProgressBar("flash-usage-bar",t),updateProgressBar("heap-usage-bar",n),setFieldValue("unbidden-ink-enabled",e.unbidden_ink_enabled?"Yes":"No"),setFieldValue("unbidden-ink-interval",e.unbidden_ink_interval),setFieldValue("unbidden-ink-last-run",e.unbidden_ink_last_run||"Never"),setFieldValue("unbidden-ink-next-run",e.unbidden_ink_next_run||"Not scheduled"),setFieldValue("unbidden-ink-total-riddles",e.unbidden_ink_total_riddles),setFieldValue("unbidden-ink-current-index",e.unbidden_ink_current_index),setFieldValue("log-level",e.log_level),setFieldValue("serial-logging",e.serial_logging?"Enabled":"Disabled"),setFieldValue("web-logging",e.web_logging?"Enabled":"Disabled"),setFieldValue("file-logging",e.file_logging?"Enabled":"Disabled"),setFieldValue("log-buffer-size",e.log_buffer_size),setFieldValue("button-a-pin",e.button_a_pin||"Not configured"),setFieldValue("button-b-pin",e.button_b_pin||"Not configured"),setFieldValue("button-c-pin",e.button_c_pin||"Not configured"),setFieldValue("button-a-state",e.button_a_state||"Unknown"),setFieldValue("button-b-state",e.button_b_state||"Unknown"),setFieldValue("button-c-state",e.button_c_state||"Unknown");const s=document.getElementById("web-pages"),o=document.getElementById("api-endpoints");e.web_pages&&s&&(s.innerHTML=e.web_pages.map(e=>`<div class="flex justify-between"><span>${escapeHtml(e.path)}</span><span class="text-slate-600 dark:text-slate-400">${escapeHtml(e.description)}</span></div>`).join("")),e.api_endpoints&&o&&(o.innerHTML=e.api_endpoints.map(e=>`<div class="flex justify-between"><span class="font-mono text-sm">${escapeHtml(e.method)} ${escapeHtml(e.path)}</span><span class="text-slate-600 dark:text-slate-400">${escapeHtml(e.description)}</span></div>`).join(""));const a=document.getElementById("config-content");if(e.config_file&&a){const t=redactSecrets(e.config_file);a.textContent=JSON.stringify(t,null,2)}}function loadDiagnostics(){const e=document.getElementById("loading"),t=document.getElementById("error"),n=document.getElementById("diagnostics-content");e.style.display="block",t.classList.remove("show"),n.style.display="none",fetch("/api/diagnostics").then(e=>{if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);return e.json()}).then(t=>{displayDiagnostics(t),e.style.display="none",n.style.display="block",showSection(currentSection)}).catch(n=>{console.error("Error loading diagnostics:",n),e.style.display="none",t.classList.add("show"),document.getElementById("error-message").textContent=n.message})}document.addEventListener("DOMContentLoaded",()=>{loadDiagnostics(),showSection("device-config-section"),setInterval(loadDiagnostics,3e4)});