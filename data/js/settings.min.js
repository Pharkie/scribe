function toggleUnbiddenInkSettings(){const e=document.getElementById("unbidden-ink-enabled").checked,t=document.getElementById("unbidden-ink-settings"),n=document.getElementById("chatgpt-api-token");t&&(e?(t.style.display="block",n&&n.setAttribute("required","required")):(t.style.display="none",n&&n.removeAttribute("required")))}function goBack(){window.location.href="/"}function updateNextScheduledDisplay(e){const t=document.getElementById("next-scheduled");if(t&&e)try{const n=new Date(e);t.textContent=n.toLocaleString()}catch(n){console.error("Invalid date format:",e),t.textContent="Invalid date"}}function formatTime(e){return`${0===e?12:e>12?e-12:e}:00 ${e>=12?"PM":"AM"}`}function updateTimeRange(){const e=document.getElementById("time-start")?.value||8,t=document.getElementById("time-end")?.value||22,n=document.getElementById("start-time-display"),o=document.getElementById("end-time-display");n&&(n.textContent=formatTime(parseInt(e))),o&&(o.textContent=formatTime(parseInt(t)))}function initializeUI(){const e=document.getElementById("unbidden-ink-enabled");e&&e.addEventListener("change",toggleUnbiddenInkSettings);const t=document.getElementById("time-start"),n=document.getElementById("time-end");t&&n&&(t.addEventListener("input",updateTimeRange),n.addEventListener("input",updateTimeRange),updateTimeRange()),toggleUnbiddenInkSettings()}function validateForm(){const e=[],t=parseInt(document.getElementById("wifi-timeout").value);(isNaN(t)||t<5||t>120)&&e.push("WiFi timeout must be between 5 and 120 seconds");const n=parseInt(document.getElementById("mqtt-port").value);(isNaN(n)||n<1||n>65535)&&e.push("MQTT port must be between 1 and 65535");const o=parseInt(document.getElementById("max-characters").value);(isNaN(o)||o<50||o>2e3)&&e.push("Max characters must be between 50 and 2000");const i=parseInt(document.getElementById("frequency-minutes").value);return(isNaN(i)||i<5||i>1440)&&e.push("Unbidden Ink frequency must be between 5 and 1440 minutes"),{isValid:0===e.length,errors:e}}function showValidationErrors(e){const t="Please fix the following errors:\n\n"+e.join("\n");window.SettingsCore&&window.SettingsCore.showMessage?window.SettingsCore.showMessage(t,"error"):alert(t)}function resetForm(){confirm("Are you sure you want to reset all settings to defaults? This cannot be undone.")&&(document.querySelectorAll('input[type="text"], input[type="number"], input[type="password"], textarea').forEach(e=>{e.value=""}),document.querySelectorAll('input[type="checkbox"]').forEach(e=>{e.checked=!1}),window.SettingsCore&&window.SettingsCore.showMessage&&window.SettingsCore.showMessage("Form reset to defaults","info"))}window.SettingsUtils={toggleUnbiddenInkSettings:toggleUnbiddenInkSettings,goBack:goBack,updateNextScheduledDisplay:updateNextScheduledDisplay,formatTime:formatTime,updateTimeRange:updateTimeRange,initializeUI:initializeUI,validateForm:validateForm,showValidationErrors:showValidationErrors,resetForm:resetForm};let currentConfig={};async function loadConfiguration(){try{console.log("Settings: Loading configuration from API...");const e=await fetch("/api/config");if(!e.ok)throw new Error(`Config API returned ${e.status}: ${e.statusText}`);const t=await e.json();return console.log("Settings: Configuration loaded successfully"),populateForm(t),t}catch(e){throw console.error("Settings: Failed to load configuration:",e),showMessage("Failed to load settings: "+e.message,"error"),e}}function populateForm(e){document.getElementById("device-owner").value=e.device?.owner||"",document.getElementById("timezone").value=e.device?.timezone||"",document.getElementById("wifi-ssid").value=e.wifi?.ssid||"",document.getElementById("wifi-password").value=e.wifi?.password||"",document.getElementById("wifi-timeout").value=(e.wifi?.connect_timeout||15e3)/1e3,document.getElementById("mqtt-enabled").checked=e.mqtt?.enabled||!1,document.getElementById("mqtt-server").value=e.mqtt?.server||"",document.getElementById("mqtt-port").value=e.mqtt?.port||1883,document.getElementById("mqtt-username").value=e.mqtt?.username||"",document.getElementById("mqtt-password").value=e.mqtt?.password||"",document.getElementById("max-characters").value=e.validation?.maxCharacters||500,document.getElementById("chatgpt-api-token").value=e.apis?.chatgptApiToken||"";const t=document.getElementById("unbidden-ink-enabled");t&&(t.checked=e.unbiddenInk?.enabled||!1);const n=document.getElementById("time-start"),o=document.getElementById("time-end");n&&o&&(n.value=e.unbiddenInk?.startHour||8,o.value=e.unbiddenInk?.endHour||22,"function"==typeof updateTimeRange&&updateTimeRange()),document.getElementById("frequency-minutes").value=e.unbiddenInk?.frequencyMinutes||60,document.getElementById("unbidden-ink-prompt").value=e.unbiddenInk?.prompt||"";for(let t=0;t<4;t++){const n=t+1,o=document.getElementById(`button${n}-short`),i=document.getElementById(`button${n}-long`);o&&(o.value=e.buttons?.[`button${n}`]?.shortAction||""),i&&(i.value=e.buttons?.[`button${n}`]?.longAction||"");const s=document.getElementById(`button${n}-short-mqtt-topic`),a=document.getElementById(`button${n}-long-mqtt-topic`);s&&(s.value=e.buttons?.[`button${n}`]?.shortMqttTopic||""),a&&(a.value=e.buttons?.[`button${n}`]?.longMqttTopic||"")}window.LEDConfig&&window.LEDConfig.populateLedForm&&window.LEDConfig.populateLedForm(e),updateNextScheduledDisplay(e.status?.unbiddenInk?.nextScheduled)}function collectFormData(){const e={device:{owner:document.getElementById("device-owner").value,timezone:document.getElementById("timezone").value},wifi:{ssid:document.getElementById("wifi-ssid").value,password:document.getElementById("wifi-password").value,connect_timeout:1e3*parseInt(document.getElementById("wifi-timeout").value)},mqtt:{enabled:document.getElementById("mqtt-enabled").checked,server:document.getElementById("mqtt-server").value,port:parseInt(document.getElementById("mqtt-port").value),username:document.getElementById("mqtt-username").value,password:document.getElementById("mqtt-password").value},validation:{maxCharacters:parseInt(document.getElementById("max-characters").value)},apis:{chatgptApiToken:document.getElementById("chatgpt-api-token").value},unbiddenInk:{enabled:document.getElementById("unbidden-ink-enabled").checked,startHour:parseInt(document.getElementById("time-start").value),endHour:parseInt(document.getElementById("time-end").value),frequencyMinutes:parseInt(document.getElementById("frequency-minutes").value),prompt:document.getElementById("unbidden-ink-prompt").value},buttons:{}};for(let t=0;t<4;t++){const n=t+1,o=`button${n}`,i=document.getElementById(`button${n}-short`),s=document.getElementById(`button${n}-long`);e.buttons[o]={shortAction:i?i.value:"",longAction:s?s.value:"",shortMqttTopic:"",longMqttTopic:""}}return window.LEDConfig&&window.LEDConfig.collectLedFormData&&(e.leds=window.LEDConfig.collectLedFormData()),e}async function saveSettings(e){e.preventDefault();try{const e=collectFormData();if(window.LEDConfig&&window.LEDConfig.validateLedConfig){const t=window.LEDConfig.validateLedConfig(e.leds);if(!t.isValid)return void showMessage(t.error,"error")}const t=await fetch("/api/config",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){const e=await t.text();throw new Error(`Server error: ${t.status} - ${e}`)}await t.text();showMessage("Settings saved successfully!","success"),currentConfig=e}catch(e){console.error("Settings: Failed to save configuration:",e),showMessage("Failed to save settings: "+e.message,"error")}}function showMessage(e,t){window.showToast?window.showToast(e,t):"error"===t?alert("Error: "+e):"success"===t?console.log("Success: "+e):console.log(t+": "+e)}function colorToHtml(e,t){const n=e||t;return n.length>7?n.substring(0,7):n}function colorToRgba(e){return 7===e.length?e+"ff":e}function populateLedForm(e){if(!e.leds)return;const t=document.getElementById("led-pin"),n=document.getElementById("led-count"),o=document.getElementById("led-brightness"),i=document.getElementById("led-refresh-rate");t&&(t.value=e.leds.pin||4),n&&(n.value=e.leds.count||30),o&&(o.value=e.leds.brightness||64),i&&(i.value=e.leds.refreshRate||60);const s=e.leds.effects||{},a=s.chaseSingle||{},d={speed:document.getElementById("chase-single-speed"),trailLength:document.getElementById("chase-single-trail-length"),trailFade:document.getElementById("chase-single-trail-fade"),color:document.getElementById("chase-single-color")};d.speed&&(d.speed.value=a.speed||5),d.trailLength&&(d.trailLength.value=a.trailLength||15),d.trailFade&&(d.trailFade.value=a.trailFade||15),d.color&&(d.color.value=colorToHtml(a.defaultColor,"#0062ff"));const r=s.chaseMulti||{},l={speed:document.getElementById("chase-multi-speed"),trailLength:document.getElementById("chase-multi-trail-length"),trailFade:document.getElementById("chase-multi-trail-fade"),colorSpacing:document.getElementById("chase-multi-color-spacing"),color1:document.getElementById("chase-multi-color1"),color2:document.getElementById("chase-multi-color2"),color3:document.getElementById("chase-multi-color3")};l.speed&&(l.speed.value=r.speed||2),l.trailLength&&(l.trailLength.value=r.trailLength||20),l.trailFade&&(l.trailFade.value=r.trailFade||20),l.colorSpacing&&(l.colorSpacing.value=r.colorSpacing||12),l.color1&&(l.color1.value=colorToHtml(r.color1,"#ff9900")),l.color2&&(l.color2.value=colorToHtml(r.color2,"#008f00")),l.color3&&(l.color3.value=colorToHtml(r.color3,"#78cffe"));const u=s.matrix||{},c={speed:document.getElementById("matrix-speed"),drops:document.getElementById("matrix-drops"),backgroundFade:document.getElementById("matrix-background-fade"),trailFade:document.getElementById("matrix-trail-fade"),brightnessFade:document.getElementById("matrix-brightness-fade"),color:document.getElementById("matrix-color")};c.speed&&(c.speed.value=u.speed||3),c.drops&&(c.drops.value=u.drops||5),c.backgroundFade&&(c.backgroundFade.value=u.backgroundFade||64),c.trailFade&&(c.trailFade.value=u.trailFade||32),c.brightnessFade&&(c.brightnessFade.value=u.brightnessFade||40),c.color&&(c.color.value=colorToHtml(u.defaultColor,"#009100"));const g=s.twinkle||{},m={density:document.getElementById("twinkle-density"),fadeSpeed:document.getElementById("twinkle-fade-speed"),minBrightness:document.getElementById("twinkle-min-brightness"),maxBrightness:document.getElementById("twinkle-max-brightness"),color:document.getElementById("twinkle-color")};m.density&&(m.density.value=g.density||8),m.fadeSpeed&&(m.fadeSpeed.value=g.fadeSpeed||5),m.minBrightness&&(m.minBrightness.value=g.minBrightness||50),m.maxBrightness&&(m.maxBrightness.value=g.maxBrightness||255),m.color&&(m.color.value=colorToHtml(g.defaultColor,"#ffffff"));const w=s.pulse||{},p={speed:document.getElementById("pulse-speed"),minBrightness:document.getElementById("pulse-min-brightness"),maxBrightness:document.getElementById("pulse-max-brightness"),waveFrequency:document.getElementById("pulse-wave-frequency"),color:document.getElementById("pulse-color")};p.speed&&(p.speed.value=w.speed||4),p.minBrightness&&(p.minBrightness.value=w.minBrightness||0),p.maxBrightness&&(p.maxBrightness.value=w.maxBrightness||255),p.waveFrequency&&(p.waveFrequency.value=w.waveFrequency||.05),p.color&&(p.color.value=colorToHtml(w.defaultColor,"#ff00f2"));const f=s.rainbow||{},h={speed:document.getElementById("rainbow-speed"),saturation:document.getElementById("rainbow-saturation"),brightness:document.getElementById("rainbow-brightness"),hueStep:document.getElementById("rainbow-hue-step")};h.speed&&(h.speed.value=f.speed||2),h.saturation&&(h.saturation.value=f.saturation||255),h.brightness&&(h.brightness.value=f.brightness||255),h.hueStep&&(h.hueStep.value=f.hueStep||2.5)}function collectLedFormData(){return{pin:parseInt(document.getElementById("led-pin").value),count:parseInt(document.getElementById("led-count").value),brightness:parseInt(document.getElementById("led-brightness").value),refreshRate:parseInt(document.getElementById("led-refresh-rate").value),effects:{chaseSingle:{speed:parseInt(document.getElementById("chase-single-speed").value),trailLength:parseInt(document.getElementById("chase-single-trail-length").value),trailFade:parseInt(document.getElementById("chase-single-trail-fade").value),defaultColor:colorToRgba(document.getElementById("chase-single-color").value)},chaseMulti:{speed:parseInt(document.getElementById("chase-multi-speed").value),trailLength:parseInt(document.getElementById("chase-multi-trail-length").value),trailFade:parseInt(document.getElementById("chase-multi-trail-fade").value),colorSpacing:parseInt(document.getElementById("chase-multi-color-spacing").value),color1:colorToRgba(document.getElementById("chase-multi-color1").value),color2:colorToRgba(document.getElementById("chase-multi-color2").value),color3:colorToRgba(document.getElementById("chase-multi-color3").value)},matrix:{speed:parseInt(document.getElementById("matrix-speed").value),drops:parseInt(document.getElementById("matrix-drops").value),backgroundFade:parseInt(document.getElementById("matrix-background-fade").value),trailFade:parseInt(document.getElementById("matrix-trail-fade").value),brightnessFade:parseInt(document.getElementById("matrix-brightness-fade").value),defaultColor:colorToRgba(document.getElementById("matrix-color").value)},twinkle:{density:parseInt(document.getElementById("twinkle-density").value),fadeSpeed:parseInt(document.getElementById("twinkle-fade-speed").value),minBrightness:parseInt(document.getElementById("twinkle-min-brightness").value),maxBrightness:parseInt(document.getElementById("twinkle-max-brightness").value),defaultColor:document.getElementById("twinkle-color").value},pulse:{speed:parseInt(document.getElementById("pulse-speed").value),minBrightness:parseInt(document.getElementById("pulse-min-brightness").value),maxBrightness:parseInt(document.getElementById("pulse-max-brightness").value),waveFrequency:parseFloat(document.getElementById("pulse-wave-frequency").value),defaultColor:colorToRgba(document.getElementById("pulse-color").value)},rainbow:{speed:parseFloat(document.getElementById("rainbow-speed").value),saturation:parseInt(document.getElementById("rainbow-saturation").value),brightness:parseInt(document.getElementById("rainbow-brightness").value),hueStep:parseFloat(document.getElementById("rainbow-hue-step").value)}}}}function validateLedConfig(e){if(e.pin<0||e.pin>10)return{isValid:!1,error:"LED pin must be between 0 and 10 (ESP32-C3 compatible)"};if(e.count<1||e.count>300)return{isValid:!1,error:"LED count must be between 1 and 300"};if(e.brightness<0||e.brightness>255)return{isValid:!1,error:"LED brightness must be between 0 and 255"};if(e.refreshRate<10||e.refreshRate>120)return{isValid:!1,error:"LED refresh rate must be between 10 and 120 Hz"};const t=e.effects;return t.chaseSingle.speed<1||t.chaseSingle.speed>100?{isValid:!1,error:"Chase Single speed must be between 1 and 100"}:t.chaseMulti.speed<1||t.chaseMulti.speed>100?{isValid:!1,error:"Chase Multi speed must be between 1 and 100"}:t.matrix.drops<1||t.matrix.drops>20?{isValid:!1,error:"Matrix drops must be between 1 and 20"}:t.twinkle.density<1||t.twinkle.density>20?{isValid:!1,error:"Twinkle density must be between 1 and 20"}:t.twinkle.fadeSpeed<1||t.twinkle.fadeSpeed>255?{isValid:!1,error:"Twinkle fade speed must be between 1 and 255"}:{isValid:!0}}async function initializeSettings(){try{await waitForModules(),window.SettingsUtils&&window.SettingsUtils.initializeUI&&window.SettingsUtils.initializeUI(),window.SettingsCore&&window.SettingsCore.loadConfiguration&&await window.SettingsCore.loadConfiguration();const e=document.getElementById("settings-form");e&&window.SettingsCore&&window.SettingsCore.saveSettings&&e.addEventListener("submit",window.SettingsCore.saveSettings),hideLoadingState(),console.log("Settings page initialized successfully")}catch(e){console.error("Failed to initialize settings page:",e),window.SettingsCore&&window.SettingsCore.showMessage&&window.SettingsCore.showMessage("Failed to initialize settings page: "+e.message,"error")}}async function waitForModules(){let e=0;for(;e<5e3;){if(window.SettingsCore&&window.LEDConfig&&window.SettingsUtils)return;await new Promise(e=>setTimeout(e,100)),e+=100}throw new Error("Timeout waiting for settings modules to load")}async function loadConfiguration(){if(window.SettingsCore&&window.SettingsCore.loadConfiguration)return window.SettingsCore.loadConfiguration()}function hideLoadingState(){const e=document.getElementById("loading-state"),t=document.getElementById("settings-navigation"),n=document.getElementById("settings-form");e&&(e.style.display="none"),t&&t.classList.remove("hidden"),n&&(n.classList.remove("hidden"),showSettingsSection("wifi"))}function showSettingsSection(e){document.querySelectorAll(".settings-section").forEach(e=>{e.classList.add("hidden")});const t=document.getElementById(`${e}-section`);t&&t.classList.remove("hidden");document.querySelectorAll(".section-nav-btn").forEach(e=>{e.classList.remove("active")});const n=document.querySelector(`[onclick="showSettingsSection('${e}')"]`);n&&n.classList.add("active")}async function saveSettings(e){if(window.SettingsCore&&window.SettingsCore.saveSettings)return window.SettingsCore.saveSettings(e)}async function triggerLedEffect(e){try{const t=await fetch("/api/led-effect",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({effect:e,duration:1e4})});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);await t.json();window.SettingsCore&&window.SettingsCore.showMessage&&window.SettingsCore.showMessage(`${e} effect triggered successfully!`,"success")}catch(t){console.error("Failed to trigger LED effect:",t),window.SettingsCore&&window.SettingsCore.showMessage&&window.SettingsCore.showMessage(`Failed to trigger ${e} effect: ${t.message}`,"error")}}async function turnOffLeds(){try{const e=await fetch("/api/leds-off",{method:"POST",headers:{"Content-Type":"application/json"}});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);await e.json();window.SettingsCore&&window.SettingsCore.showMessage&&window.SettingsCore.showMessage("LEDs turned off successfully!","success")}catch(e){console.error("Failed to turn off LEDs:",e),window.SettingsCore&&window.SettingsCore.showMessage&&window.SettingsCore.showMessage(`Failed to turn off LEDs: ${e.message}`,"error")}}async function saveSettings(e){if(window.SettingsCore&&window.SettingsCore.saveSettings)return window.SettingsCore.saveSettings(e)}function showMessage(e,t){if(window.SettingsCore&&window.SettingsCore.showMessage)return window.SettingsCore.showMessage(e,t)}function toggleUnbiddenInkSettings(){if(window.SettingsUtils&&window.SettingsUtils.toggleUnbiddenInkSettings)return window.SettingsUtils.toggleUnbiddenInkSettings()}function goBack(){if(window.SettingsUtils&&window.SettingsUtils.goBack)return window.SettingsUtils.goBack()}function updateTimeRange(){if(window.SettingsUtils&&window.SettingsUtils.updateTimeRange)return window.SettingsUtils.updateTimeRange()}window.SettingsCore={loadConfiguration:loadConfiguration,populateForm:populateForm,collectFormData:collectFormData,saveSettings:saveSettings,showMessage:showMessage,getCurrentConfig:()=>currentConfig},window.LEDConfig={populateLedForm:populateLedForm,collectLedFormData:collectLedFormData,validateLedConfig:validateLedConfig,colorToHtml:colorToHtml,colorToRgba:colorToRgba},window.showSettingsSection=showSettingsSection,window.hideLoadingState=hideLoadingState,window.saveSettings=saveSettings,window.triggerLedEffect=triggerLedEffect,window.turnOffLeds=turnOffLeds,window.toggleUnbiddenInkSettings=toggleUnbiddenInkSettings,window.goBack=goBack,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initializeSettings):initializeSettings();