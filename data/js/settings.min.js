let currentConfig={};async function loadConfiguration(){try{let e;window.GLOBAL_CONFIG&&0!==Object.keys(window.GLOBAL_CONFIG).length?e=window.GLOBAL_CONFIG:(console.log("Waiting for global config to load..."),e=await new Promise((e,t)=>{const n=setTimeout(()=>{t(new Error("Global config not loaded within timeout - please refresh the page"))},1e4),o=t=>{clearTimeout(n),window.removeEventListener("configLoaded",o),e(t.detail)};if(window.GLOBAL_CONFIG&&Object.keys(window.GLOBAL_CONFIG).length>0)return clearTimeout(n),void e(window.GLOBAL_CONFIG);window.addEventListener("configLoaded",o)})),currentConfig=e,populateForm(e),document.getElementById("loading-state").classList.add("hidden"),document.getElementById("settings-navigation").classList.remove("hidden"),document.getElementById("settings-form").classList.remove("hidden"),showSettingsSection("wifi")}catch(e){console.error("Error loading configuration:",e),showMessage("Failed to load configuration. Please refresh the page.","error")}}function populateForm(e){document.getElementById("wifi-ssid").value=e.wifi?.ssid||"",document.getElementById("wifi-password").value=e.wifi?.password||"",document.getElementById("wifi-timeout").value=e.wifi?.connect_timeout?e.wifi.connect_timeout/1e3:15,document.getElementById("device-owner").value=e.device?.owner||"",document.getElementById("timezone").value=e.device?.timezone||"",document.getElementById("mqtt-server").value=e.mqtt?.server||"",document.getElementById("mqtt-port").value=e.mqtt?.port||8883,document.getElementById("mqtt-username").value=e.mqtt?.username||"",document.getElementById("mqtt-password").value=e.mqtt?.password||"",document.getElementById("chatgpt-api-token").value=e.apis?.chatgptApiToken||"",document.getElementById("max-characters").value=e.validation?.maxCharacters||1e3;const t=document.getElementById("unbidden-ink-enabled");t&&(t.checked=e.unbiddenInk?.enabled||!1);const n=document.getElementById("time-start"),o=document.getElementById("time-end");n&&o&&(n.value=e.unbiddenInk?.startHour||8,o.value=e.unbiddenInk?.endHour||22,"function"==typeof updateTimeRange&&updateTimeRange(),setTimeout(()=>{"function"==typeof updateClickAreas&&updateClickAreas()},100));const d=document.getElementById("frequency-minutes");if(d){const t=e.unbiddenInk?.frequencyMinutes||60;d.value=t,"function"==typeof updateSliderFromFrequency&&updateSliderFromFrequency(t),"function"==typeof updateFrequencyDisplay&&updateFrequencyDisplay()}const a=document.getElementById("unbidden-ink-prompt");a&&(a.value=e.unbiddenInk?.prompt||""),toggleUnbiddenInkSettings(),document.getElementById("button1-short").value=e.buttons?.button1?.shortAction||"/api/joke",document.getElementById("button1-long").value=e.buttons?.button1?.longAction||"",document.getElementById("button1-short-mqtt").value=e.buttons?.button1?.shortMqttTopic||"",document.getElementById("button1-long-mqtt").value=e.buttons?.button1?.longMqttTopic||"",document.getElementById("button2-short").value=e.buttons?.button2?.shortAction||"/api/riddle",document.getElementById("button2-long").value=e.buttons?.button2?.longAction||"",document.getElementById("button2-short-mqtt").value=e.buttons?.button2?.shortMqttTopic||"",document.getElementById("button2-long-mqtt").value=e.buttons?.button2?.longMqttTopic||"",document.getElementById("button3-short").value=e.buttons?.button3?.shortAction||"/api/quote",document.getElementById("button3-long").value=e.buttons?.button3?.longAction||"",document.getElementById("button3-short-mqtt").value=e.buttons?.button3?.shortMqttTopic||"",document.getElementById("button3-long-mqtt").value=e.buttons?.button3?.longMqttTopic||"",document.getElementById("button4-short").value=e.buttons?.button4?.shortAction||"/api/quiz",document.getElementById("button4-long").value=e.buttons?.button4?.longAction||"",document.getElementById("button4-short-mqtt").value=e.buttons?.button4?.shortMqttTopic||"",document.getElementById("button4-long-mqtt").value=e.buttons?.button4?.longMqttTopic||"",e.leds&&(document.getElementById("led-pin").value=e.leds.pin||4,document.getElementById("led-count").value=e.leds.count||30,document.getElementById("led-brightness").value=e.leds.brightness||64,document.getElementById("led-refresh-rate").value=e.leds.refreshRate||60,document.getElementById("led-fade-speed").value=e.leds.effectFadeSpeed||5,document.getElementById("led-twinkle-density").value=e.leds.twinkleDensity||8,document.getElementById("led-chase-speed").value=e.leds.chaseSpeed||3,document.getElementById("led-matrix-drops").value=e.leds.matrixDrops||5),updateNextScheduledDisplay(e.status?.unbiddenInk?.nextScheduled)}function collectFormData(){return{device:{owner:document.getElementById("device-owner").value,timezone:document.getElementById("timezone").value},wifi:{ssid:document.getElementById("wifi-ssid").value,password:document.getElementById("wifi-password").value,connect_timeout:1e3*parseInt(document.getElementById("wifi-timeout").value)},mqtt:{server:document.getElementById("mqtt-server").value,port:parseInt(document.getElementById("mqtt-port").value),username:document.getElementById("mqtt-username").value,password:document.getElementById("mqtt-password").value},apis:{chatgptApiToken:document.getElementById("chatgpt-api-token").value},validation:{maxCharacters:parseInt(document.getElementById("max-characters").value)},unbiddenInk:{enabled:document.getElementById("unbidden-ink-enabled").checked,startHour:parseInt(document.getElementById("time-start")?.value||document.getElementById("start-hour")?.value||8),endHour:parseInt(document.getElementById("time-end")?.value||document.getElementById("end-hour")?.value||22),frequencyMinutes:parseInt(document.getElementById("frequency-minutes").value),prompt:document.getElementById("unbidden-ink-prompt").value},buttons:{button1:{shortAction:document.getElementById("button1-short").value,longAction:document.getElementById("button1-long").value,shortMqttTopic:document.getElementById("button1-short-mqtt").value,longMqttTopic:document.getElementById("button1-long-mqtt").value},button2:{shortAction:document.getElementById("button2-short").value,longAction:document.getElementById("button2-long").value,shortMqttTopic:document.getElementById("button2-short-mqtt").value,longMqttTopic:document.getElementById("button2-long-mqtt").value},button3:{shortAction:document.getElementById("button3-short").value,longAction:document.getElementById("button3-long").value,shortMqttTopic:document.getElementById("button3-short-mqtt").value,longMqttTopic:document.getElementById("button3-long-mqtt").value},button4:{shortAction:document.getElementById("button4-short").value,longAction:document.getElementById("button4-long").value,shortMqttTopic:document.getElementById("button4-short-mqtt").value,longMqttTopic:document.getElementById("button4-long-mqtt").value}},leds:{pin:parseInt(document.getElementById("led-pin").value),count:parseInt(document.getElementById("led-count").value),brightness:parseInt(document.getElementById("led-brightness").value),refreshRate:parseInt(document.getElementById("led-refresh-rate").value),effectFadeSpeed:parseInt(document.getElementById("led-fade-speed").value),twinkleDensity:parseInt(document.getElementById("led-twinkle-density").value),chaseSpeed:parseInt(document.getElementById("led-chase-speed").value),matrixDrops:parseInt(document.getElementById("led-matrix-drops").value)}}}async function saveSettings(e){e.preventDefault();try{const e=collectFormData(),t=await fetch("/api/config",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),n=await t.json();if(!t.ok||!n.success)throw new Error(n.error||"Failed to save settings");currentConfig=e,setTimeout(()=>{window.location.href="/?settings_saved=true"},100)}catch(e){console.error("Error saving settings:",e),showMessage(`Failed to save settings: ${e.message}`,"error")}}function showMessage(e,t){const n=document.getElementById("message-container"),o=document.createElement("div");o.className="p-4 rounded-lg shadow-lg mb-4 transition-all duration-300 "+("success"===t?"bg-green-100 text-green-800 border border-green-200":"bg-red-100 text-red-800 border border-red-200"),o.innerHTML=`\n        <div class="flex items-center space-x-2">\n            ${e.match(/^[\u{1F000}-\u{1F9FF}]|^[\u{2600}-\u{26FF}]/u)?"":`<span class="text-xl">${"success"===t?"✅":"❌"}</span>`}\n            <span>${e}</span>\n            <button onclick="this.parentElement.parentElement.remove()" class="ml-auto text-lg font-bold opacity-50 hover:opacity-100">×</button>\n        </div>\n    `,n.appendChild(o),setTimeout(()=>{o.parentElement&&o.remove()},5e3)}function toggleUnbiddenInkSettings(){const e=document.getElementById("unbidden-ink-enabled").checked,t=document.getElementById("unbidden-ink-settings");if(t)if(e)t.classList.remove("hidden"),t.querySelectorAll("input, textarea").forEach(e=>{e.removeAttribute("disabled")}),window.GLOBAL_CONFIG?.status?.unbiddenInk?.nextScheduled&&updateNextScheduledDisplay(window.GLOBAL_CONFIG.status.unbiddenInk.nextScheduled);else{t.classList.add("hidden"),t.querySelectorAll("input, textarea").forEach(e=>{e.setAttribute("disabled","disabled")});const e=document.getElementById("next-scheduled");e&&(e.style.display="none")}else console.warn("unbidden-ink-settings element not found")}function goBack(){window.location.href="/"}function setupAPModeUI(){if("192.168.4.1"===window.location.hostname||"scribe-setup"===window.location.hostname){console.log("AP mode detected - adjusting UI");const e=document.getElementById("save-button");e&&(e.textContent="Save and Reboot");const t=document.getElementById("close-button");t&&(t.style.display="none"),e&&(e.classList.remove("flex-1"),e.classList.add("w-full"))}}function updateClickAreas(){const e=document.getElementById("time-start"),t=document.getElementById("time-end"),n=document.getElementById("click-area-start"),o=document.getElementById("click-area-end");if(!(e&&t&&n&&o))return;const d=parseInt(e.value),a=parseInt(t.value),s=(e.offsetWidth,d/24*100),u=(a+1)/24*100,l=(s+u)/2,i=Math.max(0,s-7.5),r=Math.min(l-1,s+7.5);n.style.left=i+"%",n.style.width=r-i+"%";const c=Math.max(l+1,u-7.5),m=Math.min(100,u+7.5);o.style.left=c+"%",o.style.width=m-c+"%"}function handleSliderClick(e,t){const n=document.getElementById("time-start"),o=document.getElementById("time-end");if(!n||!o)return;const d=e.currentTarget.getBoundingClientRect(),a=(e.clientX-d.left)/d.width*100,s=Math.round(a/100*24);if("start"===t){const e=Math.max(0,Math.min(24,s)),t=parseInt(o.value);if(e>=t&&(0!==e||0!==t)){if(!(t<24))return n.value=t-1,updateTimeRange(n,"start"),void updateClickAreas();o.value=e+1}n.value=e,updateTimeRange(n,"start")}else if("end"===t){const e=Math.max(0,Math.min(24,s)),t=parseInt(n.value);if(e<=t&&(0!==t||0!==e)){if(!(t>0))return o.value=t+1,updateTimeRange(o,"end"),void updateClickAreas();n.value=e-1}o.value=e,updateTimeRange(o,"end")}updateClickAreas()}function updateTimeRange(e,t){const n=document.getElementById("time-start"),o=document.getElementById("time-end");if(!n||!o)return;let d=parseInt(n.value),a=parseInt(o.value);0===d&&0===a||("start"===t?d>=a&&(a<24?(a=d+1,o.value=a):(d=23,n.value=d)):"end"===t&&a<=d&&(d>0?(d=a-1,n.value=d):(a=1,o.value=a))),d=parseInt(n.value),a=parseInt(o.value);const s=document.getElementById("time-track");if(s)if(0===d&&0===a)s.style.left="0%",s.style.width="100%";else{const e=d/24*100,t=a/24*100;s.style.left=e+"%",s.style.width=t-e+"%"}const u=document.getElementById("time-display-start"),l=document.getElementById("time-display-end"),i=e=>24===e?"00:00":String(e).padStart(2,"0")+":00";u&&(u.textContent=i(d)),l&&(l.textContent=i(a)),updateClickAreas(),"function"==typeof updateFrequencyDisplay&&updateFrequencyDisplay()}function updateFrequencyFromSlider(e){const t=[15,30,45,60,120,240,360,480][parseInt(e)],n=document.getElementById("frequency-minutes");n&&(n.value=t,updateFrequencyDisplay())}function updateSliderFromFrequency(e){const t=[15,30,45,60,120,240,360,480].indexOf(parseInt(e)),n=document.getElementById("frequency-slider");n&&-1!==t&&(n.value=t)}function setFrequency(e){const t=document.getElementById("frequency-minutes");t&&(t.value=e,updateFrequencyDisplay(),updateSliderFromFrequency(e))}function updateFrequencyDisplay(){const e=document.getElementById("frequency-minutes"),t=document.getElementById("frequency-display"),n=document.getElementById("time-start"),o=document.getElementById("time-end");if(!(e&&t&&n&&o))return;const d=parseInt(e.value),a=parseInt(n.value),s=parseInt(o.value),u=e=>0===e||24===e?"12 am":e<12?`${e} am`:12===e?"12 pm":e-12+" pm",l=u(a),i=u(s);let r;if(d<60)r=`Around every ${d} minutes from ${l} to ${i} each day`;else{const e=d/60;r=1===e?`Around once per hour from ${l} to ${i} each day`:`Around once every ${e} hours from ${l} to ${i} each day`}t.textContent=r}function setPrompt(e){const t=document.getElementById("unbidden-ink-prompt");t&&(t.value=e,t.dispatchEvent(new Event("input")))}function bringSliderToFront(e){const t=document.getElementById("time-start"),n=document.getElementById("time-end");t&&n&&(t.style.zIndex="20",n.style.zIndex="20",e.style.zIndex="30")}async function testUnbiddenInk(){const e=event.target,t=e.textContent;try{if(!document.getElementById("chatgpt-api-token").value.trim())return void showMessage("Please configure your ChatGPT API Token first. You can get one from https://platform.openai.com/api-keys","error");if(!document.getElementById("unbidden-ink-enabled").checked)return void showMessage("Please enable Unbidden Ink first before testing.","error");const t=document.getElementById("unbidden-ink-prompt").value.trim();if(!t)return void showMessage("Please enter a prompt in the Custom Prompt field before testing.","error");e.disabled=!0,e.textContent="Generating...";const n=await fetch("/api/unbidden-ink",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:t})});if(!n.ok){let e=(await n.json().catch(()=>({}))).error||`HTTP ${n.status}: ${n.statusText}`;throw 500===n.status&&e.includes("Failed to generate")&&(e="Failed to generate content. Please check that your ChatGPT API Token is valid and you have sufficient API credits. You can check your account at https://platform.openai.com/account"),new Error(e)}const o=await n.json();if(!o.content)throw new Error(o.error||"No content generated");await new Promise(e=>setTimeout(e,100));try{const e=await fetch("/api/print-local",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:o.content})});if(!e.ok){const t=await e.json().catch(()=>({}));throw new Error(t.error||`Print failed: HTTP ${e.status}`)}showMessage("Unbidden Ink generated and printed successfully","success")}catch(e){console.error("Failed to print generated content:",e),showMessage(`Unbidden Ink generated but failed to print: ${e.message}`,"error")}}catch(e){console.error("Failed to test Unbidden Ink:",e),showMessage(`Failed to test Unbidden Ink: ${e.message}`,"error")}finally{e.disabled=!1,e.textContent=t}}function updateNextScheduledDisplay(e){const t=document.getElementById("next-scheduled");t&&(e&&"-"!==e?(t.textContent=`Next: ${e}`,t.style.display="block"):t.style.display="none")}function showSettingsSection(e){document.querySelectorAll(".settings-section").forEach(e=>{e.classList.add("hidden")});const t=document.getElementById(`${e}-section`);t&&t.classList.remove("hidden");const n=document.querySelectorAll(".section-nav-btn");n.forEach(e=>{e.classList.remove("active")});const o=Array.from(n).find(t=>t.onclick&&t.onclick.toString().includes(`'${e}'`));o&&o.classList.add("active")}async function triggerLedEffect(e){try{let t,n;if("chase_single"===e||"chase_multi"===e)t={cycles:1,color1:"blue",color2:"red",color3:"green"},n=`${e} LED effect started for 1 cycle`;else{let o,d,a;"twinkle"===e?(o="white",d="white",a="white"):"pulse"===e?(o="hotpink",d="hotpink",a="hotpink"):"matrix"===e?(o="green",d="green",a="green"):(o="blue",d="red",a="green"),t={duration:10,color1:o,color2:d,color3:a},n=`${e} LED effect started for 10 seconds`}const o=await fetch(`/api/led/${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!o.ok){const t=await o.json();throw new Error(t.message||`Failed to trigger ${e} effect`)}const d=await o.json();showMessage(n,"success"),console.log("LED effect result:",d)}catch(t){console.error("LED effect error:",t),showMessage(`Failed to trigger ${e} effect: ${t.message}`,"error")}}async function turnOffLeds(){try{const e=await fetch("/api/led/off",{method:"POST",headers:{"Content-Type":"application/json"}});if(!e.ok){const t=await e.json();throw new Error(t.message||"Failed to turn off LEDs")}const t=await e.json();showMessage("LEDs turned off","success"),console.log("LED off result:",t)}catch(e){console.error("LED off error:",e),showMessage(`Failed to turn off LEDs: ${e.message}`,"error")}}document.addEventListener("DOMContentLoaded",function(){loadConfiguration(),setupAPModeUI()});