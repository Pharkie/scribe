let currentConfig={};async function loadConfiguration(){try{let e;window.GLOBAL_CONFIG&&0!==Object.keys(window.GLOBAL_CONFIG).length?e=window.GLOBAL_CONFIG:(console.log("Waiting for global config to load..."),e=await new Promise((e,t)=>{const n=setTimeout(()=>{t(new Error("Global config not loaded within timeout - please refresh the page"))},1e4),o=t=>{clearTimeout(n),window.removeEventListener("configLoaded",o),e(t.detail)};if(window.GLOBAL_CONFIG&&Object.keys(window.GLOBAL_CONFIG).length>0)return clearTimeout(n),void e(window.GLOBAL_CONFIG);window.addEventListener("configLoaded",o)})),currentConfig=e,populateForm(e),document.getElementById("loading-state").classList.add("hidden"),document.getElementById("settings-form").classList.remove("hidden")}catch(e){console.error("Error loading configuration:",e),showMessage("Failed to load configuration. Please refresh the page.","error")}}function populateForm(e){document.getElementById("wifi-ssid").value=e.wifi?.ssid||"",document.getElementById("wifi-password").value=e.wifi?.password||"",document.getElementById("wifi-timeout").value=e.wifi?.connect_timeout?e.wifi.connect_timeout/1e3:15,document.getElementById("device-owner").value=e.device?.owner||"",document.getElementById("timezone").value=e.device?.timezone||"",document.getElementById("mqtt-server").value=e.mqtt?.server||"",document.getElementById("mqtt-port").value=e.mqtt?.port||8883,document.getElementById("mqtt-username").value=e.mqtt?.username||"",document.getElementById("mqtt-password").value=e.mqtt?.password||"",document.getElementById("chatgpt-api-token").value=e.apis?.chatgptApiToken||"",document.getElementById("max-characters").value=e.validation?.maxCharacters||1e3;const t=e.webInterface?.printerDiscoveryPollingInterval||3e4;document.getElementById("polling-interval").value=t/1e3;const n=document.getElementById("unbidden-ink-enabled");n&&(n.checked=e.unbiddenInk?.enabled||!1);const o=document.getElementById("time-start"),d=document.getElementById("time-end");o&&d&&(o.value=e.unbiddenInk?.startHour||8,d.value=e.unbiddenInk?.endHour||22,"function"==typeof updateTimeRange&&updateTimeRange(),setTimeout(()=>{"function"==typeof updateClickAreas&&updateClickAreas()},100));const a=document.getElementById("frequency-minutes");if(a){const t=e.unbiddenInk?.frequencyMinutes||60;a.value=t,"function"==typeof updateSliderFromFrequency&&updateSliderFromFrequency(t),"function"==typeof updateFrequencyDisplay&&updateFrequencyDisplay()}const u=document.getElementById("unbidden-ink-prompt");u&&(u.value=e.unbiddenInk?.prompt||""),toggleUnbiddenInkSettings(),document.getElementById("button1-short").value=e.buttons?.button1?.shortAction||"/api/joke",document.getElementById("button1-long").value=e.buttons?.button1?.longAction||"",document.getElementById("button2-short").value=e.buttons?.button2?.shortAction||"/api/riddle",document.getElementById("button2-long").value=e.buttons?.button2?.longAction||"",document.getElementById("button3-short").value=e.buttons?.button3?.shortAction||"/api/quote",document.getElementById("button3-long").value=e.buttons?.button3?.longAction||"",document.getElementById("button4-short").value=e.buttons?.button4?.shortAction||"/api/quiz",document.getElementById("button4-long").value=e.buttons?.button4?.longAction||"",updateNextScheduledDisplay(e.status?.unbiddenInk?.nextScheduled)}function collectFormData(){return{device:{owner:document.getElementById("device-owner").value,timezone:document.getElementById("timezone").value},wifi:{ssid:document.getElementById("wifi-ssid").value,password:document.getElementById("wifi-password").value,connect_timeout:1e3*parseInt(document.getElementById("wifi-timeout").value)},mqtt:{server:document.getElementById("mqtt-server").value,port:parseInt(document.getElementById("mqtt-port").value),username:document.getElementById("mqtt-username").value,password:document.getElementById("mqtt-password").value},apis:{chatgptApiToken:document.getElementById("chatgpt-api-token").value},validation:{maxCharacters:parseInt(document.getElementById("max-characters").value)},webInterface:{printerDiscoveryPollingInterval:1e3*parseInt(document.getElementById("polling-interval").value)},unbiddenInk:{enabled:document.getElementById("unbidden-ink-enabled").checked,startHour:parseInt(document.getElementById("time-start")?.value||document.getElementById("start-hour")?.value||8),endHour:parseInt(document.getElementById("time-end")?.value||document.getElementById("end-hour")?.value||22),frequencyMinutes:parseInt(document.getElementById("frequency-minutes").value),prompt:document.getElementById("unbidden-ink-prompt").value},buttons:{button1:{shortAction:document.getElementById("button1-short").value,longAction:document.getElementById("button1-long").value},button2:{shortAction:document.getElementById("button2-short").value,longAction:document.getElementById("button2-long").value},button3:{shortAction:document.getElementById("button3-short").value,longAction:document.getElementById("button3-long").value},button4:{shortAction:document.getElementById("button4-short").value,longAction:document.getElementById("button4-long").value}}}}async function saveSettings(e){e.preventDefault(),document.getElementById("save-loading").classList.remove("hidden");try{const e=collectFormData(),t=await fetch("/api/config",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),n=await t.json();if(!t.ok||!n.success)throw new Error(n.error||"Failed to save settings");showMessage("Your Scribe settings have been tucked away safely","success"),currentConfig=e}catch(e){console.error("Error saving settings:",e),showMessage(`Failed to save settings: ${e.message}`,"error")}finally{document.getElementById("save-loading").classList.add("hidden")}}function showMessage(e,t){const n=document.getElementById("message-container"),o=document.createElement("div");o.className="p-4 rounded-lg shadow-lg mb-4 transition-all duration-300 "+("success"===t?"bg-green-100 text-green-800 border border-green-200":"bg-red-100 text-red-800 border border-red-200"),o.innerHTML=`\n        <div class="flex items-center space-x-2">\n            <span class="text-xl">${"success"===t?"✅":"❌"}</span>\n            <span>${e}</span>\n            <button onclick="this.parentElement.parentElement.remove()" class="ml-auto text-lg font-bold opacity-50 hover:opacity-100">×</button>\n        </div>\n    `,n.appendChild(o),setTimeout(()=>{o.parentElement&&o.remove()},5e3)}function toggleUnbiddenInkSettings(){const e=document.getElementById("unbidden-ink-enabled").checked,t=document.getElementById("unbidden-ink-settings");if(t)if(e)t.classList.remove("hidden"),t.querySelectorAll("input, textarea").forEach(e=>{e.removeAttribute("disabled")}),window.GLOBAL_CONFIG?.status?.unbiddenInk?.nextScheduled&&updateNextScheduledDisplay(window.GLOBAL_CONFIG.status.unbiddenInk.nextScheduled);else{t.classList.add("hidden"),t.querySelectorAll("input, textarea").forEach(e=>{e.setAttribute("disabled","disabled")});const e=document.getElementById("next-scheduled");e&&(e.style.display="none")}else console.warn("unbidden-ink-settings element not found")}function goBack(){window.location.href="/"}function setupAPModeUI(){if("192.168.4.1"===window.location.hostname||"scribe-setup"===window.location.hostname){console.log("AP mode detected - adjusting UI");const e=document.getElementById("save-button");e&&(e.textContent="Save and Reboot");const t=document.getElementById("close-button");t&&(t.style.display="none"),e&&(e.classList.remove("flex-1"),e.classList.add("w-full"))}}function updateClickAreas(){const e=document.getElementById("time-start"),t=document.getElementById("time-end"),n=document.getElementById("click-area-start"),o=document.getElementById("click-area-end");if(!(e&&t&&n&&o))return;const d=parseInt(e.value),a=parseInt(t.value),u=(e.offsetWidth,d/24*100),i=(a+1)/24*100,s=(u+i)/2,l=Math.max(0,u-7.5),r=Math.min(s-1,u+7.5);n.style.left=l+"%",n.style.width=r-l+"%";const c=Math.max(s+1,i-7.5),m=Math.min(100,i+7.5);o.style.left=c+"%",o.style.width=m-c+"%"}function handleSliderClick(e,t){const n=document.getElementById("time-start"),o=document.getElementById("time-end");if(!n||!o)return;const d=e.currentTarget.getBoundingClientRect(),a=(e.clientX-d.left)/d.width*100,u=Math.round(a/100*24);if("start"===t){const e=Math.max(0,Math.min(24,u)),t=parseInt(o.value);if(e>=t&&(0!==e||0!==t)){if(!(t<24))return n.value=t-1,updateTimeRange(n,"start"),void updateClickAreas();o.value=e+1}n.value=e,updateTimeRange(n,"start")}else if("end"===t){const e=Math.max(0,Math.min(24,u)),t=parseInt(n.value);if(e<=t&&(0!==t||0!==e)){if(!(t>0))return o.value=t+1,updateTimeRange(o,"end"),void updateClickAreas();n.value=e-1}o.value=e,updateTimeRange(o,"end")}updateClickAreas()}function updateTimeRange(e,t){const n=document.getElementById("time-start"),o=document.getElementById("time-end");if(!n||!o)return;let d=parseInt(n.value),a=parseInt(o.value);0===d&&0===a||("start"===t?d>=a&&(a<24?(a=d+1,o.value=a):(d=23,n.value=d)):"end"===t&&a<=d&&(d>0?(d=a-1,n.value=d):(a=1,o.value=a))),d=parseInt(n.value),a=parseInt(o.value);const u=document.getElementById("time-track");if(u)if(0===d&&0===a)u.style.left="0%",u.style.width="100%";else{const e=d/24*100,t=a/24*100;u.style.left=e+"%",u.style.width=t-e+"%"}const i=document.getElementById("time-display-start"),s=document.getElementById("time-display-end"),l=e=>24===e?"00:00":String(e).padStart(2,"0")+":00";i&&(i.textContent=l(d)),s&&(s.textContent=l(a)),updateClickAreas(),"function"==typeof updateFrequencyDisplay&&updateFrequencyDisplay()}function updateFrequencyFromSlider(e){const t=[15,30,45,60,120,240,360,480][parseInt(e)],n=document.getElementById("frequency-minutes");n&&(n.value=t,updateFrequencyDisplay())}function updateSliderFromFrequency(e){const t=[15,30,45,60,120,240,360,480].indexOf(parseInt(e)),n=document.getElementById("frequency-slider");n&&-1!==t&&(n.value=t)}function setFrequency(e){const t=document.getElementById("frequency-minutes");t&&(t.value=e,updateFrequencyDisplay(),updateSliderFromFrequency(e))}function updateFrequencyDisplay(){const e=document.getElementById("frequency-minutes"),t=document.getElementById("frequency-display"),n=document.getElementById("time-start"),o=document.getElementById("time-end");if(!(e&&t&&n&&o))return;const d=parseInt(e.value),a=parseInt(n.value),u=parseInt(o.value),i=e=>0===e||24===e?"12 am":e<12?`${e} am`:12===e?"12 pm":e-12+" pm",s=i(a),l=i(u);let r;if(d<60)r=`Around every ${d} minutes from ${s} to ${l} each day`;else{const e=d/60;r=1===e?`Around once per hour from ${s} to ${l} each day`:`Around once every ${e} hours from ${s} to ${l} each day`}t.textContent=r}function setPrompt(e){const t=document.getElementById("unbidden-ink-prompt");t&&(t.value=e,t.dispatchEvent(new Event("input")))}function bringSliderToFront(e){const t=document.getElementById("time-start"),n=document.getElementById("time-end");t&&n&&(t.style.zIndex="20",n.style.zIndex="20",e.style.zIndex="30")}async function testUnbiddenInk(){const e=event.target,t=e.textContent;try{if(!document.getElementById("chatgpt-api-token").value.trim())return void showMessage("Please configure your ChatGPT API Token first. You can get one from https://platform.openai.com/api-keys","error");if(!document.getElementById("unbidden-ink-enabled").checked)return void showMessage("Please enable Unbidden Ink first before testing.","error");const t=document.getElementById("unbidden-ink-prompt").value.trim();if(!t)return void showMessage("Please enter a prompt in the Custom Prompt field before testing.","error");e.disabled=!0,e.textContent="Generating...";const n=await fetch("/api/unbidden-ink",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:t})});if(!n.ok){let e=(await n.json().catch(()=>({}))).error||`HTTP ${n.status}: ${n.statusText}`;throw 500===n.status&&e.includes("Failed to generate")&&(e="Failed to generate content. Please check that your ChatGPT API Token is valid and you have sufficient API credits. You can check your account at https://platform.openai.com/account"),new Error(e)}const o=await n.json();if(!o.success)throw new Error(o.error||"Unknown error occurred");showMessage("Unbidden Ink Scribed","success")}catch(e){console.error("Failed to test Unbidden Ink:",e),showMessage(`Failed to test Unbidden Ink: ${e.message}`,"error")}finally{e.disabled=!1,e.textContent=t}}function updateNextScheduledDisplay(e){const t=document.getElementById("next-scheduled");t&&(e&&"-"!==e?(t.textContent=`Next: ${e}`,t.style.display="block"):t.style.display="none")}document.addEventListener("DOMContentLoaded",function(){loadConfiguration(),setupAPModeUI()});