async function loadConfiguration(){try{console.log("API: Loading configuration from server...");const e=await fetch("/api/config");if(!e.ok)throw new Error(`Config API returned ${e.status}: ${e.statusText}`);const t=await e.json();return console.log("API: Configuration loaded successfully"),t}catch(e){throw console.error("API: Failed to load configuration:",e),e}}async function saveConfiguration(e){try{console.log("API: Sending config to server..."),console.log("API: Config data:",JSON.stringify(e,null,2));const t=await fetch("/api/config",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){const e=await t.text();throw console.error("API: Server error response:",e),new Error(`Server error: ${t.status} - ${e}`)}const n=await t.text();return console.log("API: Server response:",n),n}catch(e){throw console.error("API: Failed to save configuration:",e),e}}async function testUnbiddenInkGeneration(e){try{const t=await fetch("/api/unbidden-ink",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:e})});if(!t.ok){let e=(await t.json().catch(()=>({}))).error||`HTTP ${t.status}: ${t.statusText}`;throw 500===t.status&&e.includes("Failed to generate")&&(e="Failed to generate content. Please check that your ChatGPT API Token is valid and you have sufficient API credits. You can check your account at https://platform.openai.com/account"),new Error(e)}return await t.json()}catch(e){throw console.error("API: Failed to test Unbidden Ink:",e),e}}async function printLocalContent(e){try{const t=await fetch("/api/print-local",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:e})});if(!t.ok){const e=await t.json().catch(()=>({}));throw new Error(e.error||`Print failed: HTTP ${t.status}`)}}catch(e){throw console.error("API: Failed to print content:",e),e}}async function triggerLedEffect(e,t=1e4,n=null){try{const o={effect:e,duration:t};n&&Object.keys(n).length>0&&(o.settings=n);const i=await fetch("/api/led-effect",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);return await i.json()}catch(e){throw console.error("API: Failed to trigger LED effect:",e),e}}async function turnOffLeds(){try{const e=await fetch("/api/leds-off",{method:"POST",headers:{"Content-Type":"application/json"}});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return await e.json()}catch(e){throw console.error("API: Failed to turn off LEDs:",e),e}}function populateForm(e){setElementValue("device-owner",e.device?.owner||""),setElementValue("timezone",e.device?.timezone||""),setElementValue("wifi-ssid",e.wifi?.ssid||""),setElementValue("wifi-password",e.wifi?.password||""),setElementValue("wifi-timeout",(e.wifi?.connect_timeout||15e3)/1e3),setElementValue("mqtt-server",e.mqtt?.server||""),setElementValue("mqtt-port",e.mqtt?.port||1883),setElementValue("mqtt-username",e.mqtt?.username||""),setElementValue("mqtt-password",e.mqtt?.password||""),setElementValue("max-characters",e.validation?.maxCharacters||500),setElementValue("chatgpt-api-token",e.apis?.chatgptApiToken||""),setElementChecked("unbidden-ink-enabled",e.unbiddenInk?.enabled||!1),setElementValue("time-start",void 0!==e.unbiddenInk?.startHour?e.unbiddenInk.startHour:8),setElementValue("time-end",void 0!==e.unbiddenInk?.endHour?e.unbiddenInk.endHour:22),updateTimeRange(),setTimeout(()=>{updateClickAreas()},100),setElementValue("frequency-minutes",e.unbiddenInk?.frequencyMinutes||60),updateSliderFromFrequency(e.unbiddenInk?.frequencyMinutes||60),updateFrequencyDisplay(),setElementValue("unbidden-ink-prompt",e.unbiddenInk?.prompt||""),matchCustomPromptToPreset(e.unbiddenInk?.prompt||"");for(let t=0;t<4;t++){const n=t+1;setElementValue(`button${n}-short`,e.buttons?.[`button${n}`]?.shortAction||""),setElementValue(`button${n}-long`,e.buttons?.[`button${n}`]?.longAction||""),setElementValue(`button${n}-short-mqtt-topic`,e.buttons?.[`button${n}`]?.shortMqttTopic||""),setElementValue(`button${n}-long-mqtt-topic`,e.buttons?.[`button${n}`]?.longMqttTopic||"")}window.SettingsLED&&window.SettingsLED.populateLedForm&&window.SettingsLED.populateLedForm(e),updateNextScheduledDisplay(e.status?.unbiddenInk?.nextScheduled)}function collectFormData(){const e={device:{owner:getElementValue("device-owner"),timezone:getElementValue("timezone")},wifi:{ssid:getElementValue("wifi-ssid"),password:getElementValue("wifi-password"),connect_timeout:1e3*getElementIntValue("wifi-timeout",15)},mqtt:{server:getElementValue("mqtt-server"),port:getElementIntValue("mqtt-port",1883),username:getElementValue("mqtt-username"),password:getElementValue("mqtt-password")},validation:{maxCharacters:getElementIntValue("max-characters",500)},apis:{chatgptApiToken:getElementValue("chatgpt-api-token")},unbiddenInk:{enabled:getElementChecked("unbidden-ink-enabled"),startHour:getElementIntValue("time-start",8),endHour:getElementIntValue("time-end",22),frequencyMinutes:getElementIntValue("frequency-minutes",60),prompt:getElementValue("unbidden-ink-prompt")},buttons:{}};for(let t=0;t<4;t++){const n=t+1,o=`button${n}`;e.buttons[o]={shortAction:getElementValue(`button${n}-short`),longAction:getElementValue(`button${n}-long`),shortMqttTopic:getElementValue(`button${n}-short-mqtt-topic`),longMqttTopic:getElementValue(`button${n}-long-mqtt-topic`)}}return window.SettingsLED&&window.SettingsLED.collectLedConfig?e.leds=window.SettingsLED.collectLedConfig():e.leds={pin:getElementIntValue("led-pin",4),count:getElementIntValue("led-count",30),brightness:getElementIntValue("led-brightness",64),refreshRate:getElementIntValue("led-refresh-rate",60)},e}function showSettingsSection(e){document.querySelectorAll(".settings-section").forEach(e=>{e.classList.add("hidden")});const t=document.getElementById(`${e}-section`);t&&t.classList.remove("hidden");document.querySelectorAll(".section-nav-btn").forEach(e=>{e.classList.remove("active")});const n=document.querySelector(`[onclick="showSettingsSection('${e}')"]`);n&&n.classList.add("active")}function hideLoadingState(){const e=document.getElementById("loading-state"),t=document.getElementById("settings-navigation"),n=document.getElementById("settings-form");e&&(e.style.display="none"),t&&t.classList.remove("hidden"),n&&(n.classList.remove("hidden"),showSettingsSection("wifi"))}function showMessage(e,t){window.showToast?window.showToast(e,t):"error"===t?alert("Error: "+e):"success"===t?console.log("Success: "+e):console.log(t+": "+e)}function toggleUnbiddenInkSettings(){const e=document.getElementById("unbidden-ink-enabled"),t=document.getElementById("unbidden-ink-settings");e&&t&&(e.checked?t.classList.remove("hidden"):t.classList.add("hidden"))}function updateTimeRange(e,t){const n=document.getElementById("time-start"),o=document.getElementById("time-end");if(!n||!o)return;let i=parseInt(n.value),s=parseInt(o.value);console.log("updateTimeRange - startVal:",i,"endVal:",s,"type:",t),0===i&&0===s||0===i&&24===s?24===s&&(o.value=0,s=0):"start"===t?i>=s&&(s<24?(s=i+1,o.value=s):(i=23,n.value=i)):"end"===t?s<=i&&(i>0?(i=s-1,n.value=i):(s=1,o.value=s)):i>=s&&(0!==i||0!==s)&&(s<24?(s=i+1,o.value=s):(i=23,n.value=i)),i=parseInt(n.value),s=parseInt(o.value);const a=document.getElementById("time-track");if(a)if(0===i&&0===s)a.style.left="0%",a.style.width="100%",a.classList.add("all-day-track");else{const e=i/24*100,t=s/24*100;a.style.left=e+"%",a.style.width=t-e+"%",a.classList.remove("all-day-track")}const r=document.getElementById("time-display-start"),d=document.getElementById("time-display-end"),l=(e,t=!1)=>0===i&&0===s?t?"24:00 (All Day)":"00:00 (All Day)":24===e?"00:00 (next day)":0===e?"00:00":String(e).padStart(2,"0")+":00";r&&(r.textContent=l(i,!1)),d&&(d.textContent=l(s,!0)),updateClickAreas(),updateFrequencyDisplay()}function updateNextScheduledDisplay(e){const t=document.getElementById("next-scheduled-display");if(t&&e){const n=new Date(e);t.textContent=`Next: ${n.toLocaleString()}`}}function goBack(){window.location.href="/"}function handleSliderClick(e,t){const n=document.getElementById("time-start"),o=document.getElementById("time-end");if(!n||!o)return;const i=e.currentTarget.getBoundingClientRect(),s=(e.clientX-i.left)/i.width*100,a=Math.round(s/100*24);if("start"===t){const e=Math.max(0,Math.min(24,a)),t=parseInt(o.value);if(e>=t&&(0!==e||0!==t)){if(!(t<24))return n.value=t-1,updateTimeRange(),void updateClickAreas();o.value=e+1}n.value=e,updateTimeRange()}else if("end"===t){const e=Math.max(0,Math.min(24,a)),t=parseInt(n.value);if(e<=t&&(0!==t||0!==e)){if(!(t>0))return o.value=t+1,updateTimeRange(),void updateClickAreas();n.value=e-1}o.value=e,updateTimeRange()}updateClickAreas()}function updateClickAreas(){const e=document.getElementById("time-start"),t=document.getElementById("time-end"),n=document.getElementById("click-area-start"),o=document.getElementById("click-area-end");if(!(e&&t&&n&&o))return;const i=parseInt(e.value)/24*100,s=(parseInt(t.value)+1)/24*100,a=(i+s)/2,r=Math.max(0,i-7.5),d=Math.min(a-1,i+7.5);n.style.left=r+"%",n.style.width=d-r+"%";const l=Math.max(a+1,s-7.5),c=Math.min(100,s+7.5);o.style.left=l+"%",o.style.width=c-l+"%"}function updateFrequencyFromSlider(e){const t=[15,30,45,60,120,240,360,480][parseInt(e)],n=document.getElementById("frequency-minutes");n&&(n.value=t,updateFrequencyDisplay())}function updateSliderFromFrequency(e){const t=[15,30,45,60,120,240,360,480].indexOf(parseInt(e)),n=document.getElementById("frequency-slider");n&&-1!==t&&(n.value=t)}function updateFrequencyDisplay(){const e=document.getElementById("frequency-minutes"),t=document.getElementById("frequency-display"),n=document.getElementById("time-start"),o=document.getElementById("time-end");if(!(e&&t&&n&&o))return;const i=parseInt(e.value),s=parseInt(n.value),a=parseInt(o.value),r=e=>String(e).padStart(2,"0")+":00";if(0===s&&0===a)if(i<60)text=`Around every ${i} minutes, all day long`;else{const e=Math.floor(i/60),t=i%60;text=0===t?`Around every ${e} hour${1!==e?"s":""}, all day long`:`Around every ${e}h ${t}m, all day long`}else{const e=r(s),t=r(a);if(i<60)text=`Around every ${i} minutes from ${e} to ${t} each day`;else{const n=Math.floor(i/60),o=i%60;text=0===o?`Around every ${n} hour${1!==n?"s":""} from ${e} to ${t} each day`:`Around every ${n}h ${o}m from ${e} to ${t} each day`}}t.textContent=text}function setFrequency(e){const t=document.getElementById("frequency-minutes");t&&(t.value=e,updateFrequencyDisplay(),updateSliderFromFrequency(e))}function setPrompt(e){const t=document.getElementById("unbidden-ink-prompt");t&&(t.value=e,t.dispatchEvent(new Event("input")),highlightMatchingPreset(e))}function matchCustomPromptToPreset(e){if(!e)return;-1!==["Generate a short, inspiring quote about creativity, technology, or daily life. Keep it under 200 characters.","Generate a fun fact under 200 characters about BBC Doctor Who - the characters, episodes, behind-the-scenes trivia, or the show's history that is esoteric and only 5% of fans might know.","Write a short, humorous observation about everyday life or a witty one-liner. Keep it light and under 200 characters.","Generate a short creative writing prompt, mini-story, or poetic thought. Be imaginative and keep under 250 characters."].findIndex(t=>t===e)&&setTimeout(()=>{highlightMatchingPreset(e)},150)}function highlightMatchingPreset(e){document.querySelectorAll(".prompt-preset").forEach(e=>{e.classList.remove("bg-purple-100","dark:bg-purple-900/40","ring-2","ring-purple-400")}),document.querySelectorAll(".prompt-preset").forEach(t=>{const n=t.getAttribute("onclick");n&&n.includes(e.replace(/'/g,"\\'"))&&t.classList.add("bg-purple-100","dark:bg-purple-900/40","ring-2","ring-purple-400")})}function setElementValue(e,t){const n=document.getElementById(e);n&&(n.value=t||"")}function setElementChecked(e,t){const n=document.getElementById(e);n&&(n.checked=!!t)}function getElementValue(e,t=""){const n=document.getElementById(e);return n&&n.value||t}function getElementIntValue(e,t){const n=document.getElementById(e);if(!n)return t;const o=parseInt(n.value);return isNaN(o)?t:o}function getElementChecked(e){const t=document.getElementById(e);return!!t&&t.checked}function formatTime(e){return`${0===e?12:e>12?e-12:e}:00 ${e>=12?"PM":"AM"}`}function colorToHtml(e,t){const n=e||t;return n.length>7?n.substring(0,7):n}function colorToRgba(e){return 7===e.length?e+"ff":e}function populateLedForm(e){if(!e.leds)return;const t=document.getElementById("led-pin"),n=document.getElementById("led-count"),o=document.getElementById("led-brightness"),i=document.getElementById("led-refresh-rate");t&&(t.value=e.leds.pin||4),n&&(n.value=e.leds.count||30),o&&(o.value=e.leds.brightness||64),i&&(i.value=e.leds.refreshRate||60);const s=e.leds.effects||{},a=s.chaseSingle||{},r={speed:document.getElementById("chase-single-speed"),trailLength:document.getElementById("chase-single-trail-length"),trailFade:document.getElementById("chase-single-trail-fade"),color:document.getElementById("chase-single-color")};r.speed&&(r.speed.value=a.speed||5),r.trailLength&&(r.trailLength.value=a.trailLength||15),r.trailFade&&(r.trailFade.value=a.trailFade||15),r.color&&(r.color.value=colorToHtml(a.defaultColor,"#0062ff"));const d=s.chaseMulti||{},l={speed:document.getElementById("chase-multi-speed"),trailLength:document.getElementById("chase-multi-trail-length"),trailFade:document.getElementById("chase-multi-trail-fade"),colorSpacing:document.getElementById("chase-multi-color-spacing"),color1:document.getElementById("chase-multi-color1"),color2:document.getElementById("chase-multi-color2"),color3:document.getElementById("chase-multi-color3")};l.speed&&(l.speed.value=d.speed||2),l.trailLength&&(l.trailLength.value=d.trailLength||20),l.trailFade&&(l.trailFade.value=d.trailFade||20),l.colorSpacing&&(l.colorSpacing.value=d.colorSpacing||12),l.color1&&(l.color1.value=colorToHtml(d.color1,"#ff9900")),l.color2&&(l.color2.value=colorToHtml(d.color2,"#008f00")),l.color3&&(l.color3.value=colorToHtml(d.color3,"#78cffe"));const c=s.matrix||{},u={speed:document.getElementById("matrix-speed"),drops:document.getElementById("matrix-drops"),backgroundFade:document.getElementById("matrix-background-fade"),trailFade:document.getElementById("matrix-trail-fade"),brightnessFade:document.getElementById("matrix-brightness-fade"),color:document.getElementById("matrix-color")};u.speed&&(u.speed.value=c.speed||3),u.drops&&(u.drops.value=c.drops||5),u.backgroundFade&&(u.backgroundFade.value=c.backgroundFade||64),u.trailFade&&(u.trailFade.value=c.trailFade||32),u.brightnessFade&&(u.brightnessFade.value=c.brightnessFade||40),u.color&&(u.color.value=colorToHtml(c.defaultColor,"#009100"));const m=s.twinkle||{},g={density:document.getElementById("twinkle-density"),fadeSpeed:document.getElementById("twinkle-fade-speed"),minBrightness:document.getElementById("twinkle-min-brightness"),maxBrightness:document.getElementById("twinkle-max-brightness"),color:document.getElementById("twinkle-color")};g.density&&(g.density.value=m.density||8),g.fadeSpeed&&(g.fadeSpeed.value=m.fadeSpeed||5),g.minBrightness&&(g.minBrightness.value=m.minBrightness||50),g.maxBrightness&&(g.maxBrightness.value=m.maxBrightness||255),g.color&&(g.color.value=colorToHtml(m.defaultColor,"#ffffff"));const f=s.pulse||{},p={speed:document.getElementById("pulse-speed"),minBrightness:document.getElementById("pulse-min-brightness"),maxBrightness:document.getElementById("pulse-max-brightness"),waveFrequency:document.getElementById("pulse-wave-frequency"),color:document.getElementById("pulse-color")};p.speed&&(p.speed.value=f.speed||4),p.minBrightness&&(p.minBrightness.value=f.minBrightness||0),p.maxBrightness&&(p.maxBrightness.value=f.maxBrightness||255),p.waveFrequency&&(p.waveFrequency.value=f.waveFrequency||.05),p.color&&(p.color.value=colorToHtml(f.defaultColor,"#ff00f2"));const h=s.rainbow||{},w={speed:document.getElementById("rainbow-speed"),saturation:document.getElementById("rainbow-saturation"),brightness:document.getElementById("rainbow-brightness"),hueStep:document.getElementById("rainbow-hue-step")};w.speed&&(w.speed.value=h.speed||2),w.saturation&&(w.saturation.value=h.saturation||255),w.brightness&&(w.brightness.value=h.brightness||255),w.hueStep&&(w.hueStep.value=h.hueStep||2.5)}function collectBasicLedConfig(){const e=(e,t)=>{const n=document.getElementById(e);if(!n)return t;const o=parseInt(n.value);return isNaN(o)?t:o};return{pin:e("led-pin",4),count:e("led-count",30),brightness:e("led-brightness",64),refreshRate:e("led-refresh-rate",60)}}async function demoLedEffect(e){try{const t=collectEffectSettings(e);await window.SettingsAPI.triggerLedEffect(e,1e4,t),window.SettingsUI&&window.SettingsUI.showMessage&&window.SettingsUI.showMessage(`${e} effect triggered with custom settings!`,"success")}catch(t){console.error("Failed to demo LED effect:",t),window.SettingsUI&&window.SettingsUI.showMessage&&window.SettingsUI.showMessage(`Failed to demo ${e}: ${t.message}`,"error")}}function collectEffectSettings(e){switch(e){case"chase_single":return{speed:parseInt(document.getElementById("chase-single-speed")?.value)||5,trailLength:parseInt(document.getElementById("chase-single-trail-length")?.value)||15,trailFade:parseInt(document.getElementById("chase-single-trail-fade")?.value)||15,color:colorToRgba(document.getElementById("chase-single-color")?.value)||"#0062ffff"};case"chase_multi":return{speed:parseInt(document.getElementById("chase-multi-speed")?.value)||2,trailLength:parseInt(document.getElementById("chase-multi-trail-length")?.value)||20,trailFade:parseInt(document.getElementById("chase-multi-trail-fade")?.value)||20,colorSpacing:parseInt(document.getElementById("chase-multi-color-spacing")?.value)||12,colors:[colorToRgba(document.getElementById("chase-multi-color1")?.value)||"#ff9900ff",colorToRgba(document.getElementById("chase-multi-color2")?.value)||"#008f00ff",colorToRgba(document.getElementById("chase-multi-color3")?.value)||"#78cffeff"]};case"matrix":return{speed:parseInt(document.getElementById("matrix-speed")?.value)||3,drops:parseInt(document.getElementById("matrix-drops")?.value)||5,backgroundFade:parseInt(document.getElementById("matrix-background-fade")?.value)||64,trailFade:parseInt(document.getElementById("matrix-trail-fade")?.value)||32,brightnessFade:parseInt(document.getElementById("matrix-brightness-fade")?.value)||40,color:colorToRgba(document.getElementById("matrix-color")?.value)||"#009100ff"};case"twinkle":return{density:parseInt(document.getElementById("twinkle-density")?.value)||8,fadeSpeed:parseInt(document.getElementById("twinkle-fade-speed")?.value)||5,minBrightness:parseInt(document.getElementById("twinkle-min-brightness")?.value)||50,maxBrightness:parseInt(document.getElementById("twinkle-max-brightness")?.value)||255,color:colorToRgba(document.getElementById("twinkle-color")?.value)||"#ffffffff"};case"pulse":return{speed:parseInt(document.getElementById("pulse-speed")?.value)||4,minBrightness:parseInt(document.getElementById("pulse-min-brightness")?.value)||0,maxBrightness:parseInt(document.getElementById("pulse-max-brightness")?.value)||255,waveFrequency:parseFloat(document.getElementById("pulse-wave-frequency")?.value)||.05,color:colorToRgba(document.getElementById("pulse-color")?.value)||"#ff00f2ff"};case"rainbow":return{speed:parseFloat(document.getElementById("rainbow-speed")?.value)||2,saturation:parseInt(document.getElementById("rainbow-saturation")?.value)||255,brightness:parseInt(document.getElementById("rainbow-brightness")?.value)||255,hueStep:parseFloat(document.getElementById("rainbow-hue-step")?.value)||2.5};default:return{}}}async function turnOffLeds(){try{const e=await fetch("/api/leds-off",{method:"POST",headers:{"Content-Type":"application/json"}});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);window.SettingsCore&&window.SettingsCore.showMessage&&window.SettingsCore.showMessage("LEDs turned off successfully!","success")}catch(e){console.error("Failed to turn off LEDs:",e),window.SettingsCore&&window.SettingsCore.showMessage&&window.SettingsCore.showMessage(`Failed to turn off LEDs: ${e.message}`,"error")}}function validateLedConfig(e){return e?e.pin<0||e.pin>21?{isValid:!1,error:"LED pin must be between 0 and 21 (ESP32-C3 compatible)"}:e.count<1||e.count>300?{isValid:!1,error:"LED count must be between 1 and 300"}:e.brightness<0||e.brightness>255?{isValid:!1,error:"LED brightness must be between 0 and 255"}:e.refreshRate<10||e.refreshRate>120?{isValid:!1,error:"LED refresh rate must be between 10 and 120 Hz"}:{isValid:!0}:{isValid:!1,error:"LED configuration is missing"}}async function initializeSettings(){try{await waitForModules();const e=await window.SettingsAPI.loadConfiguration();window.SettingsUI.populateForm(e),setupFormHandler(),setupEventHandlers(),window.SettingsUI.hideLoadingState(),console.log("Settings page initialized successfully")}catch(e){console.error("Failed to initialize settings page:",e),window.SettingsUI.showMessage("Failed to initialize settings page: "+e.message,"error")}}async function waitForModules(){let e=0;for(;e<5e3;){if(window.SettingsAPI&&window.SettingsUI&&window.SettingsLED)return;await new Promise(e=>setTimeout(e,100)),e+=100}throw new Error("Timeout waiting for settings modules to load")}function setupFormHandler(){const e=document.getElementById("settings-form");e&&e.addEventListener("submit",handleFormSubmit)}function setupEventHandlers(){const e=document.getElementById("unbidden-ink-enabled");e&&(e.addEventListener("change",window.SettingsUI.toggleUnbiddenInkSettings),e.removeAttribute("onchange"),window.SettingsUI.toggleUnbiddenInkSettings());const t=document.getElementById("time-start"),n=document.getElementById("time-end");t&&n&&(t.addEventListener("input",function(){window.SettingsUI.updateTimeRange(this,"start")}),n.addEventListener("input",function(){window.SettingsUI.updateTimeRange(this,"end")}),t.addEventListener("change",window.SettingsUI.updateClickAreas),n.addEventListener("change",window.SettingsUI.updateClickAreas),t.removeAttribute("oninput"),t.removeAttribute("onchange"),n.removeAttribute("oninput"),n.removeAttribute("onchange"));const o=document.getElementById("unbidden-ink-prompt");o&&o.addEventListener("input",function(){setTimeout(()=>{const e=this.value;window.SettingsUI.matchCustomPromptToPreset(e)},100)}),setupNavigationHandlers(),setupFrequencyHandlers(),setupPromptPresetHandlers(),setupTimeRangeClickHandlers(),setupBackButtonHandler(),setupTestButtonHandlers(),setupLedDemoHandlers()}function setupNavigationHandlers(){[{id:"nav-wifi",section:"wifi"},{id:"nav-device",section:"device"},{id:"nav-mqtt",section:"mqtt"},{id:"nav-unbidden",section:"unbidden"},{id:"nav-buttons",section:"buttons"},{id:"nav-leds",section:"leds"}].forEach(e=>{const t=document.querySelector(`[onclick*="showSettingsSection('${e.section}')"]`);t&&(t.addEventListener("click",function(t){t.preventDefault(),window.SettingsUI.showSettingsSection(e.section)}),t.removeAttribute("onclick"))})}function setupFrequencyHandlers(){const e=document.getElementById("frequency-slider");e&&(e.addEventListener("input",function(){window.SettingsUI.updateFrequencyFromSlider(this.value)}),e.removeAttribute("oninput"))}function setupPromptPresetHandlers(){["Generate a short, inspiring quote about creativity, technology, or daily life. Keep it under 200 characters.","Generate a fun fact under 200 characters about BBC Doctor Who - the characters, episodes, behind-the-scenes trivia, or the show's history that is esoteric and only 5% of fans might know.","Write a short, humorous observation about everyday life or a witty one-liner. Keep it light and under 200 characters.","Generate a short creative writing prompt, mini-story, or poetic thought. Be imaginative and keep under 250 characters."].forEach(e=>{const t=document.querySelector(`[onclick*="setPrompt('${e.replace(/'/g,"\\'")}')"]`);t&&(t.addEventListener("click",function(t){t.preventDefault(),window.SettingsUI.setPrompt(e)}),t.removeAttribute("onclick"))})}function setupTimeRangeClickHandlers(){const e=document.getElementById("click-area-start"),t=document.getElementById("click-area-end");e&&(e.addEventListener("click",function(e){window.SettingsUI.handleSliderClick(e,"start")}),e.removeAttribute("onclick")),t&&(t.addEventListener("click",function(e){window.SettingsUI.handleSliderClick(e,"end")}),t.removeAttribute("onclick"))}function setupBackButtonHandler(){const e=document.querySelector(".back-button");e&&(e.addEventListener("click",function(e){e.preventDefault(),window.SettingsUI.goBack()}),e.removeAttribute("onclick"))}function setupTestButtonHandlers(){const e=document.querySelector('[onclick*="testUnbiddenInk()"]');e&&(e.addEventListener("click",function(e){e.preventDefault(),handleTestUnbiddenInk()}),e.removeAttribute("onclick"))}function setupLedDemoHandlers(){document.querySelectorAll('[onclick*="demoLedEffect"]').forEach(e=>{const t=e.getAttribute("onclick").match(/demoLedEffect\('([^']+)'\)/);if(t){const n=t[1];e.addEventListener("click",function(e){e.preventDefault(),window.SettingsLED&&window.SettingsLED.demoLedEffect&&window.SettingsLED.demoLedEffect(n)}),e.removeAttribute("onclick")}});document.querySelectorAll('[onclick*="turnOffLeds"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault(),handleTurnOffLeds()}),e.removeAttribute("onclick")})}async function handleFormSubmit(e){e.preventDefault();try{const e=window.SettingsUI.collectFormData();if(window.SettingsLED.validateLedConfig){const t=window.SettingsLED.validateLedConfig(e.leds);if(!t.isValid)return void window.SettingsUI.showMessage(t.error,"error")}await window.SettingsAPI.saveConfiguration(e),window.location.href="/?message=Settings saved successfully!&type=success"}catch(e){console.error("Failed to save settings:",e),window.SettingsUI.showMessage("Failed to save settings: "+e.message,"error")}}async function handleLedEffect(e){try{await window.SettingsAPI.triggerLedEffect(e),window.SettingsUI.showMessage(`${e} effect triggered successfully!`,"success")}catch(t){console.error("Failed to trigger LED effect:",t),window.SettingsUI.showMessage(`Failed to trigger ${e} effect: ${t.message}`,"error")}}async function handleTurnOffLeds(){try{await window.SettingsAPI.turnOffLeds(),window.SettingsUI.showMessage("LEDs turned off successfully!","success")}catch(e){console.error("Failed to turn off LEDs:",e),window.SettingsUI.showMessage(`Failed to turn off LEDs: ${e.message}`,"error")}}async function handleTestUnbiddenInk(){const e=event.target,t=e.textContent;try{if(!document.getElementById("chatgpt-api-token").value.trim())return void window.SettingsUI.showMessage("Please configure your ChatGPT API Token first. You can get one from https://platform.openai.com/api-keys","error");if(!document.getElementById("unbidden-ink-enabled").checked)return void window.SettingsUI.showMessage("Please enable Unbidden Ink first before testing.","error");const t=document.getElementById("unbidden-ink-prompt").value.trim();if(!t)return void window.SettingsUI.showMessage("Please enter a prompt in the Custom Prompt field before testing.","error");e.disabled=!0,e.textContent="Generating...";const n=await window.SettingsAPI.testUnbiddenInkGeneration(t);if(!n.content)throw new Error(n.error||"No content generated");await window.SettingsAPI.printLocalContent(n.content),window.SettingsUI.showMessage("Unbidden Ink generated and printed successfully","success")}catch(e){console.error("Failed to test Unbidden Ink:",e),window.SettingsUI.showMessage(`Failed to test Unbidden Ink: ${e.message}`,"error")}finally{e.disabled=!1,e.textContent=t}}window.SettingsAPI={loadConfiguration:loadConfiguration,saveConfiguration:saveConfiguration,testUnbiddenInkGeneration:testUnbiddenInkGeneration,printLocalContent:printLocalContent,triggerLedEffect:triggerLedEffect,turnOffLeds:turnOffLeds},window.SettingsUI={populateForm:populateForm,collectFormData:collectFormData,showSettingsSection:showSettingsSection,hideLoadingState:hideLoadingState,showMessage:showMessage,toggleUnbiddenInkSettings:toggleUnbiddenInkSettings,updateTimeRange:updateTimeRange,updateNextScheduledDisplay:updateNextScheduledDisplay,goBack:goBack,handleSliderClick:handleSliderClick,updateClickAreas:updateClickAreas,updateFrequencyFromSlider:updateFrequencyFromSlider,updateSliderFromFrequency:updateSliderFromFrequency,updateFrequencyDisplay:updateFrequencyDisplay,setFrequency:setFrequency,setPrompt:setPrompt,matchCustomPromptToPreset:matchCustomPromptToPreset,highlightMatchingPreset:highlightMatchingPreset},window.SettingsLED={populateLedForm:populateLedForm,collectLedConfig:collectBasicLedConfig,validateLedConfig:validateLedConfig,colorToHtml:colorToHtml,colorToRgba:colorToRgba,demoLedEffect:demoLedEffect,collectEffectSettings:collectEffectSettings},window.saveSettings=handleFormSubmit,window.triggerLedEffect=handleLedEffect,window.turnOffLeds=handleTurnOffLeds,window.showSettingsSection=window.SettingsUI.showSettingsSection,window.goBack=window.SettingsUI.goBack,window.testUnbiddenInk=handleTestUnbiddenInk,window.toggleUnbiddenInkSettings=window.SettingsUI.toggleUnbiddenInkSettings,window.setPrompt=window.SettingsUI.setPrompt,window.setFrequency=window.SettingsUI.setFrequency,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initializeSettings):initializeSettings();