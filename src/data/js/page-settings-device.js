(()=>{var j=Object.defineProperty,Q=Object.defineProperties;var J=Object.getOwnPropertyDescriptors;var O=Object.getOwnPropertySymbols;var K=Object.prototype.hasOwnProperty,W=Object.prototype.propertyIsEnumerable;var $=(e,i,t)=>i in e?j(e,i,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[i]=t,b=(e,i)=>{for(var t in i||(i={}))K.call(i,t)&&$(e,t,i[t]);if(O)for(var t of O(i))W.call(i,t)&&$(e,t,i[t]);return e},D=(e,i)=>Q(e,J(i));async function N(){try{let e=await fetch("/api/config");if(!e.ok)throw new Error(`Config API returned ${e.status}: ${e.statusText}`);return await e.json()}catch(e){throw console.error("API: Failed to load configuration:",e),e}}async function E(e){try{let i=await fetch("/api/config",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!i.ok){let t=await i.text();throw console.error("API: Server error response:",t),new Error(`Server error: ${i.status} - ${t}`)}return"Configuration saved"}catch(i){throw console.error("API: Failed to save configuration:",i),i}}var w=["Europe/London","America/New_York","America/Sao_Paulo","Australia/Sydney","Asia/Tokyo"];function q(e){return e.map(i=>{var t,s,n;try{let o=i.id?i.id.split("/"):["Unknown"],r=o[o.length-1].replace(/_/g," "),a=(t=i.location)==null?void 0:t.countryName,f=(n=(s=i.location)==null?void 0:s.comment)==null?void 0:n.trim(),c,d="";if(i.offsets&&Array.isArray(i.offsets)&&i.offsets.length>0){let u=l=>l.replace(/^\+/,"+").replace(/^-/,"-").replace(/^00/,"+00")+":00";if(i.offsets.length===1)d="UTC"+u(i.offsets[0]),c=a?`${r}, ${a}`:i.id||"Unknown",f&&(c+=` \u2014 ${f}`);else{let l=u(i.offsets[0]),g=u(i.offsets[1]);d=`UTC${l} / ${g} DST`,c=a?`${r}, ${a}`:i.id||"Unknown",f&&(c+=` \u2014 ${f}`)}}else{if(i.currentOffset){let u=i.currentOffset.match(/([+-]\d{2})/);d=u?"UTC"+u[1]+":00":i.currentOffset}c=a?`${r}, ${a}`:i.id||"Unknown"}return{id:i.id||"Unknown",displayName:c,countryName:a||"",comment:f||"",aliases:i.aliases||[],offset:d}}catch(o){return console.error("Error transforming timezone:",i,o),{id:i.id||"Unknown",displayName:i.id||"Unknown",countryName:"",comment:"",aliases:[],offset:""}}})}function U(){return{timezones:[],loading:!1,error:null,initialized:!1}}async function m(e){if(!e.initialized){e.loading=!0,e.error=null;try{let i=await fetch("/api/timezones");if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);let t=await i.json();if(!t.zones||!Array.isArray(t.zones))throw new Error("Invalid timezone data format");e.timezones=q(t.zones),e.initialized=!0,console.log(`Timezone Utils: Loaded ${e.timezones.length} timezones`)}catch(i){e.error=`Failed to load timezones: ${i.message}`,console.error("Timezone Utils: Loading failed:",i)}finally{e.loading=!1}}}function L(e,i){if(!e)return"";let t=i.find(s=>s.id===e);return t?`${t.displayName} (${t.offset})`:e}function C(e,i){if(!e)return"";let t=i.find(s=>s.id===e);return t?t.offset:""}function F(e,i=""){if(!Array.isArray(e)||e.length===0)return[];let t=(i||"").toLowerCase().trim();if(!t){let n=[],o=[];return e.forEach(r=>{w.includes(r.id)?n.push(r):o.push(r)}),n.sort((r,a)=>{let f=w.indexOf(r.id),c=w.indexOf(a.id);return f-c}),[...n,...o.slice(0,5-n.length)]}let s=[];return e.forEach(n=>{let o=null,r=n.id.split("/");r[r.length-1].replace(/_/g," ").toLowerCase().includes(t)?o=1:n.displayName.toLowerCase().includes(t)?o=2:n.id.toLowerCase().includes(t)?o=3:n.countryName&&n.countryName.toLowerCase().includes(t)?o=4:n.comment&&n.comment.toLowerCase().includes(t)&&(o=5),o!==null&&s.push({timezone:n,priority:o})}),s.sort((n,o)=>n.priority!==o.priority?n.priority-o.priority:n.timezone.displayName.localeCompare(o.timezone.displayName)).map(n=>n.timezone)}function G(){return{async loadTimezonesAndOpen(){!this.timezonePicker.initialized&&!this.timezonePicker.loading&&await m(this.timezonePicker),this.isOpen=!0},async openTimezonePicker(){!this.timezonePicker.initialized&&!this.timezonePicker.loading&&await m(this.timezonePicker),this.searchQuery="",this.isOpen=!0},resetTimezoneFocus(){this.focusedIndex=-1},handleGlobalKeydown(e,i){if(!(!this.isOpen||document.activeElement===i.searchInput)){if(e.key.length===1&&!e.ctrlKey&&!e.metaKey&&!e.altKey){i.searchInput.focus();return}e.key==="Backspace"&&(e.preventDefault(),i.searchInput.focus(),this.searchQuery.length>0&&(this.searchQuery=this.searchQuery.slice(0,-1),this.onSearchInputWithReset()))}},closeTimezonePicker(){this.isOpen=!1,this.focusedIndex=-1},navigateTimezoneUp(e,i){this.focusedIndex=this.focusedIndex>0?this.focusedIndex-1:-1,this.focusedIndex===-1?e.searchInput.focus():i(()=>{var s;(s=e.dropdown.querySelectorAll("[data-timezone-option]")[this.focusedIndex])==null||s.focus()})},navigateTimezoneDown(e,i){let t=Math.min(this.filteredTimezones.length-1,4);this.focusedIndex=this.focusedIndex<t?this.focusedIndex+1:0,i(()=>{var n;(n=e.dropdown.querySelectorAll("[data-timezone-option]")[this.focusedIndex])==null||n.focus()})},navigateToFirstTimezone(e,i){this.isOpen&&this.filteredTimezones.length>0&&(this.focusedIndex=0,i(()=>{var s;(s=e.dropdown.querySelectorAll("[data-timezone-option]")[0])==null||s.focus()}))},navigateToLastTimezone(e,i){this.isOpen&&this.filteredTimezones.length>0&&(this.focusedIndex=Math.min(this.filteredTimezones.length-1,4),i(()=>{var s;(s=e.dropdown.querySelectorAll("[data-timezone-option]")[this.focusedIndex])==null||s.focus()}))},onSearchInput(){!this.isOpen&&this.timezonePicker.initialized&&(this.isOpen=!0)},onSearchInputWithReset(){this.onSearchInput(),this.resetTimezoneFocus()},selectTimezone(e){var i,t,s;(i=this.config)!=null&&i.device&&(this.config.device.timezone=e.id),this.searchQuery=e.displayName,this.isOpen=!1,(s=(t=this.validation)==null?void 0:t.errors)!=null&&s["device.timezone"]&&delete this.validation.errors["device.timezone"],console.log("Selected timezone:",e.id)}}}function M(){return D(b({showErrorMessage(e){window.showMessage(e,"error")},loaded:!1,config:{},error:null,saving:!1,initialized:!1,originalConfig:null,validation:{errors:{}},searchQuery:"",async loadConfiguration(){var e;if(this.initialized){console.log("\u2699\uFE0F Device Settings: Already initialized, skipping");return}this.initialized=!0,this.loaded=!1;try{let i=await N();this.originalConfig=JSON.parse(JSON.stringify(i)),this.config=i,(e=this.config.device)!=null&&e.timezone&&await this.loadTimezones(),console.log("Alpine Device Store: Configuration loaded successfully")}catch(i){console.error("Alpine Device Store: Failed to load configuration:",i),this.error=i.message}finally{this.loaded=!0}},mergeDeviceConfig(e){if(console.log("\u{1F527} Merging device config from server:",e),e.device?(this.config.device.owner=e.device.owner||"",this.config.device.timezone=e.device.timezone||"",this.config.device.printerTxPin=e.device.printerTxPin,e.device.owner||console.warn("\u26A0\uFE0F Missing device.owner in config"),e.device.timezone||console.warn("\u26A0\uFE0F Missing device.timezone in config")):console.error("\u274C Missing device section in config"),e.buttons)for(let i=1;i<=4;i++){let t=`button${i}`;e.buttons[t]&&(this.config.buttons[t].gpio=e.buttons[t].gpio||null)}else console.warn("\u26A0\uFE0F Missing buttons section in config");e.leds?(this.config.leds.enabled=e.leds.enabled||!1,this.config.leds.pin=Number(e.leds.pin)):console.warn("\u26A0\uFE0F Missing leds section in config"),e.gpio?(this.gpio.availablePins=e.gpio.availablePins||[],this.gpio.safePins=e.gpio.safePins||[],this.gpio.pinDescriptions=e.gpio.pinDescriptions||{}):console.warn("\u26A0\uFE0F Missing gpio section in config"),console.log("\u2705 Device config merge complete:",this.config)},validateDeviceOwner(e){!e||e.trim()===""?this.validation.errors["device.owner"]="Device owner cannot be blank":this.validation.errors["device.owner"]&&delete this.validation.errors["device.owner"]},validateTimezone(e){!e||e.trim()===""?this.validation.errors["device.timezone"]="Timezone cannot be blank":this.validation.errors["device.timezone"]&&delete this.validation.errors["device.timezone"]},timezonePicker:U(),get filteredTimezones(){return F(this.timezonePicker.timezones,this.searchQuery)},async loadTimezones(){await m(this.timezonePicker)}},G()),{getTimezoneDisplayName(e){return L(e,this.timezonePicker.timezones)},getSelectedTimezoneDisplayName(e){let i=this.getSelectedTimezone(e);return i?i.displayName:""},getSelectedTimezoneOffset(e){let i=C(e,this.timezonePicker.timezones);return i?`(${i})`:""},getSelectedTimezone(e){return e?this.timezonePicker.timezones.find(i=>i.id===e):null},hasChanges(){var i,t,s,n,o,r;if(!this.originalConfig)return!1;let e=this.originalConfig;if(this.config.device.owner!==(((i=e.device)==null?void 0:i.owner)||"")||this.config.device.timezone!==(((t=e.device)==null?void 0:t.timezone)||"")||this.config.device.printerTxPin!==((s=e.device)==null?void 0:s.printerTxPin))return!0;for(let a of["button1","button2","button3","button4"]){let f=this.config.buttons[a].gpio,c=((o=(n=e.buttons)==null?void 0:n[a])==null?void 0:o.gpio)||null;if(f!==c)return!0}return!!(this.config.leds.enabled&&this.config.leds.pin!==(((r=e.leds)==null?void 0:r.pin)||null))},get canSave(){return this.loading||this.saving||this.error||!this.config.device.owner||this.config.device.owner.trim()===""||!this.config.device.timezone||this.config.device.timezone.trim()===""?!1:this.hasChanges()},async saveConfiguration(){this.saving=!0;try{let e={device:{owner:this.config.device.owner,timezone:this.config.device.timezone,printerTxPin:this.config.device.printerTxPin},buttons:{button1:this.config.buttons.button1,button2:this.config.buttons.button2,button3:this.config.buttons.button3,button4:this.config.buttons.button4}};this.config.leds.enabled&&(e.leds={pin:this.config.leds.pin}),console.log("Saving partial device configuration:",e);let i=await E(e);console.log("Alpine Device Store: Configuration saved successfully"),window.location.href="/settings/?saved=device"}catch(e){console.error("Alpine Device Store: Failed to save configuration:",e),this.showErrorMessage("Failed to save device settings: "+e.message),this.saving=!1}},cancelConfiguration(){window.location.href="/settings/"},getGpioAssignment(e){var t,s;if(e===-1||e===null)return null;let i=Number(e);if(this.config.device.printerTxPin===i)return"Assigned to printer";if(((t=this.config.leds)==null?void 0:t.pin)===i)return"Assigned to LED strip";for(let n=1;n<=4;n++)if(((s=this.config.buttons[`button${n}`])==null?void 0:s.gpio)===i)return`Assigned to button ${n}`;return null},getGpioOptionText(e){var t,s,n,o,r,a,f,c,d;if(e.pin===-1)return"Not connected";let i=`GPIO ${e.pin} - ${e.description}`;return e.isSafe||(i+=" (Unsafe)"),this.config.device.printerTxPin===e.pin?i+=" (Assigned to printer)":((t=this.config.leds)==null?void 0:t.pin)===e.pin?i+=" (Assigned to LED strip)":((n=(s=this.config.buttons)==null?void 0:s.button1)==null?void 0:n.gpio)===e.pin?i+=" (Assigned to button 1)":((r=(o=this.config.buttons)==null?void 0:o.button2)==null?void 0:r.gpio)===e.pin?i+=" (Assigned to button 2)":((f=(a=this.config.buttons)==null?void 0:a.button3)==null?void 0:f.gpio)===e.pin?i+=" (Assigned to button 3)":((d=(c=this.config.buttons)==null?void 0:c.button4)==null?void 0:d.gpio)===e.pin&&(i+=" (Assigned to button 4)"),i},get usedGpioPins(){var i,t,s;let e=new Set;this.config.device.printerTxPin!==null&&this.config.device.printerTxPin!==-1&&e.add(Number(this.config.device.printerTxPin)),((i=this.config.leds)==null?void 0:i.pin)!==null&&((t=this.config.leds)==null?void 0:t.pin)!==-1&&e.add(Number(this.config.leds.pin));for(let n=1;n<=4;n++){let o=(s=this.config.buttons[`button${n}`])==null?void 0:s.gpio;o!==null&&o!==-1&&e.add(Number(o))}return e},get printerGpioOptions(){return this.loading||this.gpio.availablePins.length===0?[{pin:null,description:"Loading GPIO options...",available:!1,isSafe:!1,inUse:!1}]:this.gpio.availablePins.filter(e=>Number(e)!==-1).map(e=>{var r,a,f,c,d,u,l,g,h;let i=Number(e),t=this.gpio.safePins.includes(e),s=this.gpio.pinDescriptions[e]||"Unknown",n=this.usedGpioPins.has(i),o=null;return this.config.device.printerTxPin===i?o="Assigned to printer":((r=this.config.leds)==null?void 0:r.pin)===i?o="Assigned to LED strip":((f=(a=this.config.buttons)==null?void 0:a.button1)==null?void 0:f.gpio)===i?o="Assigned to button 1":((d=(c=this.config.buttons)==null?void 0:c.button2)==null?void 0:d.gpio)===i?o="Assigned to button 2":((l=(u=this.config.buttons)==null?void 0:u.button3)==null?void 0:l.gpio)===i?o="Assigned to button 3":((h=(g=this.config.buttons)==null?void 0:g.button4)==null?void 0:h.gpio)===i&&(o="Assigned to button 4"),{pin:i,description:s,available:t&&!n,isSafe:t,inUse:n,assignment:o}})},get allGpioOptionsReactive(){var i,t,s,n,o,r,a,f,c;let e=this.config.device.printerTxPin+"-"+((i=this.config.leds)==null?void 0:i.pin)+"-"+((s=(t=this.config.buttons)==null?void 0:t.button1)==null?void 0:s.gpio)+"-"+((o=(n=this.config.buttons)==null?void 0:n.button2)==null?void 0:o.gpio)+"-"+((a=(r=this.config.buttons)==null?void 0:r.button3)==null?void 0:a.gpio)+"-"+((c=(f=this.config.buttons)==null?void 0:f.button4)==null?void 0:c.gpio);return this.gpio.availablePins.map((d,u)=>{var v,T,P,x,A,z,k,I,S;let l=Number(d),g=this.gpio.safePins.includes(d),h=this.gpio.pinDescriptions[d]||"Unknown",y=this.usedGpioPins.has(l),p;return l===-1?p="Not connected":(p=`GPIO ${l} - ${h}`,l===this.config.device.printerTxPin?p+=" (Printer)":l===((v=this.config.leds)==null?void 0:v.pin)?p+=" (LED)":l===((P=(T=this.config.buttons)==null?void 0:T.button1)==null?void 0:P.gpio)?p+=" (Button1)":l===((A=(x=this.config.buttons)==null?void 0:x.button2)==null?void 0:A.gpio)?p+=" (Button2)":l===((k=(z=this.config.buttons)==null?void 0:z.button3)==null?void 0:k.gpio)?p+=" (Button3)":l===((S=(I=this.config.buttons)==null?void 0:I.button4)==null?void 0:S.gpio)&&(p+=" (Button4)")),{pin:l,description:h,text:p,available:l===-1?!0:g&&!y,isSafe:g,inUse:y,key:`${l}-${e}-${u}`}})},get allGpioOptions(){return this.loading||this.gpio.availablePins.length===0?[{pin:null,description:"Loading GPIO options...",available:!1,isSafe:!1,inUse:!1}]:this.gpio.availablePins.map(e=>{var r,a,f,c,d,u,l,g,h;let i=Number(e),t=this.gpio.safePins.includes(e),s=this.gpio.pinDescriptions[e]||"Unknown",n=this.usedGpioPins.has(i),o=null;return i!==-1&&i!==null&&(this.config.device.printerTxPin===i?o="Assigned to printer":((r=this.config.leds)==null?void 0:r.pin)===i?o="Assigned to LED strip":((f=(a=this.config.buttons)==null?void 0:a.button1)==null?void 0:f.gpio)===i?o="Assigned to button 1":((d=(c=this.config.buttons)==null?void 0:c.button2)==null?void 0:d.gpio)===i?o="Assigned to button 2":((l=(u=this.config.buttons)==null?void 0:u.button3)==null?void 0:l.gpio)===i?o="Assigned to button 3":((h=(g=this.config.buttons)==null?void 0:g.button4)==null?void 0:h.gpio)===i&&(o="Assigned to button 4")),{pin:i,description:s,available:i===-1?!0:t&&!n,isSafe:t,inUse:n,assignment:o}})}})}document.addEventListener("alpine:init",()=>{let e=M();Alpine.store("settingsDevice",e),console.log("\u2705 Device Settings Store registered with ES6 modules")});})();
