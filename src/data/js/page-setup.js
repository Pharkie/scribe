(()=>{var A=Object.defineProperty,W=Object.defineProperties;var L=Object.getOwnPropertyDescriptors;var S=Object.getOwnPropertySymbols;var U=Object.prototype.hasOwnProperty,b=Object.prototype.propertyIsEnumerable;var k=(e,i,t)=>i in e?A(e,i,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[i]=t,h=(e,i)=>{for(var t in i||(i={}))U.call(i,t)&&k(e,t,i[t]);if(S)for(var t of S(i))b.call(i,t)&&k(e,t,i[t]);return e},m=(e,i)=>W(e,L(i));async function x(){let e=await fetch("/api/setup",{method:"GET",headers:{"Content-Type":"application/json"}});if(!e.ok){let t=await e.json().catch(()=>({}));throw new Error(t.message||`Failed to load setup configuration: ${e.status} - ${e.statusText}`)}return await e.json()}async function z(e){let i=await fetch("/api/setup",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!i.ok){let t=await i.json().catch(()=>({}));throw new Error(t.message||`Failed to save setup configuration: ${i.status} - ${i.statusText}`)}}async function v(){let e=new AbortController,i=setTimeout(()=>e.abort(),2e4),t=await fetch("/api/wifi-scan",{method:"GET",signal:e.signal});if(clearTimeout(i),!t.ok){let n=await t.json().catch(()=>({}));throw new Error(n.message||`WiFi scan failed: ${t.status} - ${t.statusText}`)}return(await t.json()).networks||[]}async function I(e,i){let t=new AbortController,s=setTimeout(()=>t.abort(),2e4),n=await fetch("/api/test-wifi",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ssid:e,password:i}),signal:t.signal});clearTimeout(s);let r=null;try{r=await n.json()}catch(o){}return n.ok?r||{success:!0}:{success:!1,message:(r==null?void 0:r.message)||`WiFi test failed: ${n.status}`}}function g(e){return e>-30?"Excellent":e>-50?"Very Good":e>-60?"Good":e>-70?"Fair":"Poor"}function j(e){let i={};return e.filter(t=>t.ssid&&t.ssid.trim()).forEach(t=>{let s=t.ssid.trim();(!i[s]||t.rssi>i[s].rssi)&&(i[s]=t)}),Object.values(i)}function q(e){return e.sort((i,t)=>t.rssi!==i.rssi?t.rssi-i.rssi:i.ssid.localeCompare(t.ssid))}function R(e){let i=j(e);return q(i).map((s,n)=>m(h({},s),{signal_strength:g(s.rssi),signal_display:`${g(s.rssi)} (${s.rssi} dBm)`,uniqueKey:`${s.ssid}-${s.rssi}-${n}`}))}function N(e=null){return{networks:[],currentSSID:e,selectedNetwork:e,manualSSID:"",mode:"scan",isScanning:!1,error:null,hasScanned:!1,passwordVisible:!1,get sortedNetworks(){return!this.networks||this.networks.length===0?[]:this.networks},formatSignalStrength:g}}async function P(e,i,t){e.isScanning=!0,e.error=null;try{let s=await t(),n=R(s);e.networks=n,e.hasScanned=!0,e.mode="scan",e.currentSSID&&n.find(o=>o.ssid===e.currentSSID)&&(e.selectedNetwork=e.currentSSID,console.log("\u{1F4E1} WiFi Utils: Auto-selected current network:",e.currentSSID)),console.log("\u{1F4E1} WiFi Utils: Scan found",n.length,"networks")}catch(s){console.error("\u{1F4E1} WiFi Utils: Scan failed:",s),e.error=s.message,i&&i(`WiFi scan failed: ${s.message}`)}finally{e.isScanning=!1}}function d(e){return e.mode==="manual"?e.manualSSID:e.selectedNetwork||""}var y=["Europe/London","America/New_York","America/Sao_Paulo","Australia/Sydney","Asia/Tokyo"];function _(e){return e.map(i=>{var t,s,n;try{let r=i.id?i.id.split("/"):["Unknown"],o=r[r.length-1].replace(/_/g," "),a=(t=i.location)==null?void 0:t.countryName,l=(n=(s=i.location)==null?void 0:s.comment)==null?void 0:n.trim(),c,u="";if(i.offsets&&Array.isArray(i.offsets)&&i.offsets.length>0){let f=w=>w.replace(/^\+/,"+").replace(/^-/,"-").replace(/^00/,"+00")+":00";if(i.offsets.length===1)u="UTC"+f(i.offsets[0]),c=a?`${o}, ${a}`:i.id||"Unknown",l&&(c+=` \u2014 ${l}`);else{let w=f(i.offsets[0]),T=f(i.offsets[1]);u=`UTC${w} / ${T} DST`,c=a?`${o}, ${a}`:i.id||"Unknown",l&&(c+=` \u2014 ${l}`)}}else{if(i.currentOffset){let f=i.currentOffset.match(/([+-]\d{2})/);u=f?"UTC"+f[1]+":00":i.currentOffset}c=a?`${o}, ${a}`:i.id||"Unknown"}return{id:i.id||"Unknown",displayName:c,countryName:a||"",comment:l||"",aliases:i.aliases||[],offset:u}}catch(r){return console.error("Error transforming timezone:",i,r),{id:i.id||"Unknown",displayName:i.id||"Unknown",countryName:"",comment:"",aliases:[],offset:""}}})}function C(){return{timezones:[],loading:!1,error:null,initialized:!1}}async function p(e){if(!e.initialized){e.loading=!0,e.error=null;try{let i=await fetch("/api/timezones");if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);let t=await i.json();if(!t.zones||!Array.isArray(t.zones))throw new Error("Invalid timezone data format");e.timezones=_(t.zones),e.initialized=!0,console.log(`Timezone Utils: Loaded ${e.timezones.length} timezones`)}catch(i){e.error=`Failed to load timezones: ${i.message}`,console.error("Timezone Utils: Loading failed:",i)}finally{e.loading=!1}}}function O(e,i){if(!e)return"";let t=i.find(s=>s.id===e);return t?`${t.displayName} (${t.offset})`:e}function $(e,i){if(!e)return"";let t=i.find(s=>s.id===e);return t?t.offset:""}function D(e,i=""){if(!Array.isArray(e)||e.length===0)return[];let t=(i||"").toLowerCase().trim();if(!t){let n=[],r=[];return e.forEach(o=>{y.includes(o.id)?n.push(o):r.push(o)}),n.sort((o,a)=>{let l=y.indexOf(o.id),c=y.indexOf(a.id);return l-c}),[...n,...r.slice(0,5-n.length)]}let s=[];return e.forEach(n=>{let r=null,o=n.id.split("/");o[o.length-1].replace(/_/g," ").toLowerCase().includes(t)?r=1:n.displayName.toLowerCase().includes(t)?r=2:n.id.toLowerCase().includes(t)?r=3:n.countryName&&n.countryName.toLowerCase().includes(t)?r=4:n.comment&&n.comment.toLowerCase().includes(t)&&(r=5),r!==null&&s.push({timezone:n,priority:r})}),s.sort((n,r)=>n.priority!==r.priority?n.priority-r.priority:n.timezone.displayName.localeCompare(r.timezone.displayName)).map(n=>n.timezone)}function F(){return{async loadTimezonesAndOpen(){!this.timezonePicker.initialized&&!this.timezonePicker.loading&&await p(this.timezonePicker),this.isOpen=!0},async openTimezonePicker(){!this.timezonePicker.initialized&&!this.timezonePicker.loading&&await p(this.timezonePicker),this.searchQuery="",this.isOpen=!0},resetTimezoneFocus(){this.focusedIndex=-1},handleGlobalKeydown(e,i){if(!(!this.isOpen||document.activeElement===i.searchInput)){if(e.key.length===1&&!e.ctrlKey&&!e.metaKey&&!e.altKey){i.searchInput.focus();return}e.key==="Backspace"&&(e.preventDefault(),i.searchInput.focus(),this.searchQuery.length>0&&(this.searchQuery=this.searchQuery.slice(0,-1),this.onSearchInputWithReset()))}},closeTimezonePicker(){this.isOpen=!1,this.focusedIndex=-1},navigateTimezoneUp(e,i){this.focusedIndex=this.focusedIndex>0?this.focusedIndex-1:-1,this.focusedIndex===-1?e.searchInput.focus():i(()=>{var s;(s=e.dropdown.querySelectorAll("[data-timezone-option]")[this.focusedIndex])==null||s.focus()})},navigateTimezoneDown(e,i){let t=Math.min(this.filteredTimezones.length-1,4);this.focusedIndex=this.focusedIndex<t?this.focusedIndex+1:0,i(()=>{var n;(n=e.dropdown.querySelectorAll("[data-timezone-option]")[this.focusedIndex])==null||n.focus()})},navigateToFirstTimezone(e,i){this.isOpen&&this.filteredTimezones.length>0&&(this.focusedIndex=0,i(()=>{var s;(s=e.dropdown.querySelectorAll("[data-timezone-option]")[0])==null||s.focus()}))},navigateToLastTimezone(e,i){this.isOpen&&this.filteredTimezones.length>0&&(this.focusedIndex=Math.min(this.filteredTimezones.length-1,4),i(()=>{var s;(s=e.dropdown.querySelectorAll("[data-timezone-option]")[this.focusedIndex])==null||s.focus()}))},onSearchInput(){!this.isOpen&&this.timezonePicker.initialized&&(this.isOpen=!0)},onSearchInputWithReset(){this.onSearchInput(),this.resetTimezoneFocus()},selectTimezone(e){var i,t,s;(i=this.config)!=null&&i.device&&(this.config.device.timezone=e.id),this.searchQuery=e.displayName,this.isOpen=!1,(s=(t=this.validation)==null?void 0:t.errors)!=null&&s["device.timezone"]&&delete this.validation.errors["device.timezone"],console.log("Selected timezone:",e.id)}}}function E(){return m(h({loaded:!1,error:null,saving:!1,scanning:!1,initialized:!1,config:{},wifiScan:N(),wifiTesting:!1,wifiTestResult:null,wifiTestPassed:!1,dirtySinceLastTest:!1,timezonePicker:C(),searchQuery:"",isOpen:!1,focusedIndex:-1,async init(){if(!this.initialized){this.initialized=!0;try{await this.loadConfiguration()}catch(e){console.error("Setup: Initialization error:",e)}finally{this.loaded=!0}}},async loadConfiguration(){var e,i,t,s,n,r;this.loaded=!1,this.error=null;try{let o=await x();this.config.device={owner:((e=o.device)==null?void 0:e.owner)||"",timezone:((i=o.device)==null?void 0:i.timezone)||"",wifi:{ssid:((s=(t=o.device)==null?void 0:t.wifi)==null?void 0:s.ssid)||"",password:((r=(n=o.device)==null?void 0:n.wifi)==null?void 0:r.password)||""}},this.wifiScan.currentSSID=this.config.device.wifi.ssid,this.wifiScan.selectedNetwork=this.config.device.wifi.ssid}catch(o){this.error=`Failed to load configuration: ${o.message}`}},async scanWiFi(){this.wifiTesting||(await P(this.wifiScan,e=>{window.showMessage(e,"error")},v),this.markDirtyOnCredentialChange())},get canSave(){return!this.loaded||!this.config.device||![this.config.device.owner,this.config.device.timezone,d(this.wifiScan),this.config.device.wifi.password].every(t=>t&&typeof t=="string"&&t.trim().length>0)?!1:this.wifiTestPassed&&!this.dirtySinceLastTest},getEffectiveSSID(){return d(this.wifiScan)},get availableNetworks(){return this.wifiScan.networks},get scanning(){return this.wifiScan.isScanning},get hasScanned(){return this.wifiScan.hasScanned},get manualSsid(){return this.wifiScan.manualSSID},set manualSsid(e){this.wifiScan.manualSSID=e,this.markDirtyOnCredentialChange()},async loadTimezones(){await p(this.timezonePicker)}},F()),{getTimezoneDisplayName(e){return O(e,this.timezonePicker.timezones)},getTimezoneOffset(e){return $(e,this.timezonePicker.timezones)},get filteredTimezones(){return D(this.timezonePicker.timezones,this.searchQuery)},async saveAndRestart(){if(!this.canSave){window.showMessage("Please fill in all required fields","error");return}this.saving=!0;try{if(!this.config.device)throw new Error("Configuration not loaded");let e={device:{owner:this.config.device.owner,timezone:this.config.device.timezone,wifi:{ssid:d(this.wifiScan),password:this.config.device.wifi.password}}};await z(e)}catch(e){console.error("Setup: Save failed:",e.message),window.showMessage("Failed to save configuration: "+e.message,"error"),this.saving=!1}},resetWifiTestState(){this.wifiTesting=!1,this.wifiTestResult=null,this.wifiTestPassed=!1,this.dirtySinceLastTest=!1},markDirtyOnCredentialChange(){this.dirtySinceLastTest=!0,this.wifiTestPassed=!1},async testWifiConnection(){if(this.wifiTesting)return;let e=d(this.wifiScan),i=this.config.device.wifi.password||"";if(!e||!i){window.showMessage("Please fill in SSID and password first","error");return}this.wifiTesting=!0,this.wifiTestResult=null;try{let t=await I(e,i);this.wifiTesting=!1,this.wifiTestResult=t,t.success?(this.wifiTestPassed=!0,this.dirtySinceLastTest=!1):(this.wifiTestPassed=!1,this.dirtySinceLastTest=!0)}catch(t){this.wifiTesting=!1,this.wifiTestPassed=!1,this.dirtySinceLastTest=!0,this.wifiTestResult={success:!1,message:t.message}}}})}document.addEventListener("alpine:init",()=>{let e=E();Alpine.store("setup",e),console.log("\u2705 Setup Store registered with ES6 modules")});})();
